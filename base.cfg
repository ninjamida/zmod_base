# (C) 2024-2026 ghzserg https://zmod.link/

[zmod]
[include ../mod_data/lang.cfg]

[gcode_macro _PREPARE_RESTORE]
gcode:

[gcode_macro _AFTER_RESTORE]
gcode:

[gcode_macro _GOTO_TRASH]
gcode:


[skew_correction]

[firmware_retraction]
retract_length: 0.7
retract_speed: 35
unretract_extra_length: 0
unretract_speed: 35

[include shell.cfg]

[gcode_macro CLEAR_NOZZLE]
description: ===Nozzle cleaning===
gcode:
    {% set extruder_temp = params.EXTRUDER_TEMP|default(230)|float %}
    {% set bed_temp = params.BED_TEMP|default(80)|float %}
    {% set ignore_temp = params.IGNORE_TEMP|default(0)|int %}
    {% set preclear = params.PRECLEAR|default(0)|int %}

    _ORIG_CLEAR_NOZZLE EXTRUDER_TEMP={extruder_temp} BED_TEMP={bed_temp} IGNORE_TEMP={ignore_temp} PRECLEAR={preclear}
    ZCONTROL_OFF

[include ff5.cfg]

[gcode_macro _TEST_MIN_MAX]
gcode:
    {% set client = printer['gcode_macro _CLIENT_VARIABLE'] | default({}) %}

    {% if "xyz" in printer.toolhead.homed_axes %}
        M400
        SAVE_GCODE_STATE NAME=test_min_max
        G90

        {% if printer.gcode_move.gcode_position.y < client.min_y %}
            G1 Y{client.min_y} F2000
            M400
        {% endif %}
        {% if printer.gcode_move.gcode_position.y > client.max_y %}
            G1 Y{client.max_y} F2000
            M400
        {% endif %}
        {% if printer.gcode_move.gcode_position.x < client.min_x %}
            G1 X{client.min_x} F2000
            M400
        {% endif %}
        {% if printer.gcode_move.gcode_position.x > client.max_x %}
            G1 X{client.max_x} F2000
            M400
        {% endif %}

        RESTORE_GCODE_STATE MOVE=0 NAME=test_min_max
    {% endif %}

[gcode_macro BED_MESH_CALIBRATE]
rename_existing: _BED_MESH_CALIBRATE
gcode:
    {% set zuse_kamp = printer.save_variables.variables['use_kamp']|default(0) | int %}
    SET_GCODE_VARIABLE MACRO=_TEST_POINT VARIABLE=temp_z_offset VALUE=0.0

    {% if zuse_kamp == 1 %}
        RESPOND PREFIX="info" MSG="===Using KAMP==="
        M400
        _KAMP_BED_MESH_CALIBRATE
        M400
    {% else %}
        RESPOND PREFIX="info" MSG="===Using BED_MESH_CALIBRATE==="
        _TEST_MIN_MAX
        M400
        _BED_MESH_CALIBRATE {rawparams}
        M400
    {% endif %}

[gcode_macro _G28]
gcode:
    {% if "xyz" not in printer.toolhead.homed_axes %}
        _HOME
    {% endif %}


[gcode_macro CHECK_MD5]
description: ===File MD5 sum check===
gcode:
  {% if 'FILENAME' in params %}
    {% set filename = params.FILENAME|default("")|string %}
  {% else %}
    {% set filename = printer.virtual_sdcard.file_path|default("")|string  %}
  {% endif %}

  SAVE_VARIABLE VARIABLE=check_md5 VALUE={0|int}

  {% if filename != "" %}

    {% if 'DELETE' in params %}
      {% set delete = params.DELETE|default("False")|string %}
    {% endif %}

    RUN_SHELL_COMMAND CMD=check_md5 PARAMS={'"%s %s"' % (filename.replace("'", "\\\'").replace(" ", "\ "), delete)}
    {% for i in range(30) %}
        ZLOAD_VARIABLE
        _CHECK_MD5
    {% endfor %}

    ZLOAD_VARIABLE
    _FINAL_CHECK_MD5 FILENAME="{filename}"

  {% endif %}

[gcode_macro _CHECK_START_PRINT]
gcode:
    {% set filename = params.FILENAME|default("")|string %}

    RUN_SHELL_COMMAND CMD=check_start_print PARAMS={'"%s %s"' % (filename.replace("'", "\\\'").replace(" ", "\ "), delete)}

[gcode_macro _CHECK_MD5]
description: ===Waiting for check to complete===
gcode:
    {% set check_md5 = printer.save_variables.variables['check_md5']|default(0) | int %}

    {% if (check_md5 == 0) %}
        G4 P{1000}
    {% endif %}

[gcode_macro _FINAL_CHECK_MD5]
description: ===Final test===
gcode:
    {% set client = printer['gcode_macro _CLIENT_VARIABLE'] | default({}) %}
    {% set filename = params.FILENAME|default("")|string %}
    {% set check_md5 = printer.save_variables.variables['check_md5']|default(0) | int %}

    {% if (check_md5 == 0) %}
        RESPOND TYPE=error MSG="===Error: File '{filename}' was not verified in time. Print canceled.==="
        CANCEL_PRINT
        _FINAL_STOP_MD5
    {% endif %}
    {% if (check_md5 == 1) %}
        RESPOND TYPE=error MSG="===Error: File '{filename}' not specified. Print canceled.==="
        CANCEL_PRINT
        _FINAL_STOP_MD5
    {% endif %}
    {% if (check_md5 == 2) %}
        RESPOND TYPE="error" MSG="===Error: File {filename} not found. Print canceled.==="
        CANCEL_PRINT
        _FINAL_STOP_MD5
    {% endif %}
    {% if (check_md5 == 3) %}
        RESPOND TYPE="error" MSG="===File {filename} has no MD5 checksum. Enable it in Orca. https://wiki.zmod.link/Recomendations/==="
    {% endif %}
    {% if (check_md5 == 4) %}
        {% if not client.ad5x %}
            RESPOND TYPE="error" MSG="===File {filename} contains arc commands (G2, G3). Disable them. In Orca: Process Profile -> Arc Approximation -> Uncheck=== ===Replace Spiral/Auto Z-Hop. In Orca: Printer Profile -> Extruder 1 -> Z Hop Type -> Set to Normal or Sloped==="
        {% endif %}
        RESPOND PREFIX="info" MSG="===File {filename} verified successfully. MD5 checksum matches.==="
    {% endif %}
    {% if (check_md5 == 8) %}
        {% if not client.ad5x %}
            RESPOND TYPE="error" MSG="===File {filename} uses unsupported G17/G18/G19 commands. Replace Z-Hop type.=== ===In Orca: Printer Profile -> Extruder 1 -> Z Hop Type -> Set to Normal or Sloped==="
        {% endif %}
        RESPOND PREFIX="info" MSG="===File {filename} verified successfully. MD5 checksum matches.==="
    {% endif %}
    {% if (check_md5 == 5) %}
        RESPOND PREFIX="info" MSG="===File {filename} verified successfully. MD5 checksum matches.==="
    {% endif %}
    {% if (check_md5 == 6) %}
        RESPOND TYPE="error" MSG="===File {filename} MD5 mismatch. File deleted. Print canceled==="
        CANCEL_PRINT
        _FINAL_STOP_MD5
    {% endif %}
    {% if (check_md5 == 7) %}
        RESPOND TYPE="error" MSG="===File {filename} MD5 mismatch. Print canceled==="
        CANCEL_PRINT
        _FINAL_STOP_MD5
    {% endif %}

[gcode_macro _FINAL_STOP_MD5]
gcode:
    {action_raise_error("===MD5 check failed. Print canceled.===")}

[gcode_macro BED_LEVEL_SCREWS_TUNE]
description: ===Bed screw calibration===
gcode:
    {% set client = printer['gcode_macro _CLIENT_VARIABLE'] | default({}) %}
    {% set extruder_temp = params.EXTRUDER_TEMP|default(130)|float %}
    {% set bed_temp = params.BED_TEMP|default(80)|float %}

    RESPOND PREFIX="info" MSG="===Before measurements, don't forget to clean the nozzle with CLEAR_NOZZLE macro==="

    BED_MESH_CLEAR
    SET_HEATER_TEMPERATURE HEATER=extruder TARGET={extruder_temp}
    SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={bed_temp}
    TEMPERATURE_WAIT SENSOR=heater_bed  MINIMUM={bed_temp-2} MAXIMUM={bed_temp+3}
    TEMPERATURE_WAIT SENSOR=extruder  MINIMUM={extruder_temp-2} MAXIMUM={extruder_temp+3}

    _HOME
    _GOTO_MID

    LOAD_CELL_TARE

    SCREWS_TILT_CALCULATE

    {% if client.ad5x %}
        G1 X110 Y110 F3000
    {% else %}
        G1 X0 Y0 F3000
    {% endif %}

[gcode_macro _GOTO_MESH]
gcode:
    #G1 Z100 F600
    #M400
    _GOTO_MID

[gcode_macro _FIX_BED_MESH_CALIBRATE]
gcode:
    {% set profile = params.PROFILE|default("default") %}

    RESPOND PREFIX="info" MSG="===Before measurements, don't forget to clean the nozzle with CLEAR_NOZZLE macro==="

    _G28
    _GOTO_MID

    LOAD_CELL_TARE
    _BED_MESH_CALIBRATE PROFILE="{profile}"

    _GOTO_MESH

[gcode_macro _FULL_BED_LEVEL]
description: ===Bed calibration without temperature off===
gcode:
    {% set extruder_temp = params.EXTRUDER_TEMP|default(240)|float %}
    {% set bed_temp = params.BED_TEMP|default(80)|float %}
    {% set profile = params.PROFILE|default("auto") %}

    RESPOND PREFIX="info" MSG="===Bed calibration. Profile {profile}. Extruder temp: {extruder_temp} / Bed temp: {bed_temp}==="

    BED_MESH_CLEAR          ; Очистка профиля стола
    M400

    _ORIG_CLEAR_NOZZLE EXTRUDER_TEMP={extruder_temp} BED_TEMP={bed_temp}

    # Начинаем калибровку
    _BED_MESH_CALIBRATE PROFILE="{profile}"

    _UGOL_PARK

[gcode_macro AUTO_FULL_BED_LEVEL]
description: ===Bed calibration with temperature off===
gcode:
    {% set extruder_temp = params.EXTRUDER_TEMP|default(240)|float %}
    {% set bed_temp = params.BED_TEMP|default(80)|float %}
    {% set profile = params.PROFILE|default("auto") %}

    _FULL_BED_LEVEL EXTRUDER_TEMP={extruder_temp} BED_TEMP={bed_temp} PROFILE={profile}

    # Выклчюаем обогрев
    _STOP

[include ./KAMP/KAMP_Settings.cfg]

[gcode_macro _WAIT_TEMP]
# Убираем стабилизацию температуры, для тех у кого не настроен PID экструдера и/или PID стола
gcode:
    {% set client = printer['gcode_macro _CLIENT_VARIABLE'] | default({}) %}

    {% set extruder_temp = params.EXTRUDER_TEMP|default(240)|float %}
    {% set bed_temp = params.BED_TEMP|default(80)|float %}
    {% set name = params.NAME|default("") %}

    RESPOND PREFIX="//" MSG="===Waiting for temperature normalization. Bed: {bed_temp-3}-{bed_temp+4}. Extruder: {extruder_temp-2}-{extruder_temp+4}=== {name}"
    RESPOND PREFIX="//" MSG="===If it takes a long time, calibrate the PID of the extruder and bed=== {name}"

    {% if bed_temp | int != 0 %}
        M140 S{bed_temp}
    {% endif %}
    # Включаем для AD5X одновременный нагрев сопла и стола
    {% if client.ad5x %}
        {% if bed_temp | int != 0 %}
            TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM={bed_temp-20} MAXIMUM={bed_temp+4}
        {% endif %}
        {% if extruder_temp | int != 0 %}
            M104 S{extruder_temp}
        {% endif %}
    {% endif %}
    {% if bed_temp | int != 0 %}
        TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM={bed_temp-3} MAXIMUM={bed_temp+4}
    {% endif %}
    {% if extruder_temp | int != 0 %}
        M104 S{extruder_temp}
        TEMPERATURE_WAIT SENSOR=extruder MINIMUM={extruder_temp-2} MAXIMUM={extruder_temp+4}
    {% endif %}
    RESPOND PREFIX="//" MSG="===Temperature normalization completed=== {name}"

[gcode_macro KAMP]
description: ===Adaptive bed===
gcode:
    {% set extruder_temp = params.EXTRUDER_TEMP|default(240)|float %}
    {% set bed_temp = params.BED_TEMP|default(80)|float %}
    {% set client = printer['gcode_macro _CLIENT_VARIABLE'] | default({}) %}

    BED_MESH_CLEAR          ; Очистка профиля стола
    M400

    _ORIG_CLEAR_NOZZLE EXTRUDER_TEMP={extruder_temp} BED_TEMP={bed_temp}

    M400
    _KAMP_BED_MESH_CALIBRATE
    M400

    _SMART_PARK
    M400

    _WAIT_TEMP EXTRUDER_TEMP={extruder_temp} BED_TEMP={bed_temp} NAME=KAMP

# Калибровка PID стола
[gcode_macro PID_TUNE_BED]
description: ===Bed PID calibration===
gcode:
    {% set temperature = params.TEMPERATURE|default(80) %}

    _HOME
    _GOTO_MID

    M107

    PID_CALIBRATE HEATER=heater_bed TARGET={temperature}

    _SAVE_CONFIG

# Калибровка PID экструдера
[gcode_macro PID_TUNE_EXTRUDER]
description: ===Extruder PID calibration===
gcode:
    {% set temperature = params.TEMPERATURE|default(245) | int %}
    {% set cooler = params.COOLER|default(100) | int %}
    {% set client = printer['gcode_macro _CLIENT_VARIABLE'] | default({}) %}

    _HOME
    _GOTO_MID

    G1 X{client.min_x+(client.max_x-client.min_x)/2} Y{client.min_y+(client.max_y-client.min_y)/2} F3000

    M106 P0 S{2.55*cooler| float}
    PID_CALIBRATE HEATER=extruder TARGET={temperature}

    _SAVE_CONFIG

[gcode_macro LOAD_FILAMENT]
variable_load_distance:  125
gcode:
    {% set max_velocity = printer.configfile.settings['extruder'].max_extrude_only_velocity  * 60 %}

    {% set m600_temp = printer["gcode_macro M600"].zextruder_temp|float %}

    {% set extruder_temp = params.EXTRUDER_TEMP|default(m600_temp) | float %}
    {% set extrude_len   = params.EXTRUDE_LEN|default(load_distance) |float %}
    {% set speed = params.SPEED|default(450)|float %}

    RESPOND PREFIX="info" MSG="===Loading filament at {extruder_temp} for {extrude_len}mm at {speed/60} mm/s==="
    M104 S{extruder_temp}
    TEMPERATURE_WAIT SENSOR=extruder MINIMUM={extruder_temp-1}

    M400
    SAVE_GCODE_STATE NAME=load_state
    G91
    G92 E0

    _DISABLE_SENSOR
        G1 E{extrude_len} F{speed} ; extrude with 7.5mm/s
        M400
    _ENABLE_SENSOR

    RESTORE_GCODE_STATE MOVE=0 NAME=load_state

[gcode_macro UNLOAD_FILAMENT]
variable_unload_distance:  75
gcode:
    {% set speed = params.SPEED|default(450)|int %}

    {% set extruder_temp = printer["gcode_macro M600"].zextruder_temp|float %}
    M104 S{extruder_temp}
    TEMPERATURE_WAIT SENSOR=extruder MINIMUM={extruder_temp}

    M400
    SAVE_GCODE_STATE NAME=unload_state
    G91
    G92 E0

    _DISABLE_SENSOR
        G1 E-{unload_distance} F{speed} ; unload
        M400
    _ENABLE_SENSOR

    RESTORE_GCODE_STATE MOVE=0 NAME=unload_state

[gcode_macro PURGE_FILAMENT]
variable_purge_distance:  25
gcode:
    {% set speed = params.SPEED|default(450)|int %}

    {% set extruder_temp = printer["gcode_macro M600"].zextruder_temp|float %}
    M104 S{extruder_temp}
    TEMPERATURE_WAIT SENSOR=extruder MINIMUM={extruder_temp}

    M400
    SAVE_GCODE_STATE NAME=purge_state
    G91
    G92 E0

    _DISABLE_SENSOR
        G1 E{purge_distance} F{speed}   ; purge
        M400
    _ENABLE_SENSOR

    RESTORE_GCODE_STATE MOVE=0 NAME=purge_state

[gcode_macro LOAD_MATERIAL]
description: ===Manual filament loading / change===
variable_initial_target_temp: 0
gcode:
    # save gcode state
    M400
    SAVE_GCODE_STATE NAME=load_material_state
    # save heating state
    SET_GCODE_VARIABLE MACRO=LOAD_MATERIAL VARIABLE=initial_target_temp VALUE={printer["extruder"].target}

    _LOAD_MATERIAL_SELECT

[gcode_macro _LOAD_MATERIAL_SELECT]
gcode:
    {% if not printer["extruder"].target >= printer.configfile.settings['extruder'].min_extrude_temp %}
        RESPOND TYPE=command MSG="action:prompt_begin ===Material selection==="
        RESPOND TYPE=command MSG="action:prompt_text ===Select material to load==="
        RESPOND TYPE=command MSG="action:prompt_button_group_start"
        RESPOND TYPE=command MSG="action:prompt_button PLA|_LOAD_MATERIAL_HEATUP TEMP=210|primary"
        RESPOND TYPE=command MSG="action:prompt_button PETG|_LOAD_MATERIAL_HEATUP TEMP=240|primary"
        RESPOND TYPE=command MSG="action:prompt_button ABS|_LOAD_MATERIAL_HEATUP TEMP=250|primary"
        RESPOND TYPE=command MSG="action:prompt_button_group_end"
        RESPOND TYPE=command MSG="action:prompt_footer_button ===Cancel===|_LOAD_MATERIAL_END"
        RESPOND TYPE=command MSG="action:prompt_show"
    {% else %}
        TEMPERATURE_WAIT SENSOR=extruder MINIMUM={printer["extruder"].target}
        _LOAD_MATERIAL_ACTION
    {% endif %}

[gcode_macro _LOAD_MATERIAL_HEATUP]
gcode:
    {% set extruder_temp = params.TEMP|default(200)|float %}
    M104 S{extruder_temp}
    RESPOND TYPE=command MSG=action:prompt_end
    TEMPERATURE_WAIT SENSOR=extruder MINIMUM={extruder_temp}
    _LOAD_MATERIAL_ACTION

[gcode_macro _LOAD_MATERIAL_ACTION]
gcode:
    RESPOND TYPE=command MSG="action:prompt_begin ===Filament management==="
    RESPOND TYPE=command MSG="action:prompt_text ===Select action==="
    RESPOND TYPE=command MSG="action:prompt_button_group_start"
    RESPOND TYPE=command MSG="action:prompt_button ===Load===|LOAD_FILAMENT|primary"
    RESPOND TYPE=command MSG="action:prompt_button ===Unload===|UNLOAD_FILAMENT|primary"
    RESPOND TYPE=command MSG="action:prompt_button ===Purge===|PURGE_FILAMENT|primary"
    RESPOND TYPE=command MSG="action:prompt_button_group_end"
    RESPOND TYPE=command MSG="action:prompt_footer_button ===OK===|_LOAD_MATERIAL_END"
    RESPOND TYPE=command MSG="action:prompt_show"

[gcode_macro _LOAD_MATERIAL_END]
gcode:
    RESPOND TYPE=command MSG="action:prompt_end"
    # restore old temp
    M104 S{printer["gcode_macro LOAD_MATERIAL"].initial_target_temp}
    # restore gcode state
    RESTORE_GCODE_STATE MOVE=0 NAME=load_material_state

[gcode_macro M600]
description: ===Pause and filament change===
variable_zextruder_temp: 240.0
gcode:
    {% set extruder_temp = printer[printer.toolhead.extruder].target if printer.toolhead.extruder != '' else 240.0 %}
    SET_GCODE_VARIABLE MACRO=M600 VARIABLE=zextruder_temp VALUE={extruder_temp|float}

    RESPOND PREFIX="info" MSG="===Nozzle temperature {extruder_temp}==="

    PAUSE

    RESPOND TYPE=command MSG="action:prompt_begin ===Filament Change==="
    RESPOND TYPE=command MSG="action:prompt_text ===Filament change requested. Load new filament and click 'Resume'.==="
    RESPOND TYPE=command MSG="action:prompt_button_group_start"
    RESPOND TYPE=command MSG="action:prompt_button ===Load===|LOAD_FILAMENT|primary"
    RESPOND TYPE=command MSG="action:prompt_button ===Unload===|UNLOAD_FILAMENT|primary"
    RESPOND TYPE=command MSG="action:prompt_button ===Purge===|PURGE_FILAMENT|primary"
    RESPOND TYPE=command MSG="action:prompt_button_group_end"
    RESPOND TYPE=command MSG="action:prompt_footer_button ===Resume===|_INTERACTIVE_LOAD_END"
    RESPOND TYPE=command MSG="action:prompt_show"

[gcode_macro _INTERACTIVE_LOAD_END]
gcode:
    RESPOND TYPE=command MSG="action:prompt_end"
    RESUME

[gcode_macro _SHUTDOWN]
variable_trigger_allowed: False
gcode:
    {% set client = printer['gcode_macro _CLIENT_VARIABLE'] | default({}) %}

    {% if trigger_allowed %}
        {% if not client.ad5x %}
            SET_PIN PIN=clear_power_off VALUE=1
            G4 P500
            SET_PIN PIN=clear_power_off VALUE=0
        {% endif %}
        RESPOND TYPE=command MSG="action:prompt_begin ===Shutdown printer?==="
        RESPOND TYPE=command MSG="action:prompt_text ===Shutdown printer?==="
        RESPOND TYPE=command MSG="action:prompt_button_group_start"
        RESPOND TYPE=command MSG="action:prompt_button ===Yes===|SHUTDOWN|primary"
        RESPOND TYPE=command MSG="action:prompt_button_group_end"
        RESPOND TYPE=command MSG="action:prompt_footer_button ===Cancel===|RESPOND TYPE=command MSG=action:prompt_end"
        RESPOND TYPE=command MSG="action:prompt_show"
    {% endif %}

[gcode_macro SHUTDOWN]
description: ===Power off printer===
gcode:
    {% set client = printer['gcode_macro _CLIENT_VARIABLE'] | default({}) %}

    RESPOND TYPE=command MSG="action:prompt_end"
    BED_MESH_CLEAR
    M400
    {% if not client.ad5x %}
        # Reset button state, otherwise only one trigger can occur
        SET_PIN PIN=clear_power_off VALUE=1
        # There is a deboucing circuit which needs some delay
        G4 P500
        # Disable pin again otherwise on reset the button will be triggered 1-3 times
        SET_PIN PIN=clear_power_off VALUE=0
    {% endif %}
    RUN_SHELL_COMMAND CMD=run_power_off
    RUN_SHELL_COMMAND CMD=sync
    G4 P1000
    RUN_SHELL_COMMAND CMD=sync
    G4 P1000
    {% if not client.ad5x %}
        SET_PIN PIN=power_off VALUE=0
    {% endif %}
    G4 P1000
    RUN_SHELL_COMMAND CMD=poweroff

[gcode_macro _REBOOT]
gcode:
    RESPOND TYPE=command MSG="action:prompt_begin ===There will be a SCHEDULED reboot now==="
    RESPOND TYPE=command MSG="action:prompt_text ===There will be a SCHEDULED reboot now==="
    RESPOND TYPE=command MSG="action:prompt_footer_button OK|RESPOND TYPE=command MSG=action:prompt_end|info"
    RESPOND TYPE=command MSG="action:prompt_show"
    G4 P3000

[gcode_macro REBOOT]
description: ===Reboot printer===
gcode:
    {% set client = printer['gcode_macro _CLIENT_VARIABLE'] | default({}) %}

    BED_MESH_CLEAR
    M400
    RUN_SHELL_COMMAND CMD=sync
    G4 P1000
    _REBOOT
    RUN_SHELL_COMMAND CMD=sync
    {% if not client.ad5x %}
        # Reset button state, otherwise only one trigger can occur
        SET_PIN PIN=clear_power_off VALUE=1
        # There is a deboucing circuit which needs some delay
        G4 P500
        # Disable pin again otherwise on reset the button will be triggered 1-3 times
        SET_PIN PIN=clear_power_off VALUE=0
    {% endif %}
    RUN_SHELL_COMMAND CMD=sync
    G4 P1000
    RUN_SHELL_COMMAND CMD=reboot

[gcode_macro REMOVE_ZMOD]
description: ===Remove zmod===
gcode:
    {% set full = params.FULL|default(0)|int %}
    CLEAR_EMMC

    {% if full == 1 %}
        RUN_SHELL_COMMAND CMD=ztouch PARAMS="/opt/config/mod/FULL_REMOVE"
    {% else %}
        RUN_SHELL_COMMAND CMD=ztouch PARAMS="/opt/config/mod/REMOVE"
    {% endif %}

    RUN_SHELL_COMMAND CMD=sync
    _REBOOT
    RUN_SHELL_COMMAND CMD=reboot

[gcode_macro SKIP_ZMOD]
description: ===Reboot to original system (no zmod)===
gcode:
    {% set mute = params.MUTE|default(0)|int %}

    {% if mute == 0 %}
        RESPOND TYPE=command MSG="action:prompt_begin ===Temporary ZMOD disable==="
        RESPOND TYPE=command MSG="action:prompt_text ===After clicking OK the printer will be powered off==="
        RESPOND TYPE=command MSG="action:prompt_text ===You need to disconnect power cord and then reconnect it==="
        RESPOND TYPE=command MSG="action:prompt_text ===Printer will boot into stock firmware==="
        RESPOND TYPE=command MSG="action:prompt_footer_button ===OK===|SKIP_ZMOD MUTE=1"
        RESPOND TYPE=command MSG="action:prompt_show"
    {% else %}
        RESPOND TYPE=command MSG="action:prompt_end"
        RUN_SHELL_COMMAND CMD=ztouch PARAMS="/opt/config/mod/SKIP_ZMOD"
        RUN_SHELL_COMMAND CMD=sync
        RUN_SHELL_COMMAND CMD=poweroff
    {% endif %}

[gcode_macro LED_ON]
description: ===Enable backlight===
gcode:
    SET_LED LED=chamber_led WHITE=1

[gcode_macro LED_OFF]
description: ===Disable backlight===
gcode:
    SET_LED LED=chamber_led WHITE=0

[gcode_macro LED]
description: ===Enable backlight===
gcode:
    {% set S = params.S|default(50)|int %}
    SET_LED LED=chamber_led WHITE={S/100|float}

[gcode_macro DISPLAY_ON]
description: ===Enable stock screen and reboot===
gcode:
    SAVE_VARIABLE VARIABLE=display_off VALUE=0
    RUN_SHELL_COMMAND CMD=zdisplay PARAMS="on"

[gcode_macro DISPLAY_OFF]
description: ===Disable stock screen===
gcode:
    {% set guppy = params.GUPPY|default(1)|int %}
    {% set load_zoffset = printer.save_variables.variables['load_zoffset']|default(1) | int %}

    SAVE_VARIABLE VARIABLE=display_off VALUE=1
    RESPOND TYPE=command MSG="action:prompt_begin Warning"
    RESPOND TYPE=command MSG="action:prompt_text ===Do not disable display if you don't fully understand bed leveling, Z-Offset and START_PRINT/END_PRINT macros==="
    RESPOND TYPE=command MSG="action:prompt_text ===Use LOAD_ZOFFSET_NATIVE to copy the Z-Offset from the native screen.==="
    RESPOND TYPE=command MSG="action:prompt_text ===Turn on NOZZLE_CONTROL to control the nozzle impact on the table==="
    RESPOND TYPE=command MSG="action:prompt_text ===https://wiki.zmod.link/FAQ/==="

    {% if guppy == 1 %}
        RESPOND PREFIX="info" MSG="===Loading GuppyScreen==="
        {% if load_zoffset == 0 %}
            RESPOND PREFIX="info" MSG="===Use Z-Offset loading from global parameters to control Z-Offset with GuppyScreen==="
            RESPOND PREFIX="info" MSG="SAVE_ZMOD_DATA LOAD_ZOFFSET=1"
        {% endif %}
        RESPOND TYPE=command MSG="action:prompt_footer_button Ok|RESPOND TYPE=command MSG=action:prompt_end|info"
        RESPOND TYPE=command MSG="action:prompt_show"

        G4 P5000
        RUN_SHELL_COMMAND CMD=zdisplay PARAMS="guppy"
        SAVE_VARIABLE VARIABLE=guppy VALUE={1|int}
    {% else %}
        RESPOND TYPE=command MSG="action:prompt_footer_button Ok|RESPOND TYPE=command MSG=action:prompt_end|info"
        RESPOND TYPE=command MSG="action:prompt_show"

        G4 P5000
        RUN_SHELL_COMMAND CMD=zdisplay PARAMS="off"
        SAVE_VARIABLE VARIABLE=guppy VALUE={0|int}
    {% endif %}
    RESTART

[gcode_macro MEM]
description: ===Check memory usage===
gcode:
    RUN_SHELL_COMMAND CMD=zmem

[gcode_macro PLAY_MIDI]
description: ===Play MIDI file===
variable_mute: 0
gcode:
    {% if mute == 0 %}
        {% set FILE = params.FILE|default("For_Elise.mid")|string %}
        RUN_SHELL_COMMAND CMD=audio_midi PARAMS="{FILE}"
    {% endif %}

[gcode_macro MUTE]
description: ===Mute sound===
gcode:
    {% set mute = params.MUTE|default(1)|int %}
    SET_GCODE_VARIABLE MACRO=PLAY_MIDI VARIABLE=mute VALUE={mute}

[gcode_macro CAMERA_ON]
description: ===Use alternative camera===
gcode:
    {% set client = printer['gcode_macro _CLIENT_VARIABLE'] | default({}) %}
    {% if not client.ad5x %}
        {% set WIDTH  = params.WIDTH|default(640)|int %}
        {% set HEIGHT = params.HEIGHT|default(480)|int %}
    {% else %}
        {% set WIDTH  = params.WIDTH|default(1280)|int %}
        {% set HEIGHT = params.HEIGHT|default(720)|int %}
    {% endif %}
    {% set FPS    = params.FPS|default(20)|int %}
    {% set VIDEO  = params.VIDEO|default(client.video)|string %}
    {% set FS     = params.FS|default(0)|int %}
    {% set STREAMER = params.STREAMER|default("auto")|string %}
    {% set FORMAT = params.FORMAT|default("MJPEG")|string %}

    RESPOND PREFIX="info" MSG="===Don't forget to turn off the camera on your printer's native screen.==="

    RUN_SHELL_COMMAND CMD=zcamera PARAMS="on {WIDTH} {HEIGHT} {FPS} {VIDEO} {FS} {STREAMER} {FORMAT} RESTART"
    RUN_SHELL_COMMAND CMD=cat PARAMS="/opt/config/mod_data/log/cam/cam.log"

[gcode_macro CAMERA_OFF]
description: ===Disable alternative camera===
gcode:
    RESPOND PREFIX="info" MSG="===Enable camera on printer screen==="

    RUN_SHELL_COMMAND CMD=zcamera PARAMS="off"

[gcode_macro CAMERA_RESTART]
description: ===Restart alternative camera===
gcode:
    RUN_SHELL_COMMAND CMD="s99camera" PARAMS="restart"

[gcode_macro DATE_GET]
description: ===Check time===
gcode:
    RUN_SHELL_COMMAND CMD=date

[gcode_macro DATE_SET]
description: ===Set date and time (format: 2024.01.01-00:00:00)===
gcode:
    {% set dt = params.DT|default("2024.01.01-00:00:00")|string %}
    RUN_SHELL_COMMAND CMD=zremote PARAMS="/bin/date {dt}"

[gcode_macro WEB]
description: ===Switch web interface (fluidd/mainsail)===
gcode:
    {% set mute = params.MUTE|default(0)|int %}

    {% if mute == 0 %}
        RESPOND TYPE=command MSG="action:prompt_begin ===After macro execution press Ctrl + F5==="
        RESPOND TYPE=command MSG="action:prompt_text ===After macro execution press Ctrl + F5==="
        RESPOND TYPE=command MSG="action:prompt_footer_button OK|WEB MUTE=1"
        RESPOND TYPE=command MSG="action:prompt_show"
    {% else %}
        RESPOND TYPE=command MSG="action:prompt_end"
        RUN_SHELL_COMMAND CMD=zhttp
    {% endif %}

[gcode_macro _STOP_FAN]
gcode:
    M106 S0                 ; Отключить кулер
    M107                    ; Отключить кулер экструдера
    SET_FAN_SPEED FAN=chamber_fan SPEED=0

[gcode_macro _STOP]
description: ===Disable heating and cooler===
gcode:
    {% set client = printer['gcode_macro _CLIENT_VARIABLE'] | default({}) %}
    {% set screen = printer["gcode_macro _SCREEN"].screen %}

    M400
    M220 S100               ; Скорость 100%
    M221 S100               ; Экструзия 100%
    M140 S0                 ; Отключить нагрев стола
    M104 S0                 ; Отключить нагрев экструдера
    SET_SKEW CLEAR=1        ; reset skew profile if loaded

    {% set zmidi_end = printer.save_variables.variables['midi_end']|default("") | string %}
    {% if zmidi_end != "" %}
        PLAY_MIDI FILE={zmidi_end}
    {% endif %}
    EXCLUDE_OBJECT_DEFINE RESET=1
    SAVE_VARIABLE VARIABLE=check_md5 VALUE={0|int}

    RUN_SHELL_COMMAND CMD=znice

    {% if printer.bed_mesh.profile_name == "default" %}
        BED_MESH_CLEAR
        BED_MESH_PROFILE REMOVE=default
    {% endif %}

    ZCONTROL_OFF

    {% if client.ad5x %}
        {% if screen == False %}
            IFS_F18
            _MODIFY_END_CHANGE_FILAMENT_DATA RESET=1
        {% endif %}
        SDCARD_ENABLE_FFM ENABLE=0
    {% endif %}

    _STOP_FAN
    _RESET_SPEED

    UPDATE_DELAYED_GCODE ID=_ZUPDATE DURATION=20

    RESPOND PREFIX="info" MSG="===Work completed==="

[gcode_macro CHECK_SYSTEM]
description: ===OS check===
gcode:
    {% set restore = params.RESTORE|default(0)|int %}

    {% set client = printer['gcode_macro _CLIENT_VARIABLE'] | default({}) %}
    {% set zklipper13 = printer.save_variables.variables['klipper13']|default(0) | int %}

    {% if client.ad5x %}
        {% if restore == 1 %}
            RUN_SHELL_COMMAND CMD=zcheckmd5 PARAMS="restore 0"
        {% else %}
            RUN_SHELL_COMMAND CMD=zcheckmd5 PARAMS="not_restore 0"
        {% endif %}
    {% else %}
        {% if restore == 1 %}
            RUN_SHELL_COMMAND CMD=zcheckmd5 PARAMS="restore {zklipper13}"
        {% else %}
            RUN_SHELL_COMMAND CMD=zcheckmd5 PARAMS="not_restore {zklipper13}"
        {% endif %}
    {% endif %}

[gcode_macro SET_TIMEZONE]
description: ===Timezone change===
gcode:
    {% set client = printer['gcode_macro _CLIENT_VARIABLE'] | default({}) %}

    {% set ZONE  = params.ZONE|default("NONE")|string %}
    {% if ZONE == "NONE" %}
        RESPOND PREFIX="info" MSG="Europe/"
        {% if not client.ad5x %}
            RUN_SHELL_COMMAND CMD=ls PARAMS="/usr/share/zoneinfo/Europe"
        {% else %}
            RUN_SHELL_COMMAND CMD=ls PARAMS="/usr/data/.mod/.zmod/usr/share/zoneinfo/Europe"
        {% endif %}
        RESPOND PREFIX="info" MSG="Asia/"
        {% if not client.ad5x %}
            RUN_SHELL_COMMAND CMD=ls PARAMS="/usr/share/zoneinfo/Asia"
        {% else %}
            RUN_SHELL_COMMAND CMD=ls PARAMS="/usr/data/.mod/.zmod/usr/share/zoneinfo/Asia"
        {% endif %}
        RESPOND PREFIX="info" MSG="Use SET_TIMEZONE ZONE=Asia/Yekaterinburg"
    {% else %}
        RUN_SHELL_COMMAND CMD=rm PARAMS="/etc/localtime"
        {% if not client.ad5x %}
            RUN_SHELL_COMMAND CMD=ln PARAMS="-s /usr/share/zoneinfo/{ZONE} /etc/localtime"
        {% else %}
            RUN_SHELL_COMMAND CMD=ln PARAMS="-s /usr/data/.mod/.zmod/usr/share/zoneinfo/{ZONE} /etc/localtime"
            RUN_SHELL_COMMAND CMD=rm PARAMS="/usr/data/.mod/.zmod/etc/localtime"
            RUN_SHELL_COMMAND CMD=ln PARAMS="-s /usr/share/zoneinfo/{ZONE} /usr/data/.mod/.zmod/etc/localtime"
        {% endif %}
    {% endif %}

    RUN_SHELL_COMMAND CMD=date

[gcode_macro STOP_ZMOD]
description: ===Stop fluidd/mainsail and moonraker===
gcode:
    {% set guppy = params.GUPPY|default(1)|int %}
    {% set moonraker = params.MOONRAKER|default(1)|int %}
    {% set http = params.HTTP|default(1)|int %}

    RUN_SHELL_COMMAND CMD=stop_zmod PARAMS="stop {guppy} {moonraker} {http}"

[gcode_macro START_ZMOD]
description: ===Start fluidd/mainsail and moonraker after STOP_ZMOD===
gcode:
    {% set guppy = params.GUPPY|default(1)|int %}
    {% set moonraker = params.MOONRAKER|default(1)|int %}
    {% set http = params.HTTP|default(1)|int %}

    RUN_SHELL_COMMAND CMD=stop_zmod PARAMS="up {guppy} {moonraker} {http}"

[gcode_macro TEST_EMMC]
description: ===Test EMMC===
gcode:
    {% set size    = params.SIZE|default(400)|int %}
    {% set sync    = params.SYNC|default(1)|int %}
    {% set flash   = params.FLASH|default(0)|int %}
    {% set random  = params.RANDOM|default(0)|int %}

    RUN_SHELL_COMMAND CMD=zfs PARAMS="{size} {sync} {flash} {random}"

[gcode_macro CLEAR_EMMC]
description: ===Clear EMMC===
gcode:
    {% set log    = params.LOG|default(1)|int %}
    {% set any    = params.ANY|default(0)|int %}

    RUN_SHELL_COMMAND CMD=clear_emmc PARAMS="{log} {any}"

[gcode_macro ZSSH_ON]
description: ===Redirect moonraker and camera to SSH server===
gcode:
    {% set ssh_server  = params.SSH_SERVER|default("127.0.0.1")|string %}
    {% set ssh_port    = params.SSH_PORT|default(22)|int %}
    {% set ssh_user    = params.SSH_USER|default("user")|string %}
    {% set video_port  = params.VIDEO_PORT|default(8080)|int %}
    {% set moon_port   = params.MOON_PORT|default(7125)|int %}
    {% set remote_run  = params.REMOTE_RUN|default("NONE")|string %}
    RUN_SHELL_COMMAND CMD=zssh PARAMS="START {ssh_server} {ssh_port} {ssh_user} {video_port} {moon_port} '{remote_run}' RESTART"

[gcode_macro ZLINK]
description: ZLINK.info
gcode:
    {% set p  = params.P|default("bad")|string %}
    {% set u  = params.U|default("bad")|string %}

    {% set m  = params.M|default(0)|int %}
    {% set c  = params.C|default(0)|int %}

    {% if p == "" or u == "" or m == 0 or c ==0 %}
        RESPOND TYPE="echo" MSG="===Incorrect ZLINK data. Register your printer on the http://zlink.info and receive a ZLINK string.==="
        RUN_SHELL_COMMAND CMD=zlink PARAMS="get"
    {% else %}
        RUN_SHELL_COMMAND CMD=zlink PARAMS="enable {p} {u} {m} {c}"
    {% endif %}

[gcode_macro ZLINK_OFF]
gcode:
    RESPOND TYPE="echo" MSG="ZLINK.info off"
    RUN_SHELL_COMMAND CMD=zlink PARAMS="disable"

[gcode_macro ZSSH_OFF]
description: ===Disable SSH port forwarding===
gcode:
    RUN_SHELL_COMMAND CMD=zssh PARAMS="STOP 127.0.0.1 22 user 8080 7125 NONE RESTART"

[gcode_macro ZSSH_RESTART]
description: ===SSH restart===
gcode:
    RUN_SHELL_COMMAND CMD=zssh PARAMS="RESTART 127.0.0.1 22 user 8080 7125 NONE RESTART"
    _CHECK_VERSION

[gcode_macro ZSSH_RELOAD]
description: ===Start SSH if not running===
gcode:
    {% set screen = printer["gcode_macro _SCREEN"].screen %}
    {% set client = printer['gcode_macro _CLIENT_VARIABLE'] | default({}) %}

    {% if screen == True %}
        RESPOND PREFIX="info" MSG="===You are using native screen==="
    {% else %}
        RESPOND PREFIX="info" MSG="===You are NOT using native screen==="
    {% endif %}

    {% set zklipper13 = printer.save_variables.variables['klipper13']|default(0) | int %}
    {% if zklipper13 == 1 %}
        RESPOND PREFIX="//" MSG="===Using Klipper 13==="
    {% else %}
        {% if not client.ad5x %}
            RESPOND PREFIX="//" MSG="===Using native Klipper=== 11"
        {% else %}
            RESPOND PREFIX="//" MSG="===Using native Klipper=== 12"
        {% endif %}
    {% endif %}
    M115
    _CHECK_VERSION

    RUN_SHELL_COMMAND CMD=zssh PARAMS="RELOAD 127.0.0.1 22 user 8080 7125 NONE RESTART"

[gcode_macro _FIND_POINT]
# Поиск точки для измерения
gcode:
    {% set extruder_temp = printer["gcode_macro _START_PRINT"].zextruder_temp|float %}
    {% set bed_temp = printer["gcode_macro _START_PRINT"].zbed_temp|float %}

    {% set mesh_test = printer.save_variables.variables['mesh_test']|default(1) | int %}

    SET_GCODE_VARIABLE MACRO=_PROBE_POINT VARIABLE=find VALUE=False
    SET_GCODE_VARIABLE MACRO=_TEST_POINT VARIABLE=temp_z_offset VALUE=0.0

    {% set bed_mesh = printer.bed_mesh %}
    {% if not bed_mesh.profile_name %}
        { action_respond_info("===Profile or mesh matrix not found===") }
    {% else %}
        {% set min_x = bed_mesh.mesh_min[0]|float %}
        {% set max_x = bed_mesh.mesh_max[0]|float %}
        {% set min_y = bed_mesh.mesh_min[1]|float %}
        {% set max_y = bed_mesh.mesh_max[1]|float %}
        {% set x_count = bed_mesh.probed_matrix|length %}
        {% set y_count = bed_mesh.probed_matrix[0]|length %}

        {% set x_step = (max_x - min_x) / (x_count - 1) if x_count > 1 else 0 %}
        {% set y_step = (max_y - min_y) / (y_count - 1) if y_count > 1 else 0 %}
        {% set center_x = (min_x + max_x) / 2.0 %}
        {% set center_y = (min_y + max_y) / 2.0 %}

        {% set points = [] %}
        {% for y_index in range(y_count) %}
            {% for x_index in range(x_count) %}
                {% set x = min_x + x_index * x_step|float %}
                {% set y = min_y + y_index * y_step|float %}
                {% set z = bed_mesh.probed_matrix[y_index][x_index]|float %}
                {% set dx = x - center_x %}
                {% set dy = y - center_y %}
                {% set dist = (dx * dx + dy * dy) ** 0.5 %}
                {% set _ = points.append({'x': x, 'y': y, 'z': z, 'dist': dist}) %}
          {% endfor %}
        {% endfor %}

        # 3 - тестировать с АВТОПОДБОРОМ Z-Offset, с очисткой сопла
        # 4 - тестировать с АВТОПОДБОРОМ Z-Offset, с очисткой сопла, в случае несовпадения карты, запускать KAMP
        _ORIG_CLEAR_NOZZLE EXTRUDER_TEMP={extruder_temp} BED_TEMP={bed_temp}
        {% for p in points | sort(attribute='dist') %}
            _PROBE_POINT X={p.x} Y={p.y} Z={p.z}
        {% endfor %}
        _STOP_FAN
    {% endif %}

[gcode_macro _PROBE_POINT]
# Замер точки
variable_find: False
gcode:
    {% set x = params.X|default(0)|float %}
    {% set y = params.Y|default(0)|float %}
    {% set z = params.Z|default(0)|float %}

    {% set klipper13 = printer.save_variables.variables['klipper13']|default(0) | int %}
    {% if klipper13 == 0 %}
        {% set z_offset_klipper = printer.configfile.settings.probe.z_offset|default(0.0)|float %}
        {% set zprobe = printer.probe.last_z_result %}
    {% else %}
        {% set z_offset_klipper = 0.0|float %}
        {% set zprobe = printer.probe.last_probe_position.z %}
    {% endif %}

    {% if not find %}
        _G28
        M400
        _TEST_MIN_MAX

        { action_respond_info("X: %.4f\tY: %.4f\tZ: %.4f" | format(x, y, z + z_offset_klipper)) }

        SAVE_GCODE_STATE NAME=_probe_point
            G1 X{x} F6000
            G1 Y{y} F6000
            M400

            LOAD_CELL_TARE
            PROBE
            G1 Z5 F300
        RESTORE_GCODE_STATE MOVE=0 NAME=_probe_point

        _TEST_POINT X={x} Y={y} Z={z + z_offset_klipper}

        SET_GCODE_VARIABLE MACRO=_PROBE_POINT VARIABLE=find VALUE=True
  {% endif %}

[gcode_macro _TEST_POINT]
variable_temp_z_offset: 0.0
gcode:
    {% set extruder_temp = printer["gcode_macro _START_PRINT"].zextruder_temp|float %}
    {% set bed_temp = printer["gcode_macro _START_PRINT"].zbed_temp|float %}

    {% set mesh_test = printer.save_variables.variables['mesh_test']|default(1) | int %}
    {% set screen = printer["gcode_macro _SCREEN"].screen %}

    {% set x = params.X|default(0)|float %}
    {% set y = params.Y|default(0)|float %}
    {% set z = params.Z|default(0)|float %}

    {% set klipper13 = printer.save_variables.variables['klipper13']|default(0) | int %}
    {% if klipper13 == 0 %}
        {% set zprobe = printer.probe.last_z_result %}
    {% else %}
        {% set zprobe = printer.probe.last_probe_position.z %}
    {% endif %}

    {% set zdelta = zprobe - z | float %}

    { action_respond_info("Probe: %.4f\tMesh: %.4f\tDelta: %.4f" | format(zprobe, z, zdelta)) }

    {% if zdelta | abs < 0.31 %}
        RESTORE_GCODE_STATE MOVE=1 NAME=_mesh_test

        {% if screen == True %}
            LOAD_ZOFFSET_NATIVE
        {% endif %}
        _SET_GCODE_OFFSET_FAST Z_ADJUST={zdelta} FROM="_TEST_POINT"
        SET_GCODE_VARIABLE MACRO=_TEST_POINT VARIABLE=temp_z_offset VALUE={zdelta}

        _WAIT_TEMP EXTRUDER_TEMP={extruder_temp} BED_TEMP={bed_temp} NAME=_TEST_POINT
    {% else %}
        SET_GCODE_VARIABLE MACRO=_TEST_POINT VARIABLE=temp_z_offset VALUE=0.0

        {action_respond_info("===Possible wrong profile loaded (different plate/temperature)===")}
        {% if mesh_test == 3 %}
            # 3 - тестировать с АВТОПОДБОРОМ Z-Offset, с очисткой сопла
            {action_raise_error("===WARNING: Last probe MORE saved by %.4f mm!=== ===Use SAVE_ZMOD_DATA MESH_TEST=%d to automatically launch KAMP if an error occurs===" % (zdelta, mesh_test+1))}
        {% else %}
            {action_respond_info("===WARNING: Last probe MORE saved by %.4f mm!=== => KAMP" % (zdelta))}
            KAMP BED_TEMP={bed_temp} EXTRUDER_TEMP={extruder_temp}
        {% endif %}
    {% endif %}

[gcode_macro _MESH_TEST]
description: ===Compare grid extremes with last probe===
gcode:
    {% set profile_name = printer.bed_mesh.profile_name %}
    {% set mesh = printer.bed_mesh.profiles[profile_name] %}
    {% set mesh_test = printer.save_variables.variables['mesh_test']|default(1) | int %}

    SET_GCODE_VARIABLE MACRO=_TEST_POINT VARIABLE=temp_z_offset VALUE=0.0

    {% if mesh %}
        {% if mesh_test == 1 or mesh_test == 2 %}
            # 1 - тестировать БЕЗ автоподбора Z-Offset (по умолчанию)
            # 2 - тестировать БЕЗ автоподбора Z-Offset, в случае несовпадения карты, запускать KAMP
            RESPOND PREFIX="info" MSG="===AutoZOffset: off // See https://wiki.zmod.link/Global/ mesh_test==="
            _MESH_PROBE
            _MESH_COMPARE
        {% endif %}
        {% if mesh_test == 3 or mesh_test == 4 %}
            # 3 - тестировать с АВТОПОДБОРОМ Z-Offset, с очисткой сопла
            # 4 - тестировать с АВТОПОДБОРОМ Z-Offset, с очисткой сопла, в случае несовпадения карты, запускать KAMP
            RESPOND PREFIX="info" MSG="===AutoZOffset: on // See https://wiki.zmod.link/Global/ mesh_test==="
            SAVE_GCODE_STATE NAME=_mesh_test
            _FIND_POINT
        {% endif %}
    {% else %}
        {action_respond_info("===WARNING: Bed mesh not loaded!===")}
    {% endif %}

[gcode_macro _MESH_PROBE]
gcode:
    {% set client = printer['gcode_macro _CLIENT_VARIABLE'] | default({}) %}
    {% set kamp_settings = printer["gcode_macro _KAMP_Settings"] %}                                                                 # Pull variables from _KAMP_Settings
    {% set mesh_margin = kamp_settings.mesh_margin | float %}                                                                       # Pull mesh margin setting from _KAMP_Settings
    {% set fuzz_amount = kamp_settings.fuzz_amount | float %}                                                                       # Pull fuzz amount setting from _KAMP_Settings
    {% set fuzz_range = range((0) | int, (fuzz_amount * 100) | int + 1) %}                                                          # Set fuzz_range between 0 and fuzz_amount
    {% set adapted_x_min = mesh_margin + (fuzz_range | random / 100.0) %}                                                           # Adapt x_min to margin and fuzz constraints

    _G28
    _TEST_MIN_MAX

    {% if printer.firmware_retraction is defined %}
        {% set RETRACT = G10 | string %}
        {% set UNRETRACT = G11 | string %}
    {% else %}
        {% set RETRACT = 'G1 E-.5 F2100' | string %}
        {% set UNRETRACT = 'G1 E.5 F2100' | string %}
    {% endif %}

    G92 E0
    G90
    _CLIENT_LINEAR_MOVE X=-{adapted_x_min}

    G1 Z5 F6000

    {RETRACT}

    LOAD_CELL_TARE
    PROBE

    G1 Z5 F6000

    {UNRETRACT}

[gcode_macro _MESH_COMPARE]
gcode:
    {% set profile_name = printer.bed_mesh.profile_name %}

    {% set mesh = printer.bed_mesh %}

    {% set mesh_test = printer.save_variables.variables['mesh_test']|default(1) | int %}

    {% set klipper13 = printer.save_variables.variables['klipper13']|default(0) | int %}
    {% if klipper13 == 0 %}
        {% set z_offset_klipper = printer.configfile.settings.probe.z_offset|default(0.0)|float %}
        {% set last_probe = printer.probe.last_z_result %}
    {% else %}
        {% set z_offset_klipper = 0.0|float %}
        {% set last_probe = printer.probe.last_probe_position.z %}
    {% endif %}

    {% set extruder_temp = printer["gcode_macro _START_PRINT"].zextruder_temp|float %}  ; extruder temp, usually set by slicer
    {% set bed_temp = printer["gcode_macro _START_PRINT"].zbed_temp|float %}            ; bed temp, usually set by slicer

    {% if mesh and 'mesh_matrix' in mesh and profile_name %}
        {% set all_z = mesh.mesh_matrix | sum(start=[]) %}
        {% set min_z = all_z | min %}
        {% set max_z = all_z | max %}

        {action_respond_info("===Current profile:=== %s" % profile_name)}
        {action_respond_info("===Minimum map: %.3f mm | Delta: %.3f mm===" % (min_z + z_offset_klipper, max_z - min_z))}
        {action_respond_info("===Maximum map: %.3f mm | Last probe: %.3f mm===" % (max_z + z_offset_klipper, last_probe))}

        {% if last_probe < min_z + z_offset_klipper - 0.21 %}
            {action_respond_info("===Possible wrong profile loaded (different plate/temperature)===")}
            {action_respond_info("===Disable check with: MESH=== // SAVE_ZMOD_DATA MESH_TEST=0")}
            {% if mesh_test == 2 %}
                {action_respond_info("===WARNING: Last probe BELOW mesh minimum by %.3f mm!=== => KAMP" % (min_z - last_probe - z_offset_klipper))}
                KAMP BED_TEMP={bed_temp} EXTRUDER_TEMP={extruder_temp}
            {% else %}
                {action_raise_error("===WARNING: Last probe BELOW mesh minimum by %.3f mm!=== ===Use SAVE_ZMOD_DATA MESH_TEST=2 to automatically launch KAMP if an error occurs===" % (min_z - last_probe - z_offset_klipper))}
            {% endif %}
        {% elif last_probe > max_z + z_offset_klipper + 0.21 %}
            {action_respond_info("===Possible wrong profile loaded (different plate/temperature)===")}
            {action_respond_info("===Disable check with: MESH=== // SAVE_ZMOD_DATA MESH_TEST=0")}
            {% if mesh_test == 2 %}
                {action_respond_info("===WARNING: Last probe ABOVE mesh maximum by %.3f mm!=== => KAMP" % (last_probe - max_z - z_offset_klipper))}
                KAMP BED_TEMP={bed_temp} EXTRUDER_TEMP={extruder_temp}
            {% else %}
                {action_raise_error("===WARNING: Last probe ABOVE mesh maximum by %.3f mm!=== ===Use SAVE_ZMOD_DATA MESH_TEST=2 to automatically launch KAMP if an error occurs===" % (last_probe - max_z - z_offset_klipper))}
            {% endif %}
        {% else %}
            {action_respond_info("===OK: Probe within mesh extremes===")}
        {% endif %}

    {% else %}
        {action_respond_info("===Profile or mesh matrix not found===")}
    {% endif %}

[gcode_macro _START_MESH]
gcode:
    {% set extruder_temp = printer["gcode_macro _START_PRINT"].zextruder_temp|float %}
    {% set bed_temp = printer["gcode_macro _START_PRINT"].zbed_temp|float %}
    {% set skip_leveling = printer["gcode_macro _START_PRINT"].zskip_leveling %}
    {% set force_kamp = printer["gcode_macro _START_PRINT"].zforce_kamp %}
    {% set force_leveling = printer["gcode_macro _START_PRINT"].zforce_leveling %}
    {% set mesh = printer["gcode_macro _START_PRINT"].zmesh %}

    {% if skip_leveling == False %}
        {% if force_kamp == True %}
            RESPOND PREFIX="//" MSG="===KAMP started SKIP_LEVELING={skip_leveling} FORCE_KAMP={force_kamp}==="

            {% set screen = printer["gcode_macro _SCREEN"].screen %}
            {% if screen == True %}
                RESPOND PREFIX="info" MSG="===Did you know you can enable KAMP globally?==="
                RESPOND PREFIX="//" MSG="SAVE_ZMOD_DATA USE_KAMP=1 CLEAR=LINE_PURGE"
            {% endif %}
            M400
            KAMP BED_TEMP={bed_temp} EXTRUDER_TEMP={extruder_temp}
            M400

        {% else %}
            {% if (not printer['bed_mesh'].profile_name) or force_leveling == True %}
                {% if mesh != "" %}
                    RESPOND PREFIX="!!" MSG="===Building {mesh} mesh (not found). Save it AFTER print!==="
                    _FULL_BED_LEVEL BED_TEMP={bed_temp} EXTRUDER_TEMP={extruder_temp} PROFILE={mesh}
                {% else %}
                    {% if force_leveling == True %}
                        RESPOND PREFIX="info" MSG="===Building default mesh (FORCE_LEVELING={force_leveling})==="
                        _FULL_BED_LEVEL BED_TEMP={bed_temp} EXTRUDER_TEMP={extruder_temp} PROFILE=default
                    {% else %}
                        RESPOND PREFIX="info" MSG="===Building auto mesh (no loaded profile)==="
                        _FULL_BED_LEVEL BED_TEMP={bed_temp} EXTRUDER_TEMP={extruder_temp} PROFILE=auto
                    {% endif %}
                {% endif %}
            {% else %}
                {% set cur_mesh = printer['bed_mesh'].profile_name %}
                RESPOND PREFIX="//" MSG="===No need for leveling. Loaded profile: {cur_mesh}==="
            {% endif %}
        {% endif %}

    {% else %}
        RESPOND PREFIX="//" MSG="===Skipping bed leveling. SKIP_LEVELING={skip_leveling}==="
    {% endif %}

[gcode_macro _PRINT_MESH]
gcode:
    {% set cur_mesh = printer['bed_mesh'].profile_name %}

    RESPOND PREFIX="info" MSG="===Printing with bed mesh: {cur_mesh}==="

[gcode_macro _PREPARE_PRINT]
gcode:
    UPDATE_DELAYED_GCODE ID=_CLOSE_DIALOGS DURATION=0
    UPDATE_DELAYED_GCODE ID=_FAST_CLOSE_DIALOGS DURATION=0
    UPDATE_DELAYED_GCODE ID=_STOP_MOTOR DURATION=0
    UPDATE_DELAYED_GCODE ID=_AUTO_REBOOT DURATION=0
    UPDATE_DELAYED_GCODE ID=_PRO_POWEROFF DURATION=0
    UPDATE_DELAYED_GCODE ID=_GOTO_PAUSE DURATION=0
    UPDATE_DELAYED_GCODE ID=_ZUPDATE DURATION=0

    LOAD_CELL_TARE

    SET_GCODE_VARIABLE MACRO=_NOTIFY_ON_PERCENT VARIABLE=notified_percent VALUE=0

[gcode_macro _START_PRINT]
description: ===Replace default start G-code===
variable_zextruder_temp: 245.0
variable_zbed_temp: 80.0
variable_zforce_kamp: False
variable_zforce_leveling: False
variable_zskip_leveling: False
variable_zzoffset: 99.0
variable_zmesh: ""
gcode:
    {% set force_kamp = printer["gcode_macro _START_PRINT"].zforce_kamp %}              ; if True it forces the KAMP bed level process
    {% set extruder_temp = printer["gcode_macro _START_PRINT"].zextruder_temp|float %}  ; extruder temp, usually set by slicer
    {% set bed_temp = printer["gcode_macro _START_PRINT"].zbed_temp|float %}            ; bed temp, usually set by slicer
    {% set force_leveling = printer["gcode_macro _START_PRINT"].zforce_leveling %}      ; if True it forces the bed level process
    {% set zoffset = printer["gcode_macro _START_PRINT"].zzoffset %}                    ; Установить Z offset
    {% set skip_leveling = printer["gcode_macro _START_PRINT"].zskip_leveling %}        ; Не строить карту
    {% set mesh = printer["gcode_macro _START_PRINT"].zmesh %}                          ; Имя профиля карты стола

    {% set filename = printer.virtual_sdcard.file_path|default("")|string  %}

    {% set force_md5 = printer.save_variables.variables['force_md5']|default(1) | int %}
    {% set disable_priming = printer.save_variables.variables['disable_priming']|default(0) | int %}
    {% set disable_skew = printer.save_variables.variables['disable_skew']|default(1) | int %}
    {% set load_zoffset = printer.save_variables.variables['load_zoffset']|default(1) | int %}
    {% set zclear = printer.save_variables.variables['clear']|default("LINE_PURGE")|string %}
    {% set zuse_kamp = printer.save_variables.variables['use_kamp']|default(0) | int %}
    {% set zprint_leveling = printer.save_variables.variables['print_leveling']|default(0) | int %}

    {% set screen = printer["gcode_macro _SCREEN"].screen %}
    {% set client = printer['gcode_macro _CLIENT_VARIABLE'] | default({}) %}

    _PREPARE_PRINT

    CLEAR_PAUSE
    ZCONTROL_AUTO
    ZCONTROL_ON
    SET_GCODE_VARIABLE MACRO=_CANCEL_PRINT VARIABLE=cancel_send VALUE=0
    ZSSH_RELOAD

    RESPOND PREFIX="info" MSG="START_PRINT BED_TEMP={bed_temp} EXTRUDER_TEMP={extruder_temp} FORCE_LEVELING={force_leveling} FORCE_KAMP={force_kamp} Z_OFFSET={zoffset} SKIP_LEVELING={skip_leveling} MESH={mesh}"

    RESPOND PREFIX="info" MSG="===Extruder temperature: {extruder_temp}==="
    RESPOND PREFIX="info" MSG="===Bed temperature: {bed_temp}==="

    {% if zprint_leveling == 0 %}
        {% if force_kamp == True %}
            RESPOND PREFIX="info" MSG="===KAMP: enabled==="
        {% else %}
            RESPOND PREFIX="info" MSG="===KAMP: disabled==="
        {% endif %}

        {% if force_leveling == True %}
            RESPOND PREFIX="info" MSG="===Forced bed leveling: enabled==="
        {% else %}
            RESPOND PREFIX="info" MSG="===Forced bed leveling: disabled==="
        {% endif %}

        {% if skip_leveling == True %}
            RESPOND PREFIX="info" MSG="===Skip bed leveling: enabled==="
        {% else %}
            RESPOND PREFIX="info" MSG="===Skip bed leveling: disabled==="
        {% endif %}

        RESPOND PREFIX="info" MSG="===Load bed mesh: {mesh}==="
    {% endif %}

    {% if screen == False %}
        {% if force_md5 == 1 %}
            RESPOND PREFIX="info" MSG="===MD5: enabled==="
        {% else %}
            RESPOND PREFIX="info" MSG="===MD5: disabled==="
        {% endif %}
    {% endif %}

    {% if disable_priming == 1 %}
        RESPOND PREFIX="info" MSG="===Nozzle priming: disabled==="
    {% else %}
        RESPOND PREFIX="info" MSG="===Nozzle priming: enabled==="
        RESPOND PREFIX="info" MSG="===Priming algorithm: {zclear}==="
    {% endif %}

    {% if disable_skew == 1 %}
        RESPOND PREFIX="info" MSG="===SKEW: disabled==="
    {% else %}
        RESPOND PREFIX="info" MSG="===SKEW: enabled==="
    {% endif %}

    {% set check_md5 = printer.save_variables.variables['check_md5']|default(0) | int %}
    {% if ( force_md5 == 1 and check_md5 == 0 ) %}
        RESPOND PREFIX="info" MSG="===MD5 check started==="
        CHECK_MD5 DELETE=True
    {% endif %}

    M140 S{bed_temp}        ; start bed heating
    SET_SKEW CLEAR=1        ; reset skew profile if loaded

    _G28

    {% if not client.ad5x %}
        {% set we = printer['temperature_sensor weightValue'].temperature %}
        {% if we != 0 %}
            LOAD_CELL_TARE
        {% endif %}
    {% endif %}

    {% if zprint_leveling == 1 %}
        {% if screen == True %}
            RESPOND PREFIX="//" MSG="===Building bed mesh with native screen on each print.=== // SAVE_ZMOD_DATA PRINT_LEVELING={zprint_leveling}"
        {% else %}
            RESPOND PREFIX="//" MSG="===Building bed mesh on each print.=== // SAVE_ZMOD_DATA PRINT_LEVELING={zprint_leveling}"
            BED_MESH_CLEAR
            M400
            {% if zuse_kamp == 1 %}
                RESPOND PREFIX="info" MSG="===Using KAMP from global settings.=== // SAVE_ZMOD_DATA USE_KAMP={zuse_kamp}"
                M400
                KAMP BED_TEMP={bed_temp} EXTRUDER_TEMP={extruder_temp}
                M400
            {% else %}
                RESPOND PREFIX="info" MSG="===Building full bed mesh.=== // SAVE_ZMOD_DATA USE_KAMP={zuse_kamp}"
                M400
                _FULL_BED_LEVEL BED_TEMP={bed_temp} EXTRUDER_TEMP={extruder_temp}
                M400
            {% endif %}
        {% endif %}

        RESPOND PREFIX="//" MSG="===All START_PRINT parameters for bed leveling are ignored==="
    {% else %}
        {% if mesh != "" %}
            RESPOND PREFIX="info" MSG="===Trying to load bed mesh: {mesh}==="
            BED_MESH_CLEAR
            M400
            {% for mesh_dt in printer['bed_mesh'].profiles %}
                {% if mesh == mesh_dt %}
                    BED_MESH_PROFILE LOAD={mesh}
                    RESPOND PREFIX="info" MSG="===Bed mesh {mesh} loaded==="
                {% endif %}
            {% endfor %}
        {% endif %}

        _START_MESH
    {% endif %}

    # load skew profile
    {% if disable_skew == 0 %}
        RESPOND PREFIX="info" MSG="===Loading skew_profile==="
        SKEW_PROFILE LOAD=skew_profile
    {% endif %}

    G90                     ; use absolute coordinates
    {% if (zprint_leveling == 0 and force_kamp == True) or (zprint_leveling == 1 and screen == False and zuse_kamp == 1) or (zclear == "LINE_PURGE" and client.ad5x == 0 ) %}
        _SMART_PARK
    {% else %}
        _UGOL_PARK
    {% endif %}

    #M190 S{bed_temp}
    #M109 S{extruder_temp}

    _WAIT_TEMP EXTRUDER_TEMP={extruder_temp} BED_TEMP={bed_temp} NAME=START_PRINT

    {% if client.ad5x %}
        {% if not ( (zprint_leveling == 0 and force_kamp == True ) or ( zprint_leveling == 1 and screen == False and zuse_kamp == 1 ) ) %}
            _PRINT_CLEAR_NOZZLE
        {% endif %}
        M400
        _SMART_PARK
    {% endif %}

    {% if (load_zoffset == 1) and (screen == False) %}
        RESPOND PREFIX="info" MSG="===Using global Z-Offset control. Z_OFFSET parameter ignored==="
        LOAD_GCODE_OFFSET
    {% else %}
        {% if (load_zoffset == 1) and (screen == True) %}
            RESPOND PREFIX="info" MSG="===Global Z-Offset load: ignored (working with screen)==="
        {% endif %}

        {% if zoffset == 99.0 %}
            RESPOND PREFIX="info" MSG="===Z-Offset setup skipped==="
        {% else %}
            RESPOND PREFIX="info" MSG="===Setting Z-Offset {zoffset}==="
            _SET_GCODE_OFFSET_FAST Z={zoffset} FROM=START_PRINT
        {% endif %}
    {% endif %}

    {% set mesh_test = printer.save_variables.variables['mesh_test']|default(1) | int %}
    {% if mesh_test == 0 or force_kamp == True or zprint_leveling == 1 or force_leveling == True %}
        _PRINT_MESH
    {% else %}
        _MESH_TEST
    {% endif %}

    {% if printer.gcode_move.gcode_position.z < 5 %}
        G1 Z5 F3000
    {% endif %}

    {% set zmidi_start = printer.save_variables.variables['midi_start']|default("") | string %}

    {% if zmidi_start != "" %}
        PLAY_MIDI FILE={zmidi_start}
    {% endif %}

    {% if disable_priming == 1 %}
        RESPOND PREFIX="info" MSG="===Nozzle line purge disabled. DISABLE_PRIMING={disable_priming}==="
    {% else %}
        RESPOND PREFIX="info" MSG="===Nozzle line purge===. ===Algorithm: {zclear}==="

        {% set macro_name = zclear | lower %}
        {% set macro_key = "gcode_macro " + macro_name %}
        {% set macro_settings = printer.configfile.settings.get(macro_key) %}
        {% if macro_settings is none %}
            RESPOND TYPE=error MSG="{macro_name|upper} - ===this cleanup macro does NOT exist. LINE_PURGE is used===. ===Add the {macro_name|upper} macro to mod_data/user.cfg or disable the use of the cleanup line // SAVE_ZMOD_DATA DISABLE_PRIMING=1==="
            RESPOND TYPE=echo MSG="===Available macros===:"
            RESPOND TYPE=echo MSG="LINE_PURGE // SAVE_ZMOD_DATA CLEAR=LINE_PURGE"
            RESPOND TYPE=echo MSG="_CLEAR1 // SAVE_ZMOD_DATA CLEAR=_CLEAR1"
            RESPOND TYPE=echo MSG="_CLEAR2 // SAVE_ZMOD_DATA CLEAR=_CLEAR2"
            RESPOND TYPE=echo MSG="_CLEAR3 // SAVE_ZMOD_DATA CLEAR=_CLEAR3"
            RESPOND TYPE=echo MSG="_CLEAR4 // SAVE_ZMOD_DATA CLEAR=_CLEAR4"
            {% set zzclear = "LINE_PURGE" %}
        {% else %}
            {% set zzclear = zclear | upper %}
        {% endif %}

        {% if ( (force_kamp == True) or (zuse_kamp == 1) ) and (zzclear == "_CLEAR1" or zzclear == "_CLEAR2" or zzclear == "_CLEAR3" or zzclear == "_CLEAR4") %}
            RESPOND PREFIX="info" MSG="===You are using KAMP. Recommended to use LINE_PURGE:=== // SAVE_ZMOD_DATA CLEAR=LINE_PURGE"
            RESPOND PREFIX="info" MSG="===LINE_PURGE forced==="
            M400
            LINE_PURGE
            M400
        {% else %}
            _TEST_MIN_MAX
            M400
            SAVE_GCODE_STATE NAME=clear_state
            M400
            {% if zzclear != zclear %}
                RESPOND PREFIX="info" MSG="{zzclear}"
            {% endif %}
            {zzclear}
            M400
            RESTORE_GCODE_STATE MOVE=0 NAME=clear_state
        {% endif %}
    {% endif %}
    EXCLUDE_OBJECT_DEFINE RESET=1
    ZEXCLUDE
    RESPOND TYPE=echo MSG="===START_PRINT has finished its work.==="

[gcode_macro UPDATE_MCU]
description: ===Update MCU===
gcode:
    {% set client = printer['gcode_macro _CLIENT_VARIABLE'] | default({}) %}
    {% set current_klipper13 = printer.save_variables.variables['klipper13']|default(0) | int %}
    {% set force = params.FORCE|default(0)|int %}

    RESPOND TYPE=error MSG="===Wait for the music and power off the printer.=== ===Wait 10 seconds and power on again. MCU update will begin.==="

    {% if (current_klipper13 == 1 and force == 0) or (force == 11) or (force == 12) %}
        RESPOND PREFIX="info" MSG="===Flashing MCU with original version for native Klipper==="
        #SAVE_VARIABLE VARIABLE=klipper13 VALUE={0|int}
        G4 P5000
        M400
        RUN_SHELL_COMMAND CMD=zmcu PARAMS="0"
    {% else %}
        {% if (current_klipper13 == 0 and force == 0) or (force == 13) %}
            RESPOND PREFIX="info" MSG="Flash MCU Klipper 13"
            #SAVE_VARIABLE VARIABLE=klipper13 VALUE={1|int}
            G4 P5000
            M400
            RUN_SHELL_COMMAND CMD=zmcu PARAMS="1"
        {% endif %}
    {% endif %}

[gcode_macro NEW_SAVE_CONFIG]
description: ===Save parameters without stock screen freeze===
gcode:
    {% set screen = printer["gcode_macro _SCREEN"].screen %}
    {% set client = printer['gcode_macro _CLIENT_VARIABLE'] | default({}) %}

    M400
    {% if screen == False or client.ad5x %}
        _ORIG_SAVE_CONFIG
    {% else %}
        RESPOND PREFIX="info" MSG="NEW_SAVE_CONFIG"
        RUN_SHELL_COMMAND CMD=restart_klipper
    {% endif %}

[gcode_macro CLOSE_DIALOGS]
description: ===Close dialogs on stock screen (slow)===
gcode:
    {% set client = printer['gcode_macro _CLIENT_VARIABLE'] | default({}) %}

    {% if not client.ad5x %}
        RESPOND PREFIX="info" MSG="===Closing dialog windows on native screen (slow)==="
        RUN_SHELL_COMMAND CMD=close_dialogs
        RESPOND PREFIX="info" MSG="===Failed to close windows? Use fast close: FAST_CLOSE_DIALOGS=== // SAVE_ZMOD_DATA CLOSE_DIALOGS=2"
    {% else %}
        FAST_CLOSE_DIALOGS
    {% endif %}

[gcode_macro FAST_CLOSE_DIALOGS]
description: ===Close dialogs on stock screen (fast)===
gcode:
    RESPOND PREFIX="info" MSG="===Closing dialog windows on native screen (fast)==="
    RUN_SHELL_COMMAND CMD=zprint PARAMS="CLOSE CLOSE"

[delayed_gcode _STOP_MOTOR]
gcode:
    RESPOND PREFIX="info" MSG="===Motors disabled==="
    M84                     ; Выключить мотор

[delayed_gcode _ZUPDATE]
gcode:
    RUN_SHELL_COMMAND CMD=zupdate

[delayed_gcode _GOTO_PAUSE]
gcode:
    {% set client = printer['gcode_macro _CLIENT_VARIABLE'] | default({}) %}

    {% if not client.ad5x %}
        G90
        RESPOND PREFIX="info" MSG="===Moving head to far right corner==="
        G1 X{client.custom_park_x} F7800
        M400
        G1 Y{client.custom_park_y} F7800
        M400
    {% else %}
        _GOTO_TRASH
    {% endif %}

[delayed_gcode _CLOSE_DIALOGS]
gcode:
    CLOSE_DIALOGS

[delayed_gcode _FAST_CLOSE_DIALOGS]
gcode:
    FAST_CLOSE_DIALOGS

[delayed_gcode _AUTO_REBOOT]
gcode:
    {% set zauto_reboot = printer.save_variables.variables['auto_reboot']|default(0) | int %}
    {% set screen = printer["gcode_macro _SCREEN"].screen %}

    _REBOOT

    {% if (zauto_reboot == 2) and (screen == False) %}
        FIRMWARE_RESTART
    {% else %}
        REBOOT
    {% endif %}

[delayed_gcode _PRO_POWEROFF]
gcode:
    SHUTDOWN

[delayed_gcode restart_services]
initial_duration: 180
gcode:
    ZSSH_RELOAD

[delayed_gcode start_led]
initial_duration: 10
gcode:
    CAMERA_RESTART
    _FIX_CLEAR

    {% set client = printer['gcode_macro _CLIENT_VARIABLE'] | default({}) %}
    {% set screen = printer["gcode_macro _SCREEN"].screen %}

    {% set save_filament_sensors = printer.save_variables.variables['save_filament_sensors']|default(0) | int %}
    {% set e0_sensor_status = printer.save_variables.variables['e0_sensor']|default(1) | int %}
    {% set head_switch_sensor_status = printer.save_variables.variables['head_switch_sensor']|default(1) | int %}
    {% set ifs_motion_sensor_status = printer.save_variables.variables['ifs_motion_sensor']|default(1) | int %}

    {% if client.ad5x %}
        UPDATE_FF_OFFSET
    {% endif %}

    RUN_SHELL_COMMAND CMD=zshaper_new PARAMS="SCV {printer.configfile.settings.printer.square_corner_velocity}"

    SET_GCODE_VARIABLE MACRO=_CANCEL_PRINT VARIABLE=cancel_send VALUE=0
    SET_GCODE_VARIABLE MACRO=_SHUTDOWN VARIABLE=trigger_allowed VALUE=True
    SET_GCODE_VARIABLE MACRO=SET_LED VARIABLE=allowed VALUE=True

    SAVE_VARIABLE VARIABLE=check_md5 VALUE={0|int}

    {% set zcontrol_z = printer.save_variables.variables['zcontrol_z']|default(10) | int %}
    ZCONTROL_Z Z={zcontrol_z}

    GET_ZMOD_DATA

    {% set zmidi_on = printer.save_variables.variables['midi_on']|default("") | string %}
    {% if zmidi_on != "" %}
        PLAY_MIDI FILE={zmidi_on}
    {% endif %}

    RUN_SHELL_COMMAND CMD=zlink PARAMS="start"
    _LANG SKIP=0
    _GLOBAL START=1
    LOAD_ZOFFSET_NATIVE START=1

    {% if save_filament_sensors == 1 %}
        {% if client.ad5x %}
            {% if screen == False %}
                RESPOND PREFIX="info" MSG="head_switch_sensor: {head_switch_sensor_status}"
                _SET_FILAMENT_SENSOR SENSOR=head_switch_sensor ENABLE={head_switch_sensor_status}
                RESPOND PREFIX="info" MSG="ifs_motion_sensor: {ifs_motion_sensor_status}"
                _SET_FILAMENT_SENSOR SENSOR=ifs_motion_sensor ENABLE={ifs_motion_sensor_status}
            {% endif %}
        {% else %}
            RESPOND PREFIX="info" MSG="e0_sensor: {e0_sensor_status}"
            _SET_FILAMENT_SENSOR SENSOR=e0_sensor ENABLE={e0_sensor_status}
        {% endif %}
    {% endif %}

    {% set zled = printer.save_variables.variables['led']|default(50) | int %}
    LED S={zled}
    _NOTIFY MSG="===Start printer===" TYPE=on

[gcode_macro _COLDPULL_LOAD_MATERIAL_END]
gcode:
    RESPOND TYPE=command MSG="action:prompt_end"

[gcode_macro _GOTO_MID]
gcode:

[gcode_macro _COLDPULL_LOAD_MATERIAL]
gcode:
    {% set client = printer['gcode_macro _CLIENT_VARIABLE'] | default({}) %}
    RESPOND TYPE=command MSG=action:prompt_end

    _G28
    _GOTO_MID

    G90
    G1 X{client.min_x+(client.max_x-client.min_x)/2} F7800
    M400
    G1 Y{client.min_y+(client.max_y-client.min_y)/2} F7800
    M400

    {% set extruder_temp = params.TEMP|default(245)|float %}
    RESPOND PREFIX="info" MSG="===Waiting for nozzle to heat up to {extruder_temp}==="
    M104 S{extruder_temp}
    TEMPERATURE_WAIT SENSOR=extruder MINIMUM={extruder_temp} MAXIMUM={extruder_temp+10}

    RESPOND PREFIX="info" MSG="===Extruding 10 cm of filament==="

    G92 E0
    _DISABLE_SENSOR
        G1 E100 F100
        M400
    _ENABLE_SENSOR

    {% set cold_temp = params.COLD|default(245)|float %}
    RESPOND PREFIX="info" MSG="===Cooling down to {cold_temp}°C==="
    M104 S{cold_temp}
    M106 P0 S255
    TEMPERATURE_WAIT SENSOR=extruder MINIMUM={cold_temp-2} MAXIMUM={cold_temp+2}

    RESPOND PREFIX="info" MSG="===Pulling the filament==="

    G92 E0
    _DISABLE_SENSOR
        G1 E-70 F1500
        M400
    _ENABLE_SENSOR

    RESPOND PREFIX="info" MSG="===Remove the remaining filament manually==="
    M107
    M104 S0
    G92 E0

[gcode_macro COLDPULL]
description: ===Cold pull (nozzle cleaning) gently===
gcode:
    RESPOND TYPE=command MSG="action:prompt_begin ===Material selection for loading==="
    RESPOND TYPE=command MSG="action:prompt_text ===Select material to clean the nozzle==="
    RESPOND TYPE=command MSG="action:prompt_button_group_start"
    RESPOND TYPE=command MSG="action:prompt_button PETG|_COLDPULL_LOAD_MATERIAL TEMP=245 COLD=100|primary"
    RESPOND TYPE=command MSG="action:prompt_button ABS|_COLDPULL_LOAD_MATERIAL TEMP=255 COLD=105|primary"
    RESPOND TYPE=command MSG="action:prompt_button NEYLON|_COLDPULL_LOAD_MATERIAL TEMP=260 COLD=120|primary"
    RESPOND TYPE=command MSG="action:prompt_button_group_end"
    RESPOND TYPE=command MSG="action:prompt_footer_button ===Cancel===|_COLDPULL_LOAD_MATERIAL_END"
    RESPOND TYPE=command MSG="action:prompt_show"

[gcode_macro SET_LED]
description: ===Set LED===
rename_existing: _SET_LED
variable_allowed: False
gcode:
    {% if allowed %}
        _SET_LED {% for p in params %}{'%s=%s '% (p, params[p])}{% endfor %}
    {% endif %}

[gcode_macro _SET_GCODE_OFFSET_FAST]
gcode:
    {% set from = params.FROM|default("===Native Screen===")|string %}

    {% if 'Z' in params %}
        {% set z = params.Z | default(0.0)| float %}
        {action_respond_info("Z-Offset: %.4f %s" % (z, from))}
    {% endif %}

    {% if 'Z_ADJUST' in params %}
        {% set z = (printer.gcode_move.homing_origin.z | float) + (params.Z_ADJUST | float) %}
        {action_respond_info("Z-Offset: %.4f %s" % (z, from))}
    {% endif %}

    _SET_GCODE_OFFSET {% for p in params %}{'%s=%s '% (p, params[p])}{% endfor %}

[gcode_macro SET_GCODE_OFFSET]
description: ===Save Z-Offset===
rename_existing: _SET_GCODE_OFFSET
gcode:
    {% set screen = printer["gcode_macro _SCREEN"].screen %}


    {% set start = params.START|default(0)|int %}
    {% set from = params.FROM|default("===Native Screen===")|string %}

    {% if printer.save_variables.variables['gcode_offsets'] %}
        {% set offsets = printer.save_variables.variables['gcode_offsets'] %}
    {% else %}
        {% set offsets = {'z': None} %}
    {% endif %}

    {% set ns = namespace(offsets={'z': offsets.z}) %}

    {% if 'Z' in params %}
        {% set z = params.Z | default(0.0)| float %}
        {% set null = ns.offsets.update({'z': z}) %}
    {% endif %}

    {% if 'Z_ADJUST' in params %}
        {% set z = (printer.gcode_move.homing_origin.z | float) + (params.Z_ADJUST | default(0.0)|float)  %}
        {% set null = ns.offsets.update({'z': z}) %}
    {% endif %}

    {% if screen == True and start == 1 and 'Z' in params %}
        RESPOND PREFIX="info" MSG="===Z-Offset saved in the native screen===: {params.Z}"
    {% endif %}

    {% if start == 0 %}
        {% if 'Z_ADJUST' in params or 'Z' in params %}
            {action_respond_info("Z-Offset: %.4f %s" % (z, from))}
        {% endif %}
        _SET_GCODE_OFFSET {% for p in params %}{'%s=%s '% (p, params[p])}{% endfor %}
    {% endif %}

    {% if screen == False %}
        {% if start == 0 %}
            {% if 'Z_ADJUST' in params or 'Z' in params %}
                {% set temp_z_offset = printer["gcode_macro _TEST_POINT"].temp_z_offset | default(0.0) | float %}
                {% set ns_save = ns.offsets %}
                {% set _ = ns_save.update({'z': z - (temp_z_offset | float)}) %}
                SAVE_VARIABLE VARIABLE=gcode_offsets VALUE="{ns_save}"
            {% endif %}
        {% else %}
            LOAD_GCODE_OFFSET START=1
        {% endif %}
    {% endif %}

[gcode_macro LOAD_GCODE_OFFSET]
description: ===Restore Z-Offset===
gcode:
    {% set start = params.START|default(0)|int %}

    SET_GCODE_VARIABLE MACRO=_TEST_POINT VARIABLE=temp_z_offset VALUE=0.0

    {% if printer.save_variables.variables['gcode_offsets'] %}
        {% set offsets = printer.save_variables.variables['gcode_offsets'] %}
        {% if start == 0 %}
            {% for axis, offset in offsets.items() %}
                {% if offset is number%}
                    { action_respond_info("===Loaded offset from global settings %s=%.4f=== " % (axis|upper, offset|float)) }
                {% endif %}
            {% endfor %}
            _SET_GCODE_OFFSET_FAST {% for axis, offset in offsets.items() if offsets[axis] %}{ "%s=%s " % (axis, offset) }{% endfor %} FROM=LOAD_GCODE_OFFSET
        {% else %}
            {% for axis, offset in offsets.items() %}
                {% if offset is number%}
                    { action_respond_info("===Z-Offset saved in global settings===: %.4f " % (offset|float)) }
                {% endif %}
            {% endfor %}
        {% endif %}
    {% else %}
        _SET_GCODE_OFFSET_FAST Z=0.0 FROM=LOAD_GCODE_OFFSET
    {% endif %}

[gcode_macro SET_FAN_SPEED]
description: ===Fans control===
rename_existing: _SET_FAN_SPEED
gcode:
    {% set fan = params.FAN|string %}
    {% set speed = params.SPEED|default(0)|float %}

    {% if fan != 'pcb_fan' and fan != 'external_fan' and fan != 'internal_fan' %}
        _SET_FAN_SPEED {% for p in params %}{'%s=%s '% (p, params[p])}{% endfor %}
    {% else %}
        {% if fan == 'external_fan' %}
            _SET_FAN_SPEED FAN=internal SPEED={speed}
        {% else %}
            {% if fan == 'internal_fan' %}
                _SET_FAN_SPEED FAN=external SPEED={speed}
            {% endif %}
        {% endif %}
    {% endif %}

[gcode_macro _SVG28]
gcode:
    SET_GCODE_VARIABLE MACRO=G28 VARIABLE=z VALUE={printer.gcode_move.gcode_position.z}

[gcode_macro SET_IDLE_TIMEOUT]
rename_existing: SET_IDLE_TIMEOUT_ORIG
gcode:
    {% set tm = params.TIMEOUT|default(1801)|float %}

    {% if (not printer.pause_resume.is_paused) and (tm == 1800) %}
        ZCONTROL_ON
    {% endif %}

    SET_IDLE_TIMEOUT_ORIG TIMEOUT={tm}

[gcode_macro _Z_G28]
gcode:

[gcode_macro _PRE_Z_G28]
gcode:
    G28.1 Z
    M400
    _SVG28


[gcode_macro G28]
rename_existing: G28.1
variable_z: 220
gcode:
    {% set client = printer['gcode_macro _CLIENT_VARIABLE'] | default({}) %}

    {% if not 'X' in params and not 'Y' in params and not 'Z' in params %}
        _HOME
    {% else %}
        {% if client.ad5x %}
            _FIX_G28
        {% endif %}
        {% if 'Z' in params or not('X' in params or 'Y' in params or 'Z' in params) %}
            _PRE_Z_G28
        {% endif %}
        {% if 'X' in params or not('X' in params or 'Y' in params or 'Z' in params) or ('Y' in params and ("x" not in printer.toolhead.homed_axes)) %}
            G28.1 X
            M400
        {% endif %}
        {% if 'Y' in params or not('X' in params or 'Y' in params or 'Z' in params) %}
            G28.1 Y
            M400
        {% endif %}
        {% if 'Z' in params or not('X' in params or 'Y' in params or 'Z' in params) %}
            _Z_G28
        {% endif %}

    {% endif %}

[gcode_macro _CANCEL_PRINT]
variable_cancel_send: 0
gcode:

[gcode_macro _CLIENT_LINEAR_MOVE]
description: ===Linear move with gcode state save/restore===
gcode:
    {% set client = printer['gcode_macro _CLIENT_VARIABLE'] | default({}) %}
    {% set e_move = "E" ~ params.E if params.E is defined else "" %}
    {% set rate = "F" ~ params.F if params.F is defined else "" %}
    {% set ABSOLUTE = params.ABSOLUTE | default(0) | int != 0 %}
    {% set z_max = [ printer['gcode_macro G28'].z | default(220), 220 ] | min %}
    {% if ABSOLUTE %}
        {% set x_move = "X" ~ ([ [params.X|float, client.max_x]  |min, client.min_x]| max) if params.X is defined else "" %}
        {% set y_move = "Y" ~ ([ [params.Y|float, client.max_y]  |min, client.min_y]| max) if params.Y is defined else "" %}
        {% set z_move = "Z" ~ ([ [params.Z|float, z_max]|min, 0   ]| max) if params.Z is defined else "" %}
    {% else %}
        {% set pos = printer.gcode_move.gcode_position %}
        {% if params.X is defined %}
            {% set x_move = "X" ~ ([client.min_x - pos.x, [client.max_x - pos.x, params.X|float]| min]| max) %}
        {% else %}
            {% set x_move = "" %}
        {% endif %}
        {% if params.Y is defined %}
            {% set y_move = "Y" ~ ([client.min_y - pos.y, [client.max_y - pos.y, params.Y|float]| min]| max) %}
        {% else %}
            {% set y_move = "" %}
        {% endif %}
        {% if params.Z is defined %}
            {% set z_move = "Z" ~ ([- pos.z, [z_max - pos.z, params.Z|float]| min]| max) %}
        {% else %}
            {% set z_move = "" %}
        {% endif %}
    {% endif %}

    M400
    SAVE_GCODE_STATE NAME=_client_movement

    # Не двигаем головой во время печати
    {% if state != 'printing' %}
        {% set ABSOLUTE_E = params.ABSOLUTE_E | default(0) | int != 0 %}


        {% if x_move or y_move or z_move %}
            G9{ 0 if ABSOLUTE else 1 }
        {% endif %}
        {% if e_move %}
            M8{ 2 if ABSOLUTE_E else 3 }
        {% endif %}

        RESPOND PREFIX="//" MSG="G1 { x_move } { y_move } { z_move } { e_move } { rate }"
        G1 { x_move } { y_move } { z_move } { e_move } { rate }
    {% else %}
        RESPOND PREFIX="info" MSG="===Printing in progress. Movement is disabled.==="
    {% endif %}

    RESTORE_GCODE_STATE MOVE=0 NAME=_client_movement

[gcode_macro _ZSDCARD_PRINT_FILE]
gcode:
    {% set client = printer['gcode_macro _CLIENT_VARIABLE'] | default({}) %}
    {% set force_md5 = printer.save_variables.variables['force_md5']|default(1) | int %}
    {% set silent = printer.save_variables.variables['silent']|default(0) | int %}
    {% set zprint_leveling = printer.save_variables.variables['print_leveling']|default(0) | int %}
    {% set path = printer.configfile.settings.virtual_sdcard.path %}

    _PREPARE_PRINT

    {% if 'FILENAME' in params %}
        {% set filename = params.FILENAME|default("")|string %}
    {% else %}
        {action_raise_error("===Error! Filename not specified.===")}
    {% endif %}

    {% if force_md5 == 1 %}
        RESPOND PREFIX="info" MSG="===Started MD5 check {filename}==="
        CHECK_MD5 DELETE=True FILENAME="{path}{filename}"
    {% endif %}

    {% if not client.ad5x %}
        SDCARD_PRINT_FILE FILENAME="{filename}"
    {% else %}
        SET_ZCOLOR FILENAME="{filename}" SILENT={silent} LEVELING={zprint_leveling}
    {% endif %}

[gcode_macro SDCARD_PRINT_FILE]
rename_existing: BASE_SDCARD_PRINT_FILE
gcode:
    {% set filename = params.FILENAME|default("")|string %}
    {% set zclear = printer.save_variables.variables['clear']|default("LINE_PURGE")|string %}
    {% set zuse_kamp = printer.save_variables.variables['use_kamp']|default(0) | int %}
    {% set path = printer.configfile.settings.virtual_sdcard.path %}

    {% set screen = printer["gcode_macro _SCREEN"].screen %}
    {% if screen == False %}
        _CHECK_START_PRINT FILENAME="{path}{filename}"
    {% endif %}

    ZCONTROL_AUTO
    ZCONTROL_ON
    _G28
    G90
    M400
    G1 Z50 F3000
    M400
    BASE_SDCARD_PRINT_FILE {rawparams}

    {% if zuse_kamp == 1 or zclear == "LINE_PURGE" %}
        RESPOND PREFIX="info" MSG="===Getting data for KAMP.==="
        RUN_SHELL_COMMAND CMD=zexclude PARAMS={'"%s"' % (filename.replace("'", "\\\'").replace(" ", "\ "))}
    {% endif %}

[gcode_macro SDCARD_RESET_FILE]
rename_existing: BASE_SDCARD_RESET_FILE
gcode:
    ZCONTROL_OFF
    BASE_SDCARD_RESET_FILE

[gcode_macro BELTS_SHAPER_CALIBRATION]
description: ===CoreXY half-axis test for belt frequency analysis===
gcode:
    {% set spectrogram = params.SPECTROGRAM|default(0)|int %}
    {% set client = printer['gcode_macro _CLIENT_VARIABLE'] | default({}) %}

    {% if not client.ad5x %}
        RESPOND PREFIX="!!" MSG="===Requires 256MB RAM + enabled SWAP. !!==="
        _GUPPY_BELTS_SHAPER_CALIBRATION SPECTROGRAM={spectrogram} PNG_WIDTH=10 PNG_HEIGHT=10 PNG_OUT_PATH="/opt/config/mod_data/belts_calibration_full.png"
    {% else %}
        _GUPPY_BELTS_SHAPER_CALIBRATION SPECTROGRAM=0 PNG_WIDTH=10 PNG_HEIGHT=10 PNG_OUT_PATH="/opt/config/mod_data/belts_calibration_full.png"
    {% endif %}

[gcode_macro _GUPPY_BELTS_SHAPER_CALIBRATION]
description: ===CoreXY half-axis test for belt frequency analysis===
gcode:
    {% set lang = printer.configfile.config.zmod.language|default("en") | string %}

    {% set min_freq = params.FREQ_START|default(5)|float %}
    {% set max_freq = params.FREQ_END|default(100)|float %}
    {% set hz_per_sec = params.HZ_PER_SEC|default(1)|float %}
    {% set png_out_path = params.PNG_OUT_PATH|default("/opt/config/mod_data/belts_calibration.png") %}
    {% set png_width = params.PNG_WIDTH|default(8)|float %}
    {% set png_height = params.PNG_HEIGHT|default(4.8)|float %}
    {% set spectrogram = params.SPECTROGRAM|default(0)|int %}

    TEST_RESONANCES AXIS=1,1 OUTPUT=raw_data NAME=b FREQ_START={min_freq} FREQ_END={max_freq} HZ_PER_SEC={hz_per_sec}
    M400

    TEST_RESONANCES AXIS=1,-1 OUTPUT=raw_data NAME=a FREQ_START={min_freq} FREQ_END={max_freq} HZ_PER_SEC={hz_per_sec}
    M400

    RESPOND MSG="===Generating belts frequency profile...==="
    RESPOND MSG="===This will take some time (3-5 minutes)==="

    {% set klipper13 = printer.save_variables.variables['klipper13']|default(0) | int %}
    {% if klipper13 == 1 %}
        {% set fname = "/tmp/raw_data_axis=1.000,-1.000,0.000_a.csv /tmp/raw_data_axis=1.000,1.000,0.000_b.csv" %}
    {% else %}
        {% set fname = "/tmp/raw_data_axis=1.000,-1.000_a.csv /tmp/raw_data_axis=1.000,1.000_b.csv" %}
    {% endif %}

    {% if spectrogram == 1 %}
        RUN_SHELL_COMMAND CMD=guppy_belts_calibration PARAMS="-w {png_width} -l {png_height} -o {png_out_path} -k /usr/share/klipper {fname} --{lang}"
    {% else %}
        RUN_SHELL_COMMAND CMD=guppy_belts_calibration PARAMS="-w {png_width} -l {png_height} -n -o {png_out_path} -k /usr/share/klipper {fname} --{lang}"
    {% endif %}

    RESPOND PREFIX="info" MSG="===Image saved: {png_out_path}. Configuration -> mod_data==="
    RESPOND PREFIX="//" MSG="Command {guppy_belts_calibration} finished"

[gcode_macro _GUPPY_EXCITATE_AXIS_AT_FREQ]
description: ===Maintain frequency for vibration diagnostics===
gcode:
    {% set frequency = params.FREQUENCY|default(25)|int %}
    {% set time = params.TIME|default(10)|int %}
    {% set axis = params.AXIS|default("x")|string|lower %}

    {% if axis not in ["x", "y", "a", "b"] %}
      { action_raise_error("AXIS selection invalid. Should be either x, y, a or b!") }
    {% endif %}

    {% if axis == "a" %}
        {% set axis = "1,-1" %}
    {% elif axis == "b" %}
        {% set axis = "1,1" %}
    {% endif %}

    TEST_RESONANCES OUTPUT=raw_data AXIS={axis} FREQ_START={frequency-1} FREQ_END={frequency+1} HZ_PER_SEC={1/(time/3)}
    M400

[gcode_macro _GUPPY_MACRO]
description: ===Custom Guppy button===
gcode:
    {% set client = printer['gcode_macro _CLIENT_VARIABLE'] | default({}) %}

    {% if client.ad5x %}
        COLOR
    {% else %}
        PLAY_MIDI
        RESPOND TYPE=command MSG="===action:prompt_begin This is a test macro==="
        RESPOND TYPE=command MSG="===action:prompt_text Add _GUPPY_MACRO to mod_data/user.cfg==="
        RESPOND TYPE=command MSG="===action:prompt_text Example of _GUPPY_MACRO is in mod/base.cfg==="

        RESPOND TYPE=command MSG="action:prompt_footer_button Ok|RESPOND TYPE=command MSG=action:prompt_end|info"
        RESPOND TYPE=command MSG="action:prompt_show"
    {% endif %}

[gcode_macro ZSHAPER]
description: ===Input shaper calibration===
gcode:
    {% set x = params.X|default(1)|int %}
    {% set y = params.Y|default(1)|int %}

    _G28
    _GOTO_MID
    {% if x == 1 %}
        RESPOND PREFIX="info" MSG="===Collecting X axis data==="
        TEST_RESONANCES AXIS=X NAME=X
        M400
    {% endif %}
    {% if y == 1 %}
        RESPOND PREFIX="info" MSG="===Collecting Y axis data==="
        TEST_RESONANCES AXIS=Y NAME=Y
        M400
    {% endif %}
    {% if x == 1 %}
        RUN_SHELL_COMMAND CMD=zshaper_new PARAMS="X"
    {% endif %}
    {% if y == 1 %}
        RUN_SHELL_COMMAND CMD=zshaper_new PARAMS="Y"
    {% endif %}

[gcode_macro _SPEED_SET]
description: ===Set 1/4->1/2->1 speed for 60s on print resume===
variable_speed1: 100
variable_speed2: 100
gcode:
    {% set zspeed = params.SPEED|default(100)|int %}
    RESPOND PREFIX="info" MSG="Speed0: {zspeed/4}"

    SET_GCODE_VARIABLE MACRO=_SPEED_SET VARIABLE=speed1 VALUE={zspeed/2}
    SET_GCODE_VARIABLE MACRO=_SPEED_SET VARIABLE=speed2 VALUE={zspeed}
    M220 S{zspeed/4}
    UPDATE_DELAYED_GCODE ID=_SET_SPEED1 DURATION=60
    UPDATE_DELAYED_GCODE ID=_SET_SPEED2 DURATION=120

[delayed_gcode _SET_SPEED1]
initial_duration: 0
gcode:
    {% set speed = printer["gcode_macro _SPEED_SET"].speed1 %}
    RESPOND PREFIX="info" MSG="Speed1: {speed}"
    M220 S{speed}

[delayed_gcode _SET_SPEED2]
initial_duration: 0
gcode:
    {% set speed = printer["gcode_macro _SPEED_SET"].speed2 %}
    RESPOND PREFIX="info" MSG="Speed2: {speed}"
    M220 S{speed}

[gcode_macro ZRESTORE]
description: ===Resume interrupted print===
gcode:
    {% set test = params.TEST|default(0)|int %}

    {% set state = printer.print_stats.state %}
    {% set filename = printer.print_stats.filename %}
    {% set progress = printer.display_status.progress * 100 %}

    {% if test == 2 %}
        RESPOND PREFIX="info" MSG="===Saved data deleted==="
        RUN_SHELL_COMMAND CMD=rm PARAMS="/opt/config/mod_data/klipper_data.json"
    {% else %}
        {% if test == 1 and state != 'printing' and state != 'paused' %}
            RUN_SHELL_COMMAND CMD=zrestore PARAMS="test"
        {% else %}
            {% if state == 'printing' %}
                RESPOND PREFIX="info" MSG="===Currently printing: {filename} ({progress | round(1)}%), print recovery impossible==="
            {% elif state == 'paused' %}
                RESPOND PREFIX="info" MSG="===Paused: {filename}, print recovery impossible==="
            {% elif state == 'complete' %}
                RESPOND PREFIX="info" MSG="===Print completed==="
                RUN_SHELL_COMMAND CMD=zrestore
            {% elif state == 'error' %}
                RESPOND PREFIX="info" MSG="===Error: {printer.print_stats.message}==="
                RUN_SHELL_COMMAND CMD=zrestore
            {% else %}
                RESPOND PREFIX="info" MSG="===Status: {state}==="
                RUN_SHELL_COMMAND CMD=zrestore
            {% endif %}
        {% endif %}
    {% endif %}

[delayed_gcode _TEST_RESTORE]
initial_duration: 0
gcode:
    ZRESTORE TEST=1

[gcode_macro _ZRESTORE]
gcode:
    RESPOND TYPE=command MSG="action:prompt_begin ===Interrupted print detected==="
    RESPOND TYPE=command MSG="action:prompt_text ===Switch to console to view recovery stages==="
    RESPOND TYPE=command MSG="action:prompt_button_group_start"
    RESPOND TYPE=command MSG="action:prompt_button ===Restore===|_ZRESTORE_OK|primary"
    RESPOND TYPE=command MSG="action:prompt_button ===Delete data===|_ZRESTORE_DEL|primary"
    RESPOND TYPE=command MSG="action:prompt_button_group_end"
    RESPOND TYPE=command MSG="action:prompt_footer_button ===Cancel===|_ZRESTORE_CANCEL"
    RESPOND TYPE=command MSG="action:prompt_show"

[gcode_macro _ZRESTORE_OK]
gcode:
    RESPOND TYPE=command MSG="action:prompt_end"
    ZRESTORE

[gcode_macro _ZRESTORE_DEL]
gcode:
    RESPOND TYPE=command MSG="action:prompt_end"
    ZRESTORE TEST=2

[gcode_macro _ZRESTORE_CANCEL]
gcode:
    RESPOND TYPE=command MSG="action:prompt_end"

[gcode_macro _ZRESTORE_MESH_TEST]
gcode:
    {% set cur_mesh = printer['bed_mesh'].profile_name %}
    {% set mesh = params.MESH|default("auto") %}
    {% set screen = printer["gcode_macro _SCREEN"].screen %}

    {% if cur_mesh != mesh %}
        {% if screen == True %}
            RESPOND PREFIX="info" MSG="===Bed mesh {mesh} not found. Loaded MESH_DATA profile==="
            BED_MESH_PROFILE LOAD=MESH_DATA
        {% else %}
            RESPOND PREFIX="info" MSG="===Bed mesh {mesh} not found. Loaded auto profile==="
            BED_MESH_PROFILE LOAD=auto
        {% endif %}
    {% endif %}

[gcode_macro _ZRESTORE_MESH_LOAD]
gcode:
    {% set mesh = params.MESH|default("auto") %}

    BED_MESH_CLEAR
    M400
    {% for mesh_dt in printer['bed_mesh'].profiles %}
        {% if mesh == mesh_dt %}
            BED_MESH_PROFILE LOAD={mesh}
            RESPOND PREFIX="info" MSG="===Bed mesh {mesh} loaded==="
        {% endif %}
    {% endfor %}
    _ZRESTORE_MESH_TEST MESH={mesh}

# Использование: SET_PAUSE_NEXT_LAYER [ENABLE=[0 | 1]] [MACRO=<name>]
[gcode_macro SET_PAUSE_NEXT_LAYER]
description: ===Enable pause at next layer===
gcode:
    {% set pause_next_layer = printer['gcode_macro SET_PRINT_STATS_INFO'].pause_next_layer %}
    {% set ENABLE = params.ENABLE | default(1)|int != 0 %}
    {% set MACRO = params.MACRO | default(pause_next_layer.call, True) %}
    SET_GCODE_VARIABLE MACRO=SET_PRINT_STATS_INFO VARIABLE=pause_next_layer VALUE="{{ 'enable': ENABLE, 'call': MACRO }}"

# Usage: SET_PAUSE_AT_LAYER [ENABLE=[0 | 1]] [LAYER=<number>] [MACRO=<name>]
[gcode_macro SET_PAUSE_AT_LAYER]
description: ===Enable/disable pause at specific layer===
gcode:
    {% set pause_at_layer = printer['gcode_macro SET_PRINT_STATS_INFO'].pause_at_layer %}
    {% set ENABLE = params.ENABLE | int != 0 if params.ENABLE is defined
             else params.LAYER is defined %}
    {% set LAYER = params.LAYER | default(pause_at_layer.layer) | int %}
    {% set MACRO = params.MACRO | default(pause_at_layer.call, True) %}
    SET_GCODE_VARIABLE MACRO=SET_PRINT_STATS_INFO VARIABLE=pause_at_layer VALUE="{{ 'enable': ENABLE, 'layer': LAYER, 'call': MACRO }}"

# Использование: SET_PRINT_STATS_INFO [TOTAL_LAYER=<total_layer_count>] [CURRENT_LAYER= <current_layer>]
[gcode_macro SET_PRINT_STATS_INFO]
rename_existing: SET_PRINT_STATS_INFO_BASE
description: ===Override to get pause_next_layer and pause_at_layer functions===
variable_pause_next_layer: { 'enable': False, 'call': "PAUSE" }
variable_pause_at_layer  : { 'enable': False, 'layer': 0, 'call': "PAUSE" }
gcode:
    {% if pause_next_layer.enable %}
        RESPOND TYPE=echo MSG='{"%s, SET_PAUSE_AT_LAYER " % pause_next_layer.call}'
        {pause_next_layer.call} ; execute the given gcode to pause, should be either M600 or PAUSE
        SET_PAUSE_NEXT_LAYER ENABLE=0
    {% elif pause_at_layer.enable and params.CURRENT_LAYER is defined and params.CURRENT_LAYER | int == pause_at_layer.layer %}
        RESPOND TYPE=echo MSG='{"%s, pause_at_layer [%d]" % (pause_at_layer.call, pause_at_layer.layer)}'
        {pause_at_layer.call} ; execute the given gcode to pause, should be either M600 or PAUSE
        SET_PAUSE_AT_LAYER ENABLE=0
    {% endif %}

    {% set notify_percent = printer.save_variables.variables['notify_percent']|default(0) | int %}
    {% if notify_percent > 0 %}
        _NOTIFY_ON_PERCENT
    {% endif %}
    SET_PRINT_STATS_INFO_BASE {rawparams}

[gcode_macro ZFLASH]
description: ===Update printer via USB===
gcode:
    RUN_SHELL_COMMAND CMD=zflash

[gcode_macro _DISABLE_SENSOR]
gcode:
    {% set client = printer['gcode_macro _CLIENT_VARIABLE'] | default({}) %}
    {% set screen = printer["gcode_macro _SCREEN"].screen %}

    {% if client.runout_sensor | default("") != "" %}
        {% if printer[client.runout_sensor].enabled %}
            SET_GCODE_VARIABLE MACRO=_ENABLE_SENSOR VARIABLE=allowed VALUE=True
            {% if client.ad5x %}
                _SET_FILAMENT_SENSOR SENSOR=head_switch_sensor ENABLE=0
            {% else %}
                _SET_FILAMENT_SENSOR SENSOR=e0_sensor ENABLE=0
            {% endif %}
        {% else %}
            SET_GCODE_VARIABLE MACRO=_ENABLE_SENSOR VARIABLE=allowed VALUE=False
        {% endif %}
    {% endif %}

    {% if client.runout_sensor2 | default("") != "" %}
        {% if screen == False and printer[client.runout_sensor2].enabled %}
            SET_GCODE_VARIABLE MACRO=_ENABLE_SENSOR VARIABLE=allowed2 VALUE=True
            _SET_FILAMENT_SENSOR SENSOR=ifs_motion_sensor ENABLE=0
        {% else %}
            SET_GCODE_VARIABLE MACRO=_ENABLE_SENSOR VARIABLE=allowed2 VALUE=False
        {% endif %}
    {% endif %}

[gcode_macro _ENABLE_SENSOR]
variable_allowed: False
variable_allowed2: False
gcode:
    {% set client = printer['gcode_macro _CLIENT_VARIABLE'] | default({}) %}
    {% set screen = printer["gcode_macro _SCREEN"].screen %}

    {% if allowed %}
        {% if client.ad5x %}
            _SET_FILAMENT_SENSOR SENSOR=head_switch_sensor ENABLE=1
        {% else %}
            _SET_FILAMENT_SENSOR SENSOR=e0_sensor ENABLE=1
        {% endif %}
    {% endif %}

    {% if screen == False and allowed2 %}
        _SET_FILAMENT_SENSOR SENSOR=ifs_motion_sensor ENABLE=1
    {% endif %}


[gcode_macro RESTORE_TAR_CONFIG]
description: ===Restore backup config files from archive===
gcode:
    RUN_SHELL_COMMAND CMD=zrestore_tar_config

[gcode_macro NOZZLE_CONTROL]
description: ===Detect part detachment or nozzle hit===
gcode:
    {% set we = params.WEIGHT|default(1500)|int %}

    RUN_SHELL_COMMAND CMD=znozzle PARAMS="{we}"

[gcode_macro RESET_PASSWD]
gcode:
    RUN_SHELL_COMMAND CMD=zreset_passwd

[gcode_macro _WIFI]
gcode:
    RUN_SHELL_COMMAND CMD=wifi

[gcode_macro SET_ACTIVE_SPOOL]
description: SpoolMan Set Active Spool
gcode:
  {% if params.ID %}
    {% set id = params.ID|int %}
    {action_call_remote_method(
       "spoolman_set_active_spool",
       spool_id=id
    )}
  {% else %}
    {action_respond_info("Parameter 'ID' is required")}
  {% endif %}

[gcode_macro CLEAR_ACTIVE_SPOOL]
description: SpoolMan Clear Active Spool
gcode:
  {action_call_remote_method(
    "spoolman_set_active_spool",
    spool_id=None
  )}

[gcode_macro ENABLE_EXTRA_PLUGINS]
gcode:
    RUN_SHELL_COMMAND CMD=enable_extra_plugins PARAMS="1"

[gcode_macro DISABLE_EXTRA_PLUGINS]
gcode:
    RUN_SHELL_COMMAND CMD=enable_extra_plugins PARAMS="0"

[gcode_macro ENABLE_PLUGIN]
gcode:
    {% set name = params.NAME|default("recommend")|string %}

    RUN_SHELL_COMMAND CMD=plugins PARAMS="{name} Enable"

[gcode_macro DISABLE_PLUGIN]
gcode:
    {% set name = params.NAME|default("recommend")|string %}

    RUN_SHELL_COMMAND CMD=plugins PARAMS="{name} Disable"

[gcode_macro SCREEN]
gcode:
    RUN_SHELL_COMMAND CMD=screen

[gcode_macro _CHECK_VERSION]
variable_klipper_ver: "NONE"
gcode:
    {% set ver = params.VER|default("NONE")|string %}
    {% if ver != "NONE" %}
        {% set klipper_ver = ver.split('-')[0:2]|join('-') %}
        SET_GCODE_VARIABLE MACRO=_CHECK_VERSION VARIABLE=klipper_ver VALUE="'{klipper_ver|string}'"
    {% endif %}

    {% set zklipper13 = printer.save_variables.variables['klipper13']|default(0) | int %}
    {% set version = printer.mcu.mcu_version %}
    {% set mcu_short = version.split('-')[0:2]|join('-') %}

    {% if zklipper13 == 1 and mcu_short != klipper_ver and klipper_ver != "NONE" %}
        RESPOND PREFIX="!!" MSG="===Incorrect MCU version. Need run UPDATE_MCU FORCE=13=== !! Klipper {klipper_ver} != MCU {mcu_short}"
    {% endif %}

[gcode_macro _RESET_SPEED]
gcode:
    {% set klipper13 = printer.save_variables.variables['klipper13']|default(0) | int %}

    M220 S100
    M221 S100

    SET_VELOCITY_LIMIT VELOCITY={printer.configfile.settings.printer.max_velocity}
    SET_VELOCITY_LIMIT ACCEL={printer.configfile.settings.printer.max_accel}
    SET_VELOCITY_LIMIT SQUARE_CORNER_VELOCITY={printer.configfile.settings.printer.square_corner_velocity}
    {% if klipper13 == 1 %}
        SET_VELOCITY_LIMIT ACCEL_TO_DECEL={printer.configfile.settings.printer.accell_to_decel}
    {% else %}
        SET_VELOCITY_LIMIT MINIMUM_CRUISE_RATIO={printer.configfile.settings.printer.minimum_cruise_ratio}
    {% endif %}

    {% if printer.configfile.settings.extruder is defined %}
        SET_PRESSURE_ADVANCE ADVANCE={printer.configfile.settings.extruder.pressure_advance|default(0)} SMOOTH_TIME={printer.configfile.settings.extruder.pressure_advance_smooth_time|default(0.04)}
    {% endif %}

    {% if printer.configfile.settings.firmware_retraction is defined %}
        SET_RETRACTION RETRACT_LENGTH={printer.configfile.settings.firmware_retraction.retract_length} UNRETRACT_EXTRA_LENGTH={printer.configfile.settings.firmware_retraction.unretract_extra_length} RETRACT_SPEED={printer.configfile.settings.firmware_retraction.retract_speed} UNRETRACT_SPEED={printer.configfile.settings.firmware_retraction.unretract_speed}
    {% endif %}

[gcode_macro LANG]
gcode:
    {% set lang = params.LANG|default("none") %}

    _LANG LANG={lang}

[gcode_macro _LANG]
gcode:
    {% set skip_lang = printer.save_variables.variables['skip_lang']|default(0) | int %}

    {% set skip = params.SKIP|default(1)|int %}
    {% set i = params.I|default(0)|int %}
    {% set lang = params.LANG|default("none") %}

    {% if skip == 1 %}
        {% if lang == "none" %}
            {% set show = 1 %}
        {% else %}
            {% set show = 0 %}
        {% endif %}
    {% else %}
        {% if skip_lang == 0 %}
            {% set show = 1 %}
        {% else %}
            {% set show = 0 %}
        {% endif %}
    {% endif %}

    {% if show == 1 %}
        RESPOND TYPE=command MSG="action:prompt_begin Select language"
        RESPOND TYPE=command MSG="action:prompt_text Select language"

        RESPOND TYPE=command MSG="action:prompt_button_group_start"
        RESPOND TYPE=command MSG="action:prompt_button EN|_LANG LANG=en I=1|primary"
        RESPOND TYPE=command MSG="action:prompt_button RU|_LANG LANG=ru I=1|primary"
        RESPOND TYPE=command MSG="action:prompt_button DE|_LANG LANG=de I=1|primary"
        RESPOND TYPE=command MSG="action:prompt_button_group_end"

        RESPOND TYPE=command MSG="action:prompt_button_group_start"
        RESPOND TYPE=command MSG="action:prompt_button FR|_LANG LANG=fr I=1|primary"
        RESPOND TYPE=command MSG="action:prompt_button IT|_LANG LANG=it I=1|primary"
        RESPOND TYPE=command MSG="action:prompt_button ES|_LANG LANG=es I=1|primary"
        RESPOND TYPE=command MSG="action:prompt_button_group_end"

        RESPOND TYPE=command MSG="action:prompt_button_group_start"
        RESPOND TYPE=command MSG="action:prompt_button CS|_LANG LANG=cs I=1|primary"
        RESPOND TYPE=command MSG="action:prompt_button PT|_LANG LANG=pt I=1|primary"
        RESPOND TYPE=command MSG="action:prompt_button TR|_LANG LANG=tr I=1|primary"
        RESPOND TYPE=command MSG="action:prompt_button_group_end"

        RESPOND TYPE=command MSG="action:prompt_button_group_start"
        RESPOND TYPE=command MSG="action:prompt_button JA|_LANG LANG=ja I=1|primary"
        RESPOND TYPE=command MSG="action:prompt_button KO|_LANG LANG=ko I=1|primary"
        RESPOND TYPE=command MSG="action:prompt_button ZH|_LANG LANG=zh I=1|primary"
        RESPOND TYPE=command MSG="action:prompt_button_group_end"

        RESPOND TYPE=command MSG="action:prompt_show"
    {% else %}
        {% if i == 1 %}
            SAVE_VARIABLE VARIABLE=skip_lang VALUE=1
            RESPOND TYPE=command MSG="action:prompt_end"
        {% endif %}
        {% if lang != "none" %}
            RUN_SHELL_COMMAND CMD=zlang PARAMS="{lang}"
        {% endif %}
    {% endif %}

[gcode_macro _SHOW_MSG]
gcode:
    {% set title = params.TITLE|default("===Initial setting===")|string %}
    {% set msg = params.MSG|default("Ok")|string %}
    {% set command = params.COMMAND|default("RESPOND TYPE=command MSG=action:prompt_end")|string %}
    {% set command_reboot = params.COMMAND_REBOOT|default("none")|string %}

    RESPOND TYPE=command MSG=action:prompt_end

    RESPOND TYPE=command MSG="action:prompt_begin {title}"
    RESPOND TYPE=command MSG="action:prompt_text {msg}"

    RESPOND TYPE=command MSG="action:prompt_footer_button OK|{command}|primary"
    {% if command_reboot != "none" %}
        RESPOND TYPE=command MSG="action:prompt_footer_button REBOOT|{command_reboot}|red"
    {% endif %}
    RESPOND TYPE=command MSG="action:prompt_show"

[gcode_macro _RECOMMEND]
gcode:
    {% set skip_global = printer.save_variables.variables['skip_global']|default(0) | int %}
    {% set skip_lang = printer.save_variables.variables['skip_lang']|default(0) | int %}
    {% set skip_recommend = printer.save_variables.variables['skip_recommend']|default(0) | int %}

    {% set close = params.CLOSE|default(0)|int %}
    {% set enable = params.ENABLE|default(0)|int %}

    {% if close == 1 %}
        RESPOND TYPE=command MSG=action:prompt_end
        SAVE_VARIABLE VARIABLE=skip_recommend VALUE=1
        {% if enable == 1 %}
            ENABLE_PLUGIN name=recommend
        {% endif %}
    {% else %}
        {% if skip_global == 1 and skip_lang == 1 and skip_recommend == 0 %}
            RESPOND TYPE=command MSG="action:prompt_begin ===Initial setting==="
            RESPOND TYPE=command MSG="action:prompt_text ===Enable the recommendations plugin? It allows you to configure basic settings with one click.==="
            RESPOND TYPE=command MSG="action:prompt_footer_button Yes|_RECOMMEND CLOSE=1 ENABLE=1|red"
            RESPOND TYPE=command MSG="action:prompt_footer_button No|_RECOMMEND CLOSE=1 ENABLE=0|primary"
            RESPOND TYPE=command MSG="action:prompt_show"
        {% endif %}
    {% endif %}

[gcode_macro GLOBAL]
description: ===Get ZMOD parameters===
gcode:
    _GLOBAL

[gcode_macro _GLOBAL_SAVE]
gcode:
    {% set param = params.PARAM|default("none")|string %}
    {% set reboot = params.REBOOT|default(0)|int %}

    {% if param != "none" %}
        SAVE_VARIABLE VARIABLE={param} VALUE=1
    {% endif %}
    {% if reboot == 1 %}
        REBOOT
    {% endif %}
    RESPOND TYPE=command MSG=action:prompt_end

[gcode_macro SET_FILAMENT_SENSOR]
rename_existing: _SET_FILAMENT_SENSOR
gcode:
    _SET_FILAMENT_SENSOR {% for p in params %}{'%s=%s '% (p, params[p])}{% endfor %}

    {% set sensor = params.SENSOR|default("none")|string %}
    {% set enable = params.ENABLE|default(2)|int %}

    {% if sensor != "none" and enable != 2 %}
        SAVE_VARIABLE VARIABLE={sensor} VALUE={enable}
    {% endif %}

[gcode_macro _NOTIFY]
gcode:

[gcode_macro _NOTIFY_ON_PERCENT]
variable_notified_percent: 0
variable_last_percent: 0
gcode:

[gcode_macro TAR_CONFIG]
description: ===Backup config files to archive===
gcode:
    RUN_SHELL_COMMAND CMD=screen
    RESPOND PREFIX="info" MSG="===Download archive in 'Configuration' -> 'mod_data' ->==="
    RUN_SHELL_COMMAND CMD=tar_config
    RESPOND PREFIX="info" MSG="===To restore the config, copy to 'Configuration' -> 'mod_data' -> config.tar.gz and call RESTORE_TAR_CONFIG==="

[gcode_macro _SAVE_CONFIG]
gcode:
    {% set znew_save_config = printer.save_variables.variables['new_save_config']|default(0) | int %}
    {% if znew_save_config == 1 %}
        NEW_SAVE_CONFIG
    {% else %}
        M400
        _ORIG_SAVE_CONFIG
    {% endif %}

[gcode_macro SAVE_CONFIG]
rename_existing: _ORIG_SAVE_CONFIG
gcode:
    M400
    _ORIG_SAVE_CONFIG

[gcode_macro _FIX_CLEAR]
gcode:
    {% set old_zclear = printer.save_variables.variables['zclear']|default("DISABLED")| string %}
    {% if old_zclear != "DISABLED" %}
        SAVE_VARIABLE VARIABLE=clear VALUE="\"{old_zclear}\""
        SAVE_VARIABLE VARIABLE=zclear VALUE="\"DISABLED\""
    {% else %}
        {% set macro_name = printer.save_variables.variables['clear']|default("LINE_PURGE")| string | lower %}
        {% set macro_key = "gcode_macro " + macro_name %}
        {% set macro_settings = printer.configfile.settings.get(macro_key) %}
        {% if macro_settings is none %}
            SAVE_VARIABLE VARIABLE=clear VALUE="\"LINE_PURGE\""
        {% endif %}
    {% endif %}
