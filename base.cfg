[zmod]
[include ../mod_data/lang.cfg]

[skew_correction]

[firmware_retraction]
retract_length: 0.7
retract_speed: 35
unretract_extra_length: 0
unretract_speed: 35

[include shell.cfg]
[include ff5.cfg]

[gcode_macro BED_MESH_CALIBRATE]
rename_existing: _BED_MESH_CALIBRATE
gcode:
    {% set zuse_kamp = printer.save_variables.variables.use_kamp|default(0) | int %}

    {% if zuse_kamp == 1 %}
        RESPOND PREFIX="info" MSG="===Using KAMP==="
        _KAMP_BED_MESH_CALIBRATE
    {% else %}
        RESPOND PREFIX="info" MSG="===Using BED_MESH_CALIBRATE==="
        _BED_MESH_CALIBRATE {rawparams}
    {% endif %}

[gcode_macro _HOME]
gcode:
    G28 Z
    M400
    G28 X
    M400
    G28 Y
    M400

[gcode_macro _G28]
gcode:
    {% if "xyz" not in printer.toolhead.homed_axes %}
        _HOME
    {% endif %}


[gcode_macro CHECK_MD5]
description: ===File MD5 sum check===
gcode:
  {% if 'FILENAME' in params %}
    {% set filename = params.FILENAME|default("")|string %}
  {% else %}
    {% set filename = printer.virtual_sdcard.file_path|default("")|string  %}
  {% endif %}

  SAVE_VARIABLE VARIABLE=check_md5 VALUE={0|int}

  {% if filename != "" %}

    {% if 'DELETE' in params %}
      {% set delete = params.DELETE|default("False")|string %}
    {% endif %}

    RUN_SHELL_COMMAND CMD=check_md5 PARAMS={'"%s %s"' % (filename.replace("'", "\\\'").replace(" ", "\ "), delete)}
    {% for i in range(30) %}
        ZLOAD_VARIABLE
        _CHECK_MD5
    {% endfor %}

    ZLOAD_VARIABLE
    _FINAL_CHECK_MD5 FILENAME="{filename}"

  {% endif %}

[gcode_macro _CHECK_MD5]
description: ===Waiting for check to complete===
gcode:
    {% set check_md5 = printer.save_variables.variables.check_md5|default(0) | int %}

    {% if (check_md5 == 0) %}
        G4 P{1000}
    {% endif %}

[gcode_macro _FINAL_CHECK_MD5]
description: ===Final test===
gcode:
    {% set client = printer['gcode_macro _CLIENT_VARIABLE'] | default({}) %}
    {% set filename = params.FILENAME|default("")|string %}
    {% set check_md5 = printer.save_variables.variables.check_md5|default(0) | int %}

    {% if (check_md5 == 0) %}
        RESPOND TYPE=error MSG="===Error: File '{filename}' was not verified in time. Print canceled.==="
        CANCEL_PRINT
        _FINAL_STOP_MD5
    {% endif %}
    {% if (check_md5 == 1) %}
        RESPOND TYPE=error MSG="===Error: File '{filename}' not specified. Print canceled.==="
        CANCEL_PRINT
        _FINAL_STOP_MD5
    {% endif %}
    {% if (check_md5 == 2) %}
        RESPOND TYPE="error" MSG="===Error: File {filename} not found. Print canceled.==="
        CANCEL_PRINT
        _FINAL_STOP_MD5
    {% endif %}
    {% if (check_md5 == 3) %}
        RESPOND TYPE="error" MSG="===File {filename} has no MD5 checksum. Enable it in Orca. https://github.com/ghzserg/zmod/wiki/Recomendations_en==="
    {% endif %}
    {% if (check_md5 == 4) %}
        {% if not client.ff5x %}
            RESPOND TYPE="error" MSG="===File {filename} contains arc commands (G2, G3). Disable them. In Orca: Process Profile -> Arc Approximation -> Uncheck==="
            RESPOND PREFIX="info" MSG="===Replace Spiral/Auto Z-Hop. In Orca: Printer Profile -> Extruder 1 -> Z Hop Type -> Set to Normal or Sloped==="
        {% endif %}
        RESPOND PREFIX="info" MSG="===File {filename} verified successfully. MD5 checksum matches.==="
    {% endif %}
    {% if (check_md5 == 8) %}
        {% if not client.ff5x %}
            RESPOND TYPE="error" MSG="===File {filename} uses unsupported G17/G18/G19 commands. Replace Z-Hop type.==="
            RESPOND PREFIX="info" MSG="===In Orca: Printer Profile -> Extruder 1 -> Z Hop Type -> Set to Normal or Sloped==="
        {% endif %}
        RESPOND PREFIX="info" MSG="===File {filename} verified successfully. MD5 checksum matches.==="
    {% endif %}
    {% if (check_md5 == 5) %}
        RESPOND PREFIX="info" MSG="===File {filename} verified successfully. MD5 checksum matches.==="
    {% endif %}
    {% if (check_md5 == 6) %}
        RESPOND TYPE="error" MSG="===File {filename} MD5 mismatch. File deleted. Print canceled==="
        CANCEL_PRINT
        _FINAL_STOP_MD5
    {% endif %}
    {% if (check_md5 == 7) %}
        RESPOND TYPE="error" MSG="===File {filename} MD5 mismatch. Print canceled==="
        CANCEL_PRINT
        _FINAL_STOP_MD5
    {% endif %}

[gcode_macro _FINAL_STOP_MD5]
gcode:
    {action_raise_error("===MD5 check failed. Print canceled.===")}

[gcode_macro BED_LEVEL_SCREWS_TUNE]
description: ===Bed screw calibration===
gcode:
    {% set extruder_temp = params.EXTRUDER_TEMP|default(130)|float %}
    {% set bed_temp = params.BED_TEMP|default(80)|float %}

    RESPOND PREFIX="info" MSG="===Before measurements, don't forget to clean the nozzle with CLEAR_NOZZLE macro==="

    BED_MESH_CLEAR
    SET_HEATER_TEMPERATURE HEATER=extruder TARGET={extruder_temp}
    SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={bed_temp}
    TEMPERATURE_WAIT SENSOR=heater_bed  MINIMUM={bed_temp-2} MAXIMUM={bed_temp+3}
    TEMPERATURE_WAIT SENSOR=extruder  MINIMUM={extruder_temp-2} MAXIMUM={extruder_temp+3}

    _HOME

    LOAD_CELL_TARE

    SCREWS_TILT_CALCULATE

[gcode_macro _FULL_BED_LEVEL]
description: ===Bed calibration without temperature off===
gcode:
    {% set extruder_temp = params.EXTRUDER_TEMP|default(240)|float %}
    {% set bed_temp = params.BED_TEMP|default(80)|float %}
    {% set profile = params.PROFILE|default("auto") %}


    RESPOND PREFIX="info" MSG="===Bed calibration. Profile {profile}. Extruder temp: {extruder_temp} / Bed temp: {bed_temp}==="

    BED_MESH_CLEAR          ; Очистка профиля стола
    M400

    CLEAR_NOZZLE EXTRUDER_TEMP={extruder_temp} BED_TEMP={bed_temp}

    # Начинаем калибровку
    _BED_MESH_CALIBRATE PROFILE="{profile}"

    _UGOL_PARK

[gcode_macro AUTO_FULL_BED_LEVEL]
description: ===Bed calibration with temperature off===
gcode:
    {% set extruder_temp = params.EXTRUDER_TEMP|default(240)|float %}
    {% set bed_temp = params.BED_TEMP|default(80)|float %}
    {% set profile = params.PROFILE|default("auto") %}

    _FULL_BED_LEVEL EXTRUDER_TEMP={extruder_temp} BED_TEMP={bed_temp} PROFILE={profile}

    # Выклчюаем обогрев
    _STOP

[include ./KAMP/KAMP_Settings.cfg]

[gcode_macro KAMP]
description: ===Adaptive bed===
gcode:
    {% set extruder_temp = params.EXTRUDER_TEMP|default(240)|float %}
    {% set bed_temp = params.BED_TEMP|default(80)|float %}

    BED_MESH_CLEAR          ; Очистка профиля стола
    M400

    CLEAR_NOZZLE EXTRUDER_TEMP={extruder_temp} BED_TEMP={bed_temp}

    _KAMP_BED_MESH_CALIBRATE

    _SMART_PARK

    M190 S{bed_temp}
    M109 S{extruder_temp}

# Калибровка PID экструдера
[gcode_macro PID_TUNE_EXTRUDER]
description: ===Extruder PID calibration===
gcode:
    {% set temperature = params.TEMPERATURE|default(245) %}
    {% set cooler = params.COOLER|default(255) %}
    {% set client = printer['gcode_macro _CLIENT_VARIABLE'] | default({}) %}

    _HOME

    G1 X{client.min_x+(client.max_x-client.min_x)/2} Y{client.min_y+(client.max_y-client.min_y)/2}

    M106 P0 S{cooler}
    PID_CALIBRATE HEATER=extruder TARGET={temperature}
    {% set znew_save_config = printer.save_variables.variables.new_save_config|default(0) | int %}
    {% if znew_save_config == 1 %}
        NEW_SAVE_CONFIG
    {% else %}
        SAVE_CONFIG
    {% endif %}

[gcode_macro LOAD_FILAMENT]
variable_load_distance:  125
gcode:
    {% set max_velocity = printer.configfile.settings['extruder'].max_extrude_only_velocity  * 60 %}

    {% set m600_temp = printer["gcode_macro M600"].zextruder_temp|float %}

    {% set extruder_temp = params.EXTRUDER_TEMP|default(m600_temp) | float %}
    {% set extrude_len   = params.EXTRUDE_LEN|default(load_distance) |float %}
    {% set speed = params.SPEED|default(450)|float %}

    RESPOND PREFIX="info" MSG="===Loading filament at {extruder_temp} for {extrude_len}mm at {speed/60} mm/s==="
    M104 S{extruder_temp}
    TEMPERATURE_WAIT SENSOR=extruder MINIMUM={extruder_temp-1}

    SAVE_GCODE_STATE NAME=load_state
    G91
    G92 E0

    _DISABLE_SENSOR
        G1 E{extrude_len} F{speed} ; extrude with 7.5mm/s
        M400
    _ENABLE_SENSOR

    RESTORE_GCODE_STATE NAME=load_state

[gcode_macro UNLOAD_FILAMENT]
variable_unload_distance:  75
gcode:
    {% set speed = params.SPEED|default(450) %}

    {% set extruder_temp = printer["gcode_macro M600"].zextruder_temp|float %}
    M104 S{extruder_temp}
    TEMPERATURE_WAIT SENSOR=extruder MINIMUM={extruder_temp}

    SAVE_GCODE_STATE NAME=unload_state
    G91
    G92 E0

    _DISABLE_SENSOR
        G1 E-{unload_distance} F{speed} ; unload
        M400
    _ENABLE_SENSOR

    RESTORE_GCODE_STATE NAME=unload_state

[gcode_macro PURGE_FILAMENT]
variable_purge_distance:  25
gcode:
    {% set speed = params.SPEED|default(450) %}

    {% set extruder_temp = printer["gcode_macro M600"].zextruder_temp|float %}
    M104 S{extruder_temp}
    TEMPERATURE_WAIT SENSOR=extruder MINIMUM={extruder_temp}

    SAVE_GCODE_STATE NAME=purge_state
    G91
    G92 E0

    _DISABLE_SENSOR
        G1 E{purge_distance} F{speed}   ; purge
        M400
    _ENABLE_SENSOR

    RESTORE_GCODE_STATE NAME=purge_state

[gcode_macro LOAD_MATERIAL]
description: ===Manual filament loading / change===
variable_initial_target_temp: 0
gcode:
    # save gcode state
    SAVE_GCODE_STATE NAME=load_material_state
    # save heating state
    SET_GCODE_VARIABLE MACRO=LOAD_MATERIAL VARIABLE=initial_target_temp VALUE={printer["extruder"].target}

    _LOAD_MATERIAL_SELECT

[gcode_macro _LOAD_MATERIAL_SELECT]
gcode:
    {% if not printer["extruder"].target >= printer.configfile.settings['extruder'].min_extrude_temp %}
        RESPOND TYPE=command MSG="action:prompt_begin ===Material selection==="
        RESPOND TYPE=command MSG="action:prompt_text ===Select material to load==="
        RESPOND TYPE=command MSG="action:prompt_button_group_start"
        RESPOND TYPE=command MSG="action:prompt_button PLA|_LOAD_MATERIAL_HEATUP TEMP=210|primary"
        RESPOND TYPE=command MSG="action:prompt_button PETG|_LOAD_MATERIAL_HEATUP TEMP=240|primary"
        RESPOND TYPE=command MSG="action:prompt_button ABS|_LOAD_MATERIAL_HEATUP TEMP=250|primary"
        RESPOND TYPE=command MSG="action:prompt_button_group_end"
        RESPOND TYPE=command MSG="action:prompt_footer_button ===Cancel===|_LOAD_MATERIAL_END"
        RESPOND TYPE=command MSG="action:prompt_show"
    {% else %}
        TEMPERATURE_WAIT SENSOR=extruder MINIMUM={printer["extruder"].target}
        _LOAD_MATERIAL_ACTION
    {% endif %}

[gcode_macro _LOAD_MATERIAL_HEATUP]
gcode:
    {% set extruder_temp = params.TEMP|default(200)|float %}
    M104 S{extruder_temp}
    RESPOND TYPE=command MSG=action:prompt_end
    TEMPERATURE_WAIT SENSOR=extruder MINIMUM={extruder_temp}
    _LOAD_MATERIAL_ACTION

[gcode_macro _LOAD_MATERIAL_ACTION]
gcode:
    RESPOND TYPE=command MSG="action:prompt_begin ===Filament management==="
    RESPOND TYPE=command MSG="action:prompt_text ===Select action==="
    RESPOND TYPE=command MSG="action:prompt_button_group_start"
    RESPOND TYPE=command MSG="action:prompt_button ===Load===|LOAD_FILAMENT|primary"
    RESPOND TYPE=command MSG="action:prompt_button ===Unload===|UNLOAD_FILAMENT|primary"
    RESPOND TYPE=command MSG="action:prompt_button ===Purge===|PURGE_FILAMENT|primary"
    RESPOND TYPE=command MSG="action:prompt_button_group_end"
    RESPOND TYPE=command MSG="action:prompt_footer_button ===OK===|_LOAD_MATERIAL_END"
    RESPOND TYPE=command MSG="action:prompt_show"

[gcode_macro _LOAD_MATERIAL_END]
gcode:
    RESPOND TYPE=command MSG="action:prompt_end"
    # restore old temp
    M104 S{printer["gcode_macro LOAD_MATERIAL"].initial_target_temp}
    # restore gcode state
    RESTORE_GCODE_STATE NAME=load_material_state

[gcode_macro M600]
description: ===Pause and filament change===
variable_zextruder_temp: 240.0
gcode:
    {% set extruder_temp = printer[printer.toolhead.extruder].target if printer.toolhead.extruder != '' else 240.0 %}
    SET_GCODE_VARIABLE MACRO=M600 VARIABLE=zextruder_temp VALUE={extruder_temp|float}

    RESPOND PREFIX="info" MSG="===Nozzle temperature {extruder_temp}==="

    PAUSE

    RESPOND TYPE=command MSG="action:prompt_begin ===Filament Change==="
    RESPOND TYPE=command MSG="action:prompt_text ===Filament change requested. Load new filament and click 'Resume'.==="
    RESPOND TYPE=command MSG="action:prompt_button_group_start"
    RESPOND TYPE=command MSG="action:prompt_button ===Load===|LOAD_FILAMENT|primary"
    RESPOND TYPE=command MSG="action:prompt_button ===Unload===|UNLOAD_FILAMENT|primary"
    RESPOND TYPE=command MSG="action:prompt_button ===Purge===|PURGE_FILAMENT|primary"
    RESPOND TYPE=command MSG="action:prompt_button_group_end"
    RESPOND TYPE=command MSG="action:prompt_footer_button ===Resume===|_INTERACTIVE_LOAD_END"
    RESPOND TYPE=command MSG="action:prompt_show"

[gcode_macro _INTERACTIVE_LOAD_END]
gcode:
    RESPOND TYPE=command MSG="action:prompt_end"
    RESUME

[gcode_macro _SHUTDOWN]
variable_trigger_allowed: False
gcode:
    {% set client = printer['gcode_macro _CLIENT_VARIABLE'] | default({}) %}

    {% if trigger_allowed %}
        {% if not client.ff5x %}
            SET_PIN PIN=clear_power_off VALUE=1
            G4 P500
            SET_PIN PIN=clear_power_off VALUE=0
        {% endif %}
        RESPOND TYPE=command MSG="action:prompt_begin ===Shutdown printer?==="
        RESPOND TYPE=command MSG="action:prompt_text ===Shutdown printer?==="
        RESPOND TYPE=command MSG="action:prompt_button_group_start"
        RESPOND TYPE=command MSG="action:prompt_button ===Yes===|SHUTDOWN|primary"
        RESPOND TYPE=command MSG="action:prompt_button_group_end"
        RESPOND TYPE=command MSG="action:prompt_footer_button ===Cancel===|RESPOND TYPE=command MSG=action:prompt_end"
        RESPOND TYPE=command MSG="action:prompt_show"
    {% endif %}

[gcode_macro SHUTDOWN]
description: ===Power off printer===
gcode:
    {% set client = printer['gcode_macro _CLIENT_VARIABLE'] | default({}) %}

    RESPOND TYPE=command MSG="action:prompt_end"
    BED_MESH_CLEAR
    M400
    {% if not client.ff5x %}
        # Reset button state, otherwise only one trigger can occur
        SET_PIN PIN=clear_power_off VALUE=1
        # There is a deboucing circuit which needs some delay
        G4 P500
        # Disable pin again otherwise on reset the button will be triggered 1-3 times
        SET_PIN PIN=clear_power_off VALUE=0
    {% endif %}
    RUN_SHELL_COMMAND CMD=run_power_off
    RUN_SHELL_COMMAND CMD=sync
    G4 P1000
    RUN_SHELL_COMMAND CMD=sync
    G4 P1000
    {% if not client.ff5x %}
        SET_PIN PIN=power_off VALUE=0
    {% endif %}
    RUN_SHELL_COMMAND CMD=poweroff

[gcode_macro REBOOT]
description: ===Reboot printer===
gcode:
    {% set client = printer['gcode_macro _CLIENT_VARIABLE'] | default({}) %}

    BED_MESH_CLEAR
    M400
    {% if not client.ff5x %}
        # Reset button state, otherwise only one trigger can occur
        SET_PIN PIN=clear_power_off VALUE=1
        # There is a deboucing circuit which needs some delay
        G4 P500
        # Disable pin again otherwise on reset the button will be triggered 1-3 times
        SET_PIN PIN=clear_power_off VALUE=0
    {% endif %}
    RUN_SHELL_COMMAND CMD=sync
    G4 P1000
    RUN_SHELL_COMMAND CMD=sync
    G4 P1000
    RUN_SHELL_COMMAND CMD=reboot

[gcode_macro REMOVE_ZMOD]
description: ===Remove zmod===
gcode:
    {% set full = params.FULL|default(0)|int %}
    CLEAR_EMMC

    {% if full == 1 %}
        RUN_SHELL_COMMAND CMD=ztouch PARAMS="/opt/config/mod/FULL_REMOVE"
    {% else %}
        RUN_SHELL_COMMAND CMD=ztouch PARAMS="/opt/config/mod/REMOVE"
    {% endif %}

    RUN_SHELL_COMMAND CMD=sync
    RUN_SHELL_COMMAND CMD=reboot

[gcode_macro SKIP_ZMOD]
description: ===Reboot to original system (no zmod)===
gcode:
    {% set mute = params.MUTE|default(0)|int %}

    {% if mute == 0 %}
        RESPOND TYPE=command MSG="action:prompt_begin ===Temporary ZMOD disable==="
        RESPOND TYPE=command MSG="action:prompt_text ===After clicking OK the printer will be powered off==="
        RESPOND TYPE=command MSG="action:prompt_text ===You need to disconnect power cord and then reconnect it==="
        RESPOND TYPE=command MSG="action:prompt_text ===Printer will boot into stock firmware==="
        RESPOND TYPE=command MSG="action:prompt_footer_button ===OK===|SKIP_ZMOD MUTE=1"
        RESPOND TYPE=command MSG="action:prompt_show"
    {% else %}
        RESPOND TYPE=command MSG="action:prompt_end"
        RUN_SHELL_COMMAND CMD=ztouch PARAMS="/opt/config/mod/SKIP_ZMOD"
        RUN_SHELL_COMMAND CMD=sync
        RUN_SHELL_COMMAND CMD=poweroff
    {% endif %}

[gcode_macro LED_ON]
description: ===Enable backlight===
gcode:
    SET_LED LED=chamber_led WHITE=1

[gcode_macro LED_OFF]
description: ===Disable backlight===
gcode:
    SET_LED LED=chamber_led WHITE=0

[gcode_macro LED]
description: ===Enable backlight===
gcode:
    {% set S = params.S|default(50)|int %}
    SET_LED LED=chamber_led WHITE={S/100|float}

[gcode_macro DISPLAY_ON]
description: ===Enable stock screen and reboot===
gcode:
    SAVE_VARIABLE VARIABLE=display_off VALUE=0
    RUN_SHELL_COMMAND CMD=zdisplay PARAMS="on"

[gcode_macro DISPLAY_OFF]
description: ===Disable stock screen===
gcode:
    {% set guppy = params.GUPPY|default(1)|int %}
    {% set load_zoffset = printer.save_variables.variables.load_zoffset|default(0) | int %}

    SAVE_VARIABLE VARIABLE=display_off VALUE=1
    RESPOND PREFIX="info" MSG="===Do not disable display if you don't fully understand bed leveling, z-offset and START_PRINT/END_PRINT macros==="
    RESPOND PREFIX="info" MSG="===https://github.com/ghzserg/zmod/wiki/FAQ_en==="

    {% if guppy == 1 %}
        RESPOND PREFIX="info" MSG="===Loading GuppyScreen==="
        {% if load_zoffset == 0 %}
            RESPOND PREFIX="info" MSG="===Use Z-OFFSET loading from global parameters to control Z-OFFSET with GuppyScreen==="
            RESPOND PREFIX="info" MSG="SAVE_ZMOD_DATA LOAD_ZOFFSET=1"
        {% endif %}
        RUN_SHELL_COMMAND CMD=zdisplay PARAMS="guppy"
        SAVE_VARIABLE VARIABLE=guppy VALUE={1|int}
    {% else %}
        RUN_SHELL_COMMAND CMD=zdisplay PARAMS="off"
        SAVE_VARIABLE VARIABLE=guppy VALUE={0|int}
    {% endif %}
    RESTART

[gcode_macro MEM]
description: ===Check memory usage===
gcode:
    RUN_SHELL_COMMAND CMD=zmem

[gcode_macro PLAY_MIDI]
description: ===Play MIDI file===
variable_mute: 0
gcode:
    {% if mute == 0 %}
        {% set FILE = params.FILE|default("For_Elise.mid")|string %}
        RUN_SHELL_COMMAND CMD=audio_midi PARAMS="{FILE}"
    {% endif %}

[gcode_macro MUTE]
description: ===Mute sound===
gcode:
    {% set mute = params.MUTE|default(1)|int %}
    SET_GCODE_VARIABLE MACRO=PLAY_MIDI VARIABLE=mute VALUE={mute}

[gcode_macro CAMERA_ON]
description: ===Use alternative camera===
gcode:
    {% set client = printer['gcode_macro _CLIENT_VARIABLE'] | default({}) %}
    {% set WIDTH  = params.WIDTH|default(640)|int %}
    {% set HEIGHT = params.HEIGHT|default(480)|int %}
    {% set FPS    = params.FPS|default(20)|int %}
    {% set VIDEO  = params.VIDEO|default(client.video)|string %}
    {% set FS    = params.FS|default(0)|int %}

    RESPOND PREFIX="info" MSG="===Disable camera on printer screen==="

    RUN_SHELL_COMMAND CMD=zcamera PARAMS="on {WIDTH} {HEIGHT} {FPS} {VIDEO} {FS} RESTART"

[gcode_macro CAMERA_OFF]
description: ===Disable alternative camera===
gcode:
    RESPOND PREFIX="info" MSG="===Enable camera on printer screen==="

    {% set WIDTH  = params.WIDTH|default(640)|int %}
    {% set HEIGHT = params.HEIGHT|default(480)|int %}
    {% set FPS    = params.FPS|default(20)|int %}
    {% set VIDEO  = params.VIDEO|default("video0")|string %}
    {% set FS    = params.FS|default(0)|int %}

    RUN_SHELL_COMMAND CMD=zcamera PARAMS="off {WIDTH} {HEIGHT} {FPS} {VIDEO} {FS} RESTART"

[gcode_macro CAMERA_RESTART]
description: ===Restart alternative camera===
gcode:
    RUN_SHELL_COMMAND CMD="s99camera" PARAMS="restart"

[gcode_macro DATE_GET]
description: ===Check time===
gcode:
    {% set DT  = params.DT|default("")|string %}
    RUN_SHELL_COMMAND CMD=date

[gcode_macro DATE_SET]
description: ===Set date and time (format: 2024.01.01-00:00:00)===
gcode:
    {% set DT  = params.DT|default("2024.01.01-00:00:00")|string %}
    RUN_SHELL_COMMAND CMD=date PARAMS="date {DT}"

[gcode_macro WEB]
description: ===Switch web interface (fluidd/mainsail)===
gcode:
    {% set mute = params.MUTE|default(0)|int %}

    {% if mute == 0 %}
        RESPOND TYPE=command MSG="action:prompt_begin ===After macro execution press Ctrl + F5==="
        RESPOND TYPE=command MSG="action:prompt_text ===After macro execution press Ctrl + F5==="
        RESPOND TYPE=command MSG="action:prompt_footer_button OK|WEB MUTE=1"
        RESPOND TYPE=command MSG="action:prompt_show"
    {% else %}
        RESPOND TYPE=command MSG="action:prompt_end"
        RUN_SHELL_COMMAND CMD=zhttp
    {% endif %}

[gcode_macro _STOP]
description: ===Disable heating and cooler===
gcode:
    M400
    M220 S100               ; Скорость 100%
    M221 S100               ; Экструзия 100%
    M140 S0                 ; Отключить нагрев стола
    M104 S0                 ; Отключить нагрев экструдера
    M106 S0                 ; Отключить кулер
    M107                    ; Отключить кулер экструдера
    SET_SKEW CLEAR=1        ; reset skew profile if loaded

    {% set zmidi_end = printer.save_variables.variables.midi_end|default("") | string %}
    {% if zmidi_end != "" %}
        PLAY_MIDI FILE={zmidi_end}
    {% endif %}
    EXCLUDE_OBJECT_DEFINE RESET=1
    SAVE_VARIABLE VARIABLE=check_md5 VALUE={0|int}

    RUN_SHELL_COMMAND CMD=znice

    {% set profile_name = printer.bed_mesh.profile_name %}
    {% if profile_name == "default" %}
        BED_MESH_CLEAR
        BED_MESH_PROFILE REMOVE=default
    {% endif %}

    ZCONTROL_OFF

    RESPOND PREFIX="info" MSG="===Work completed==="

[gcode_macro CHECK_SYSTEM]
description: ===OS check===
gcode:
    {% set restore = params.RESTORE|default(0)|int %}

    {% if restore == 1 %}
        RUN_SHELL_COMMAND CMD=zcheckmd5 PARAMS="restore"
    {% else %}
        RUN_SHELL_COMMAND CMD=zcheckmd5 PARAMS="not_restore"
    {% endif %}

[gcode_macro SET_TIMEZONE]
description: ===Timezone change===
gcode:
    {% set client = printer['gcode_macro _CLIENT_VARIABLE'] | default({}) %}

    {% set ZONE  = params.ZONE|default("Europe/Moscow")|string %}
    RESPOND PREFIX="info" MSG="Europe/"
    {% if not client.ff5x %}
        RUN_SHELL_COMMAND CMD=ls PARAMS="/usr/share/zoneinfo/Europe"
    {% else %}
        RUN_SHELL_COMMAND CMD=ls PARAMS="/usr/data/.mod/.zmod/usr/share/zoneinfo/Europe"
    {% endif %}
    RESPOND PREFIX="info" MSG="Asia/"
    {% if not client.ff5x %}
        RUN_SHELL_COMMAND CMD=ls PARAMS="/usr/share/zoneinfo/Asia"
    {% else %}
        RUN_SHELL_COMMAND CMD=ls PARAMS="/usr/data/.mod/.zmod/usr/share/zoneinfo/Asia"
    {% endif %}
    RESPOND PREFIX="info" MSG="Use SET_TIMEZONE ZONE=Asia/Yekaterinburg"
    RUN_SHELL_COMMAND CMD=rm PARAMS="/etc/localtime"
    {% if not client.ff5x %}
        RUN_SHELL_COMMAND CMD=ln PARAMS="-s /usr/share/zoneinfo/{ZONE} /etc/localtime"
    {% else %}
        RUN_SHELL_COMMAND CMD=ln PARAMS="-s /usr/data/.mod/.zmod/usr/share/zoneinfo/{ZONE} /etc/localtime"
        RUN_SHELL_COMMAND CMD=rm PARAMS="/usr/data/.mod/.zmod/etc/localtime"
        RUN_SHELL_COMMAND CMD=ln PARAMS="-s /usr/share/zoneinfo/{ZONE} /usr/data/.mod/.zmod/etc/localtime"
    {% endif %}
    RUN_SHELL_COMMAND CMD=date

[gcode_macro STOP_ZMOD]
description: ===Stop fluidd/mainsail and moonraker===
gcode:
    RUN_SHELL_COMMAND CMD=stop_zmod PARAMS="stop"

[gcode_macro START_ZMOD]
description: ===Start fluidd/mainsail and moonraker after STOP_ZMOD===
gcode:
    RUN_SHELL_COMMAND CMD=stop_zmod PARAMS="up"

[gcode_macro TEST_EMMC]
description: ===Test EMMC===
gcode:
    {% set size    = params.SIZE|default(400)|int %}
    {% set sync    = params.SYNC|default(1)|int %}
    {% set flash   = params.FLASH|default(0)|int %}
    {% set random  = params.RANDOM|default(0)|int %}

    RUN_SHELL_COMMAND CMD=zfs PARAMS="{size} {sync} {flash} {random}"

[gcode_macro CLEAR_EMMC]
description: ===Clear EMMC===
gcode:
    {% set log    = params.LOG|default(1)|int %}
    {% set any    = params.ANY|default(0)|int %}

    RUN_SHELL_COMMAND CMD=zclear PARAMS="{log} {any}"

[gcode_macro ZSSH_ON]
description: ===Redirect moonraker and camera to SSH server===
gcode:
    {% set ssh_server  = params.SSH_SERVER|default("127.0.0.1")|string %}
    {% set ssh_port    = params.SSH_PORT|default(22)|int %}
    {% set ssh_user    = params.SSH_USER|default("user")|string %}
    {% set video_port  = params.VIDEO_PORT|default(8080)|int %}
    {% set moon_port   = params.MOON_PORT|default(7125)|int %}
    {% set remote_run  = params.REMOTE_RUN|default("NONE")|string %}
    RUN_SHELL_COMMAND CMD=zssh PARAMS="START {ssh_server} {ssh_port} {ssh_user} {video_port} {moon_port} '{remote_run}' RESTART"

[gcode_macro ZSSH_OFF]
description: ===Disable SSH port forwarding===
gcode:
    RUN_SHELL_COMMAND CMD=zssh PARAMS="STOP 127.0.0.1 22 user 8080 7125 NONE RESTART"

[gcode_macro ZSSH_RESTART]
description: ===SSH restart===
gcode:
    RUN_SHELL_COMMAND CMD=zssh PARAMS="RESTART 127.0.0.1 22 user 8080 7125 NONE RESTART"

[gcode_macro ZSSH_RELOAD]
description: ===Start SSH if not running===
gcode:
    {% set screen = printer["gcode_macro START_PRINT"].screen %}

    {% if screen == True %}
        RESPOND PREFIX="info" MSG="===You are using native screen==="
    {% else %}
        RESPOND PREFIX="info" MSG="===You are NOT using native screen==="
    {% endif %}

    {% set zklipper12 = printer.save_variables.variables.klipper12|default(0) | int %}
    {% if zklipper12 == 1 %}
        RESPOND PREFIX="//" MSG="===Using Klipper 12==="
    {% else %}
        RESPOND PREFIX="//" MSG="===Using native Klipper==="
    {% endif %}

    RUN_SHELL_COMMAND CMD=zssh PARAMS="RELOAD 127.0.0.1 22 user 8080 7125 NONE RESTART"

[gcode_macro _MESH_TEST]
description: ===Compare grid extremes with last probe===
gcode:
    {% set profile_name = printer.bed_mesh.profile_name %}
    {% set mesh = printer.bed_mesh.profiles[profile_name] %}

    {% if mesh %}
        _MESH_PROBE
        _MESH_COMPARE
    {% else %}
        {action_respond_info("===WARNING: Bed mesh not loaded!===")}
    {% endif %}

[gcode_macro _MESH_PROBE]
gcode:
    {% set client = printer['gcode_macro _CLIENT_VARIABLE'] | default({}) %}

    _G28
    {% if printer.firmware_retraction is defined %}
        {% set RETRACT = G10 | string %}
        {% set UNRETRACT = G11 | string %}
    {% else %}
        {% set RETRACT = 'G1 E-.5 F2100' | string %}
        {% set UNRETRACT = 'G1 E.5 F2100' | string %}
    {% endif %}

    {% if printer.toolhead.position.y < client.min_y or printer.toolhead.position.y > client.max_y %}
        G1 Y{client.custom_park_y} F2000
        M400
    {% endif %}
    {% if printer.toolhead.position.x < client.min_x or printer.toolhead.position.x > client.max_x %}
        G1 X{client.custom_park_x} F2000
        M400
    {% endif %}

    G92 E0
    G90
    _CLIENT_LINEAR_MOVE X=-3
    G1 Z5 F6000
    {RETRACT}
    LOAD_CELL_TARE
    PROBE
    G1 Z5 F6000
    {UNRETRACT}

[gcode_macro _MESH_COMPARE]
gcode:
    {% set profile_name = printer.bed_mesh.profile_name %}
    {% set mesh = printer.bed_mesh %}
    {% set last_probe = printer.probe.last_z_result %}

    {% if mesh and 'mesh_matrix' in mesh %}
        {% set all_z = mesh.mesh_matrix | sum(start=[]) %}
        {% set min_z = all_z | min %}
        {% set max_z = all_z | max %}

        {action_respond_info("===Current profile:=== %s" % profile_name)}
        {action_respond_info("===Minimum map: %.3f mm | Delta: %.3f mm===" % (min_z, max_z - min_z))}
        {action_respond_info("===Maximum map: %.3f mm | Last probe: %.3f mm===" % (max_z, last_probe))}

        {% if last_probe < min_z - 0.21 %}
            {action_respond_info("===Possible wrong profile loaded (different plate/temperature)===")}
            {action_respond_info("===Disable check with: MESH // SAVE_ZMOD_DATA MESH_TEST=0===")}
            {action_raise_error("===WARNING: Last probe BELOW mesh minimum by %.3f mm!===" % (min_z - last_probe))}
        {% elif last_probe > max_z + 0.21 %}
            {action_respond_info("===Possible wrong profile loaded (different plate/temperature)===")}
            {action_respond_info("===Disable check with: MESH // SAVE_ZMOD_DATA MESH_TEST=0===")}
            {action_raise_error("===WARNING: Last probe ABOVE mesh maximum by %.3f mm!===" % (last_probe - max_z))}
        {% else %}
            {action_respond_info("===OK: Probe within mesh extremes===")}
        {% endif %}

    {% else %}
        {action_respond_info("===Profile or mesh matrix not found===")}
    {% endif %}

[gcode_macro _START_MESH]
gcode:
    {% set extruder_temp = printer["gcode_macro _START_PRINT"].zextruder_temp|float %}
    {% set bed_temp = printer["gcode_macro _START_PRINT"].zbed_temp|float %}
    {% set skip_leveling = printer["gcode_macro _START_PRINT"].zskip_leveling %}
    {% set force_kamp = printer["gcode_macro _START_PRINT"].zforce_kamp %}
    {% set force_leveling = printer["gcode_macro _START_PRINT"].zforce_leveling %}
    {% set mesh = printer["gcode_macro _START_PRINT"].zmesh %}

    {% if skip_leveling == False %}
        {% if force_kamp == True %}
            RESPOND PREFIX="//" MSG="===KAMP started SKIP_LEVELING={skip_leveling} FORCE_KAMP={force_kamp}==="

            {% set screen = printer["gcode_macro START_PRINT"].screen %}
            {% if screen == True %}
                RESPOND PREFIX="info" MSG="===Did you know you can enable KAMP globally?==="
                RESPOND PREFIX="//" MSG="SAVE_ZMOD_DATA USE_KAMP=1 CLEAR=LINE_PURGE"
            {% endif %}
            KAMP BED_TEMP={bed_temp} EXTRUDER_TEMP={extruder_temp}

        {% else %}
            {% if (not printer['bed_mesh'].profile_name) or force_leveling == True %}
                {% if mesh != "" %}
                    RESPOND PREFIX="!!" MSG="===Building {mesh} mesh (not found). Save it AFTER print!==="
                    _FULL_BED_LEVEL BED_TEMP={bed_temp} EXTRUDER_TEMP={extruder_temp} PROFILE={mesh}

                {% else %}
                    {% if force_leveling == True %}
                        RESPOND PREFIX="info" MSG="===Building default mesh (FORCE_LEVELING={force_leveling})==="
                        _FULL_BED_LEVEL BED_TEMP={bed_temp} EXTRUDER_TEMP={extruder_temp} PROFILE=default

                    {% else %}
                        RESPOND PREFIX="info" MSG="===Building auto mesh (no loaded profile)==="
                        _FULL_BED_LEVEL BED_TEMP={bed_temp} EXTRUDER_TEMP={extruder_temp} PROFILE=auto
                    {% endif %}
                {% endif %}
            {% endif %}
            {% set cur_mesh = printer['bed_mesh'].profile_name %}
            RESPOND PREFIX="//" MSG="===No need for leveling. Loaded profile: {cur_mesh}==="
        {% endif %}

    {% else %}
        RESPOND PREFIX="//" MSG="===Skipping bed leveling. SKIP_LEVELING={skip_leveling}==="
    {% endif %}

[gcode_macro _PRINT_MESH]
gcode:
    {% set cur_mesh = printer['bed_mesh'].profile_name %}

    RESPOND PREFIX="info" MSG="===Printing with bed mesh: {cur_mesh}==="

[gcode_macro _START_PRINT]
description: ===Replace default start G-code===
variable_zextruder_temp: 245.0
variable_zbed_temp: 80.0
variable_zforce_kamp: False
variable_zforce_leveling: False
variable_zskip_leveling: False
variable_zskip_zoffset: False
variable_zzoffset: 0.0
variable_zmesh: ""
gcode:
    {% set force_kamp = printer["gcode_macro _START_PRINT"].zforce_kamp %}              ; if True it forces the KAMP bed level process
    {% set extruder_temp = printer["gcode_macro _START_PRINT"].zextruder_temp|float %}  ; extruder temp, usually set by slicer
    {% set bed_temp = printer["gcode_macro _START_PRINT"].zbed_temp|float %}            ; bed temp, usually set by slicer
    {% set force_leveling = printer["gcode_macro _START_PRINT"].zforce_leveling %}      ; if True it forces the bed level process
    {% set zoffset = printer["gcode_macro _START_PRINT"].zzoffset %}                    ; Установить Z offset
    {% set skip_zoffset = printer["gcode_macro _START_PRINT"].zskip_zoffset %}          ; Для печати с родного экрана не устанавливать Z offset
    {% set skip_leveling = printer["gcode_macro _START_PRINT"].zskip_leveling %}        ; Не строить карту
    {% set mesh = printer["gcode_macro _START_PRINT"].zmesh %}                          ; Имя профиля карты стола

    {% set force_md5 = printer.save_variables.variables.force_md5|default(1) | int %}
    {% set disable_priming = printer.save_variables.variables.disable_priming|default(0) | int %}
    {% set disable_skew = printer.save_variables.variables.disable_skew|default(1) | int %}
    {% set load_zoffset = printer.save_variables.variables.load_zoffset|default(0) | int %}
    {% set zclear = printer.save_variables.variables.zclear|default("LINE_PURGE")|string %}
    {% set zuse_kamp = printer.save_variables.variables.use_kamp|default(0) | int %}

    {% set screen = printer["gcode_macro START_PRINT"].screen %}
    {% set client = printer['gcode_macro _CLIENT_VARIABLE'] | default({}) %}

    UPDATE_DELAYED_GCODE ID=_CLOSE_DIALOGS DURATION=0
    UPDATE_DELAYED_GCODE ID=_FAST_CLOSE_DIALOGS DURATION=0
    UPDATE_DELAYED_GCODE ID=_STOP_MOTOR DURATION=0
    UPDATE_DELAYED_GCODE ID=_AUTO_REBOOT DURATION=0
    UPDATE_DELAYED_GCODE ID=_PRO_POWEROFF DURATION=0
    UPDATE_DELAYED_GCODE ID=_GOTO_PAUSE DURATION=0

    CLEAR_PAUSE
    ZCONTROL_ABORT
    ZCONTROL_ON
    SET_GCODE_VARIABLE MACRO=_CANCEL_PRINT VARIABLE=cancel_send VALUE=0
    ZSSH_RELOAD

    RESPOND PREFIX="info" MSG="START_PRINT BED_TEMP={bed_temp} EXTRUDER_TEMP={extruder_temp} FORCE_LEVELING={force_leveling} FORCE_KAMP={force_kamp} Z_OFFSET={zoffset} SKIP_ZOFFSET={skip_zoffset} SKIP_LEVELING={skip_leveling} MESH={mesh}"

    RESPOND PREFIX="info" MSG="===Extruder temperature: {extruder_temp}==="
    RESPOND PREFIX="info" MSG="===Bed temperature: {bed_temp}==="

    {% if zprint_leveling == 0 %}
        {% if force_kamp == True %}
            RESPOND PREFIX="info" MSG="===KAMP: enabled==="
        {% else %}
            RESPOND PREFIX="info" MSG="===KAMP: disabled==="
        {% endif %}

        {% if force_leveling == True %}
            RESPOND PREFIX="info" MSG="===Forced bed leveling: enabled==="
        {% else %}
            RESPOND PREFIX="info" MSG="===Forced bed leveling: disabled==="
        {% endif %}

        {% if skip_leveling == True %}
            RESPOND PREFIX="info" MSG="===Skip bed leveling: enabled==="
        {% else %}
            RESPOND PREFIX="info" MSG="===Skip bed leveling: disabled==="
        {% endif %}

        RESPOND PREFIX="info" MSG="===Load bed mesh: {mesh}==="
    {% endif %}

    {% if screen == False %}
        {% if force_md5 == 1 %}
            RESPOND PREFIX="info" MSG="===MD5: enabled==="
        {% else %}
            RESPOND PREFIX="info" MSG="===MD5: disabled==="
        {% endif %}
    {% endif %}

    {% if disable_priming == 1 %}
        RESPOND PREFIX="info" MSG="===Nozzle priming: disabled==="
    {% else %}
        RESPOND PREFIX="info" MSG="===Nozzle priming: enabled==="
        RESPOND PREFIX="info" MSG="===Priming algorithm: {zclear}==="
    {% endif %}

    {% if disable_skew == 1 %}
        RESPOND PREFIX="info" MSG="===SKEW: disabled==="
    {% else %}
        RESPOND PREFIX="info" MSG="===SKEW: enabled==="
    {% endif %}

    {% set check_md5 = printer.save_variables.variables.check_md5|default(0) | int %}
    {% if ( (force_md5 == 1) and ( (screen == False) or (check_md5 == 0) ) ) %}
        RESPOND PREFIX="info" MSG="===MD5 check started==="
        CHECK_MD5 DELETE=True
    {% endif %}

    M140 S{bed_temp}        ; start bed heating
    SET_SKEW CLEAR=1        ; reset skew profile if loaded

    {% if (load_zoffset == 1) and (screen == False) %}
        RESPOND PREFIX="info" MSG="===Using global Z-Offset control. SKIP_ZOFFSET and Z_OFFSET parameters ignored==="
        LOAD_GCODE_OFFSET
    {% else %}
        {% if (load_zoffset == 1) and (screen == True) %}
            RESPOND PREFIX="info" MSG="===Global Z-OFFSET load: ignored (working with screen)==="
        {% endif %}

        {% if skip_zoffset == True %}
            RESPOND PREFIX="info" MSG="===Z-offset setup skipped, SKIP_ZOFFSET={skip_zoffset}==="
        {% else %}
            RESPOND PREFIX="info" MSG="===Setting Z-offset {zoffset}, SKIP_ZOFFSET={skip_zoffset}==="
            SET_GCODE_OFFSET Z={zoffset}
        {% endif %}
    {% endif %}

    _G28

    {% if not client.ff5x %}
        {% set we = printer['temperature_sensor weightValue'].temperature %}
        {% if we != 0 %}
            LOAD_CELL_TARE
        {% endif %}
    {% endif %}

    {% set zprint_leveling = printer.save_variables.variables.print_leveling|default(0) | int %}
    {% if zprint_leveling == 1 %}
        {% if screen == True %}
            RESPOND PREFIX="//" MSG="===Building bed mesh with native screen on each print. // SAVE_ZMOD_DATA PRINT_LEVELING={zprint_leveling}==="
        {% else %}
            RESPOND PREFIX="//" MSG="===Building bed mesh on each print. // SAVE_ZMOD_DATA PRINT_LEVELING={zprint_leveling}==="
            BED_MESH_CLEAR
            M400
            {% if zuse_kamp == 1 %}
                RESPOND PREFIX="info" MSG="===Using KAMP from global settings. // SAVE_ZMOD_DATA USE_KAMP={zuse_kamp}==="
                KAMP BED_TEMP={bed_temp} EXTRUDER_TEMP={extruder_temp}
            {% else %}
                RESPOND PREFIX="info" MSG="===Building full bed mesh. // SAVE_ZMOD_DATA USE_KAMP={zuse_kamp}==="
                _FULL_BED_LEVEL BED_TEMP={bed_temp} EXTRUDER_TEMP={extruder_temp}
            {% endif %}
        {% endif %}

        RESPOND PREFIX="//" MSG="===All START_PRINT parameters for bed leveling are ignored==="
    {% else %}
        {% if mesh != "" %}
            RESPOND PREFIX="info" MSG="===Trying to load bed mesh: {mesh}==="
            BED_MESH_CLEAR
            M400
            {% for mesh_dt in printer['bed_mesh'].profiles %}
                {% if mesh == mesh_dt %}
                    BED_MESH_PROFILE LOAD={mesh}
                    RESPOND PREFIX="info" MSG="===Bed mesh {mesh} loaded==="
                {% endif %}
            {% endfor %}
        {% endif %}

        _START_MESH
    {% endif %}

    # load skew profile
    {% if disable_skew == 0 %}
        RESPOND PREFIX="info" MSG="===Loading skew_profile==="
        SKEW_PROFILE LOAD=skew_profile
    {% endif %}

    G90                     ; use absolute coordinates
    {% if ((zprint_leveling == 0) and (force_kamp == True)) or ((zprint_leveling == 1) and (screen == False) and (zuse_kamp == 1)) or (zclear == "LINE_PURGE") %}
        _SMART_PARK
    {% else %}
        _UGOL_PARK
    {% endif %}

    #M190 S{bed_temp}
    #M109 S{extruder_temp}

    # Убираем стабилизацию температуры, для тех у кого не настроен PID экструдера и/или PID стола
    M140 S{bed_temp}
    TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM={bed_temp-1} MAXIMUM={bed_temp+1}
    M104 S{extruder_temp}
    TEMPERATURE_WAIT SENSOR=extruder MINIMUM={extruder_temp-1} MAXIMUM={extruder_temp+1}

    {% if printer.toolhead.position.z < 5 %}
        G1 Z5 F3000
    {% endif %}

    {% set zmidi_start = printer.save_variables.variables.midi_start|default("") | string %}

    {% if disable_priming == 1 %}
        RESPOND PREFIX="info" MSG="===Nozzle line purge disabled. DISABLE_PRIMING={disable_priming}==="
        _PRINT_MESH
        {% if zmidi_start != "" %}
            PLAY_MIDI FILE={zmidi_start}
        {% endif %}
    {% else %}
        {% set mesh_test = printer.save_variables.variables.mesh_test|default(1) | int %}
        {% if mesh_test == 0 or force_kamp == True or zprint_leveling == 1 or force_leveling == True %}
            _PRINT_MESH
        {% else %}
            _MESH_TEST
        {% endif %}

        RESPOND PREFIX="info" MSG="===Nozzle line purge==="
        RESPOND PREFIX="info" MSG="===Algorithm: {zclear}==="

        {% if zmidi_start != "" %}
            PLAY_MIDI FILE={zmidi_start}
        {% endif %}

        {% if ( (force_kamp == True) or (zuse_kamp == 1) ) and (zclear == "_CLEAR1" or zclear == "_CLEAR2" or zclear == "_CLEAR3" or zclear == "_CLEAR4") %}
            RESPOND PREFIX="info" MSG="===You are using KAMP. Recommended to use LINE_PURGE: // SAVE_ZMOD_DATA CLEAR=LINE_PURGE==="
            RESPOND PREFIX="info" MSG="===LINE_PURGE forced==="
            LINE_PURGE
        {% else %}
            SAVE_GCODE_STATE NAME=CLEAR_STATE
            {zclear}
            RESTORE_GCODE_STATE NAME=CLEAR_STATE
        {% endif %}
    {% endif %}

[gcode_macro UPDATE_MCU]
description: ===Update MCU===
gcode:
#    {% set current_klipper12 = printer.save_variables.variables.klipper12|default(0) | int %}

    RESPOND TYPE=error MSG="===Wait for the music and power off the printer.==="
    RESPOND TYPE=error MSG="===Wait 10 seconds and power on again. MCU update will begin.==="

#    {% if (current_klipper12 == 1) %}
        RESPOND PREFIX="info" MSG="===Flashing MCU with original version for native Klipper==="
        SAVE_VARIABLE VARIABLE=klipper12 VALUE={0|int}
        G4 P5000
        M400
        RUN_SHELL_COMMAND CMD=zmcu PARAMS="0"
#    {% else %}
#        RESPOND PREFIX="info" MSG="Прошивка MCU для Klipper 12"
#        SAVE_VARIABLE VARIABLE=klipper12 VALUE={1|int}
#        G4 P5000
#        M400
#        RUN_SHELL_COMMAND CMD=zmcu PARAMS="1"
#    {% endif %}

[gcode_macro NEW_SAVE_CONFIG]
description: ===Save parameters without stock screen freeze===
gcode:
    {% set screen = printer["gcode_macro START_PRINT"].screen %}
    {% set client = printer['gcode_macro _CLIENT_VARIABLE'] | default({}) %}

    {% if screen == False or client.ff5x %}
        SAVE_CONFIG
    {% else %}
        RESPOND PREFIX="info" MSG="NEW_SAVE_CONFIG"
        RUN_SHELL_COMMAND CMD=restart_klipper
    {% endif %}

[gcode_macro CLOSE_DIALOGS]
description: ===Close dialogs on stock screen (slow)===
gcode:
    {% set client = printer['gcode_macro _CLIENT_VARIABLE'] | default({}) %}

    {% if not client.ff5x %}
        RESPOND PREFIX="info" MSG="===Closing dialog windows on native screen (slow)==="
        RUN_SHELL_COMMAND CMD=close_dialogs
        RESPOND PREFIX="info" MSG="===Failed to close windows? Use fast close: FAST_CLOSE_DIALOGS // SAVE_ZMOD_DATA CLOSE_DIALOGS=2==="
    {% else %}
        FAST_CLOSE_DIALOGS
    {% endif %}

[gcode_macro FAST_CLOSE_DIALOGS]
description: ===Close dialogs on stock screen (fast)===
gcode:
    RESPOND PREFIX="info" MSG="===Closing dialog windows on native screen (fast)==="
    RUN_SHELL_COMMAND CMD=zprint PARAMS="CLOSE CLOSE"

[delayed_gcode _STOP_MOTOR]
gcode:
    RESPOND PREFIX="info" MSG="===Motors disabled==="
    M84                     ; Выключить мотор

[delayed_gcode _GOTO_PAUSE]
gcode:
    {% set client = printer['gcode_macro _CLIENT_VARIABLE'] | default({}) %}
    RESPOND PREFIX="info" MSG="===Moving head to far right corner==="
    G1 Y{client.custom_park_y} F7800
    M400
    G1 X{client.custom_park_x} F7800
    M400

[delayed_gcode _CLOSE_DIALOGS]
gcode:
    CLOSE_DIALOGS

[delayed_gcode _FAST_CLOSE_DIALOGS]
gcode:
    FAST_CLOSE_DIALOGS

[delayed_gcode _AUTO_REBOOT]
gcode:
    {% set zauto_reboot = printer.save_variables.variables.auto_reboot|default(0) | int %}
    {% set screen = printer["gcode_macro START_PRINT"].screen %}

    {% if (zauto_reboot == 2) and (screen == False) %}
        FIRMWARE_RESTART
    {% else %}
        REBOOT
    {% endif %}

[delayed_gcode _PRO_POWEROFF]
gcode:
    SHUTDOWN

[delayed_gcode restart_services]
initial_duration: 180
gcode:
    ZSSH_RELOAD

[delayed_gcode start_led]
initial_duration: 10
gcode:
    SET_GCODE_VARIABLE MACRO=_CANCEL_PRINT VARIABLE=cancel_send VALUE=0
    SET_GCODE_VARIABLE MACRO=_SHUTDOWN VARIABLE=trigger_allowed VALUE=True
    SET_GCODE_VARIABLE MACRO=SET_LED VARIABLE=allowed VALUE=True

    SAVE_VARIABLE VARIABLE=check_md5 VALUE={0|int}

    CAMERA_RESTART

    GET_ZMOD_DATA

    {% set zmidi_on = printer.save_variables.variables.midi_on|default("") | string %}
    {% if zmidi_on != "" %}
        PLAY_MIDI FILE={zmidi_on}
    {% endif %}

    {% set zled = printer.save_variables.variables.led|default(50) | int %}
    LED S={zled}

[gcode_macro _COLDPULL_LOAD_MATERIAL_END]
gcode:
    RESPOND TYPE=command MSG="action:prompt_end"

[gcode_macro _COLDPULL_LOAD_MATERIAL]
gcode:
    {% set client = printer['gcode_macro _CLIENT_VARIABLE'] | default({}) %}
    RESPOND TYPE=command MSG=action:prompt_end

    _G28

    G90
    G1 X{client.min_x+(client.max_x-client.min_x)/2} F7800
    G1 Y{client.min_y+(client.max_y-client.min_y)/2} F7800
    M400
    M400

    {% set extruder_temp = params.TEMP|default(245)|float %}
    RESPOND PREFIX="info" MSG="===Waiting for nozzle to heat up to {extruder_temp}==="
    M104 S{extruder_temp}
    TEMPERATURE_WAIT SENSOR=extruder MINIMUM={extruder_temp} MAXIMUM={extruder_temp+10}

    RESPOND PREFIX="info" MSG="===Extruding 10 cm of filament==="

    _DISABLE_SENSOR
        G1 E100 F100
        M400
    _ENABLE_SENSOR

    {% set cold_temp = params.COLD|default(245)|float %}
    RESPOND PREFIX="info" MSG="===Cooling down to {cold_temp}°C==="
    M104 S{cold_temp}
    M106 P0 S255
    TEMPERATURE_WAIT SENSOR=extruder MINIMUM={cold_temp-2} MAXIMUM={cold_temp+2}

    RESPOND PREFIX="info" MSG="===Pulling the filament==="

    _DISABLE_SENSOR
        G1 E-70 F1500
        M400
    _ENABLE_SENSOR

    RESPOND PREFIX="info" MSG="===Remove the remaining filament manually==="
    M107
    M104 S0

[gcode_macro COLDPULL]
description: ===Cold pull (nozzle cleaning) gently===
gcode:
    RESPOND TYPE=command MSG="action:prompt_begin ===Material selection for loading==="
    RESPOND TYPE=command MSG="action:prompt_text ===Select material to clean the nozzle==="
    RESPOND TYPE=command MSG="action:prompt_button_group_start"
    RESPOND TYPE=command MSG="action:prompt_button PETG|_COLDPULL_LOAD_MATERIAL TEMP=245 COLD=100|primary"
    RESPOND TYPE=command MSG="action:prompt_button ABS|_COLDPULL_LOAD_MATERIAL TEMP=255 COLD=105|primary"
    RESPOND TYPE=command MSG="action:prompt_button NEYLON|_COLDPULL_LOAD_MATERIAL TEMP=260 COLD=120|primary"
    RESPOND TYPE=command MSG="action:prompt_button_group_end"
    RESPOND TYPE=command MSG="action:prompt_footer_button ===Cancel===|_COLDPULL_LOAD_MATERIAL_END"
    RESPOND TYPE=command MSG="action:prompt_show"

[gcode_macro SAVE_ZMOD_DATA]
description: ===Save ZMOD parameters===
gcode:
    {% set client = printer['gcode_macro _CLIENT_VARIABLE'] | default({}) %}

    {% if params.CLOSE_DIALOGS %}
        {% set zclose_dialogs = params.CLOSE_DIALOGS|default(0)|int %}
        {% if client.ff5x and zclose_dialogs == 1 %}
            SAVE_VARIABLE VARIABLE=close_dialogs VALUE=2
        {% else %}
            SAVE_VARIABLE VARIABLE=close_dialogs VALUE={zclose_dialogs|int}
        {% endif %}
    {% endif %}

    {% if params.STOP_MOTOR %}
        {% set zstop_motor = params.STOP_MOTOR|default(1)|int %}
        SAVE_VARIABLE VARIABLE=stop_motor VALUE={zstop_motor|int}
    {% endif %}

    {% if not client.ff5x %}
    {% if params.USE_SWAP %}
        {% set zuse_swap = params.USE_SWAP|default(1)|int %}
        SAVE_VARIABLE VARIABLE=use_swap VALUE={zuse_swap|int}
    {% endif %}
    {% endif %}

    {% if params.AUTO_REBOOT %}
        {% set zauto_reboot = params.AUTO_REBOOT|default(0)|int %}
        SAVE_VARIABLE VARIABLE=auto_reboot VALUE={zauto_reboot|int}
    {% endif %}

    {% if params.SAVE_RESTORE %}
        {% set save_restore = params.SAVE_RESTORE|default(1)|int %}
        SAVE_VARIABLE VARIABLE=save_restore VALUE={save_restore|int}
    {% endif %}

    {% if params.FIX_SCV %}
        {% set fix_scv = params.FIX_SCV|default(1)|int %}
        SAVE_VARIABLE VARIABLE=fix_scv VALUE={fix_scv|int}
    {% endif %}

    {% if not client.ff5x %}
    {% if params.MOTION_SENSOR %}
        {% set motion_sensor = params.MOTION_SENSOR|default(0)|int %}
        SAVE_VARIABLE VARIABLE=motion_sensor VALUE={motion_sensor|int}
    {% endif %}
    {% endif %}

    {% if params.FIX_E0011 %}
        {% set fix_e0011 = params.FIX_E0011|default(0)|int %}
        SAVE_VARIABLE VARIABLE=fix_e0011 VALUE={fix_e0011|int}
    {% endif %}

    {% if params.FIX_E0017 %}
        {% set fix_e0017 = params.FIX_E0017|default(1)|int %}
        SAVE_VARIABLE VARIABLE=fix_e0017 VALUE={fix_e0017|int}
    {% endif %}

    {% if params.PRINT_LEVELING %}
        {% set zprint_leveling = params.PRINT_LEVELING|default(0)|int %}
        SAVE_VARIABLE VARIABLE=print_leveling VALUE={zprint_leveling|int}
    {% endif %}

    {% if params.USE_KAMP %}
        {% set zuse_kamp = params.USE_KAMP|default(0)|int %}
        SAVE_VARIABLE VARIABLE=use_kamp VALUE={zuse_kamp|int}
    {% endif %}

    {% if params.MESH_TEST %}
        {% set zmesh_test = params.MESH_TEST|default(1)|int %}
        SAVE_VARIABLE VARIABLE=mesh_test VALUE={zmesh_test|int}
    {% endif %}

    {% if not client.ff5x %}
    {% if params.NEW_SAVE_CONFIG %}
        {% set znew_save_config = params.NEW_SAVE_CONFIG|default(0)|int %}
        SAVE_VARIABLE VARIABLE=new_save_config VALUE={znew_save_config|int}
    {% endif %}

    {% if params.PRECLEAR %}
        {% set zpreclear = params.PRECLEAR|default(0)|int %}
        SAVE_VARIABLE VARIABLE=preclear VALUE={zpreclear|int}
    {% endif %}
    {% endif %}

    {% if params.FORCE_MD5 %}
        {% set zforce_md5 = params.FORCE_MD5|default(1)|int %}
        SAVE_VARIABLE VARIABLE=force_md5 VALUE={zforce_md5|int}
    {% endif %}

    {% if params.DISABLE_SKEW %}
        {% set zdisable_skew = params.DISABLE_SKEW|default(1)|int %}
        SAVE_VARIABLE VARIABLE=disable_skew VALUE={zdisable_skew|int}
    {% endif %}

    {% if params.LOAD_ZOFFSET %}
        {% set zload_zoffset = params.LOAD_ZOFFSET|default(0)|int %}
        SAVE_VARIABLE VARIABLE=load_zoffset VALUE={zload_zoffset|int}
    {% endif %}

    {% if params.LED %}
        {% set zled = params.LED|default(50)|int %}
        SAVE_VARIABLE VARIABLE=led VALUE={zled|int}
    {% endif %}

    {% if params.DISABLE_PRIMING %}
        {% set zdisable_priming = params.DISABLE_PRIMING|default(0)|int %}
        SAVE_VARIABLE VARIABLE=disable_priming VALUE={zdisable_priming|int}
    {% endif %}

    {% if params.CLEAR %}
        {% set zclear = params.CLEAR|default("LINE_PURGE")|string %}
        SAVE_VARIABLE VARIABLE=zclear VALUE='"{zclear|string}"'
    {% endif %}

    {% if params.CHINA_CLOUD %}
        {% set zchina_cloud = params.CHINA_CLOUD|default(0)|int %}
        SAVE_VARIABLE VARIABLE=china_cloud VALUE={zchina_cloud|int}
    {% endif %}

    {% if params.SAVE_MOONRAKER %}
        {% set save_moonraker = params.SAVE_MOONRAKER|default(0)|int %}
        SAVE_VARIABLE VARIABLE=save_moonraker VALUE={save_moonraker|int}
    {% endif %}

    {% if params.NICE %}
        {% set znice = params.NICE|default(20)|int %}
        {% if znice > 40 %}
            SAVE_VARIABLE VARIABLE=nice VALUE={40|int}
        {% else %}
            {% if znice < 1 %}
                SAVE_VARIABLE VARIABLE=nice VALUE={1|int}
            {% else %}
                SAVE_VARIABLE VARIABLE=nice VALUE={znice|int}
            {% endif %}
        {% endif %}
    {% endif %}

    {% if params.DISPLAY_OFF_TIMEOUT %}
        {% set display_off_timeout = params.DISPLAY_OFF_TIMEOUT|default(180)|int %}
        SAVE_VARIABLE VARIABLE=display_off_timeout VALUE={display_off_timeout|int}
    {% endif %}

    {% if params.PRO_POWEROFF_TIMEOUT %}
        {% set pro_poweroff_timeout = params.PRO_POWEROFF_TIMEOUT|default(0)|int %}
        SAVE_VARIABLE VARIABLE=pro_poweroff_timeout VALUE={pro_poweroff_timeout|int}
    {% endif %}

    {% if params.MIDI_ON %}
        {% set zmidi_on = params.MIDI_ON|default("")|string %}
        {% if zmidi_on == "0" %}
            SAVE_VARIABLE VARIABLE=midi_on VALUE='""'
        {% else %}
            SAVE_VARIABLE VARIABLE=midi_on VALUE='"{zmidi_on|string}"'
        {% endif %}
    {% endif %}

    {% if params.MIDI_START %}
        {% set zmidi_start = params.MIDI_START|default("")|string %}
        {% if zmidi_start == "0" %}
            SAVE_VARIABLE VARIABLE=midi_start VALUE='""'
        {% else %}
            SAVE_VARIABLE VARIABLE=midi_start VALUE='"{zmidi_start|string}"'
        {% endif %}
    {% endif %}

    {% if params.MIDI_PAUSE %}
        {% set zmidi_pause = params.MIDI_PAUSE|default("")|string %}
        {% if zmidi_pause == "0" %}
            SAVE_VARIABLE VARIABLE=midi_pause VALUE='""'
        {% else %}
            SAVE_VARIABLE VARIABLE=midi_pause VALUE='"{zmidi_pause|string}"'
        {% endif %}
    {% endif %}

    {% if params.MIDI_END %}
        {% set zmidi_end = params.MIDI_END|default("")|string %}
        {% if zmidi_end == "0" %}
            SAVE_VARIABLE VARIABLE=midi_end VALUE='""'
        {% else %}
            SAVE_VARIABLE VARIABLE=midi_end VALUE='"{zmidi_end|string}"'
        {% endif %}
    {% endif %}

    GET_ZMOD_DATA

[gcode_macro GET_ZMOD_DATA]
description: ===Get ZMOD parameters===
gcode:
    {% set client = printer['gcode_macro _CLIENT_VARIABLE'] | default({}) %}

    RESPOND PREFIX="info" MSG="===ZMOD parameters. Set via SAVE_ZMOD_DATA==="

    {% set guppy = printer.save_variables.variables.guppy|default(1) | int %}
    SAVE_VARIABLE VARIABLE=guppy VALUE={guppy|int}

    {% set screen = printer["gcode_macro START_PRINT"].screen %}
    {% if screen == True %}
        RESPOND PREFIX="info" MSG="===You are using native screen // DISPLAY_ON==="
    {% else %}
        {% if guppy == 1 %}
            RESPOND PREFIX="info" MSG="===You are working WITHOUT native screen with GuppyScreen // DISPLAY_OFF GUPPY=1==="
        {% else %}
            RESPOND PREFIX="info" MSG="===You are working WITHOUT native screen // DISPLAY_OFF GUPPY=0==="
        {% endif %}
    {% endif %}

    RESPOND PREFIX="info" MSG="===Parameters used at print start and bed leveling [START_PRINT]==="

    {% set zprint_leveling = printer.save_variables.variables.print_leveling|default(0) | int %}
    {% if zprint_leveling == 1 %}
        {% if screen == True %}
            RESPOND PREFIX="//" MSG="===Build bed mesh with native screen on each print. // SAVE_ZMOD_DATA PRINT_LEVELING={zprint_leveling}==="
        {% else %}
            RESPOND PREFIX="//" MSG="===Build bed mesh on each print. // SAVE_ZMOD_DATA PRINT_LEVELING={zprint_leveling}==="
        {% endif %}
    {% else %}
        RESPOND PREFIX="//" MSG="===Don't build bed mesh with native screen // SAVE_ZMOD_DATA PRINT_LEVELING={zprint_leveling}==="
    {% endif %}
    SAVE_VARIABLE VARIABLE=print_leveling VALUE={zprint_leveling|int}

    {% set zuse_kamp = printer.save_variables.variables.use_kamp|default(0) | int %}
    {% if zuse_kamp == 1 %}
        RESPOND PREFIX="//" MSG="===Use adaptive mesh (KAMP) where possible instead of full bed mesh // SAVE_ZMOD_DATA USE_KAMP={zuse_kamp}==="
    {% else %}
        RESPOND PREFIX="//" MSG="===Don't use KAMP instead of BED_MESH_CALIBRATE // SAVE_ZMOD_DATA USE_KAMP={zuse_kamp}==="
    {% endif %}
    SAVE_VARIABLE VARIABLE=use_kamp VALUE={zuse_kamp|int}

    {% set zmesh_test = printer.save_variables.variables.mesh_test|default(1) | int %}
    {% if zmesh_test == 1 %}
        RESPOND PREFIX="//" MSG="===Test bed mesh before printing // SAVE_ZMOD_DATA MESH_TEST={zmesh_test}==="
    {% else %}
        RESPOND PREFIX="//" MSG="===Don't test bed mesh before printing // SAVE_ZMOD_DATA MESH_TEST={zmesh_test}==="
    {% endif %}
    SAVE_VARIABLE VARIABLE=mesh_test VALUE={zmesh_test|int}

    {% set zmidi_start = printer.save_variables.variables.midi_start|default("") | string %}
    RESPOND PREFIX="//" MSG="===Play MIDI on print start: {zmidi_start}=== // SAVE_ZMOD_DATA MIDI_START={zmidi_start}"
    SAVE_VARIABLE VARIABLE=midi_start VALUE='"{zmidi_start|string}"'

    {% set zmidi_pause = printer.save_variables.variables.midi_pause|default("") | string %}
    RESPOND PREFIX="//" MSG="===Play MIDI on print pause: {zmidi_pause}=== // SAVE_ZMOD_DATA MIDI_PAUSE={zmidi_pause}"
    SAVE_VARIABLE VARIABLE=midi_pause VALUE='"{zmidi_pause|string}"'

    {% set zforce_md5 = printer.save_variables.variables.force_md5|default(1) | int %}
    {% if zforce_md5 == 1 %}
        RESPOND PREFIX="//" MSG="===Check file MD5 checksum=== // SAVE_ZMOD_DATA FORCE_MD5={zforce_md5}"
    {% else %}
        RESPOND PREFIX="//" MSG="===Don't check file MD5 checksum=== // SAVE_ZMOD_DATA FORCE_MD5={zforce_md5}"
    {% endif %}
    SAVE_VARIABLE VARIABLE=force_md5 VALUE={zforce_md5|int}

    {% set zdisable_skew = printer.save_variables.variables.disable_skew|default(1) | int %}
    {% if zdisable_skew == 1 %}
        RESPOND PREFIX="//" MSG="===SKEW correction disabled=== // SAVE_ZMOD_DATA DISABLE_SKEW={zdisable_skew}"
    {% else %}
        RESPOND PREFIX="//" MSG="===SKEW correction enabled. Profile skew_profile=== // SAVE_ZMOD_DATA DISABLE_SKEW={zdisable_skew}"
    {% endif %}
    SAVE_VARIABLE VARIABLE=disable_skew VALUE={zdisable_skew|int}

    {% set zload_zoffset = printer.save_variables.variables.load_zoffset|default(0) | int %}
    {% if zload_zoffset == 1 %}
        RESPOND PREFIX="//" MSG="===Load Z-OFFSET from global settings=== // SAVE_ZMOD_DATA LOAD_ZOFFSET={zload_zoffset}"
    {% else %}
        RESPOND PREFIX="//" MSG="===Don't load Z-OFFSET from global settings=== // SAVE_ZMOD_DATA LOAD_ZOFFSET={zload_zoffset}"
    {% endif %}
    SAVE_VARIABLE VARIABLE=load_zoffset VALUE={zload_zoffset|int}

    {% set zdisable_priming = printer.save_variables.variables.disable_priming|default(0) | int %}
    {% if zdisable_priming == 1 %}
        RESPOND PREFIX="//" MSG="===Disable nozzle line purge=== // SAVE_ZMOD_DATA DISABLE_PRIMING={zdisable_priming}"
    {% else %}
        RESPOND PREFIX="//" MSG="===Enable nozzle line purge=== // SAVE_ZMOD_DATA DISABLE_PRIMING={zdisable_priming}"
    {% endif %}
    SAVE_VARIABLE VARIABLE=disable_priming VALUE={zdisable_priming|int}

    {% if not client.ff5x %}
        {% set zpreclear = printer.save_variables.variables.preclear|default(0) | int %}
        {% if zpreclear == 1 %}
            RESPOND PREFIX="//" MSG="===Use nozzle pre-purge=== // SAVE_ZMOD_DATA PRECLEAR={zpreclear}"
        {% else %}
            RESPOND PREFIX="//" MSG="===Don't use nozzle pre-purge=== // SAVE_ZMOD_DATA PRECLEAR={zpreclear}"
        {% endif %}
        SAVE_VARIABLE VARIABLE=preclear VALUE={zpreclear|int}
    {% endif %}

    {% set zclear = printer.save_variables.variables.zclear|default("LINE_PURGE") | string %}
    RESPOND PREFIX="//" MSG="===Purge algorithm: {zclear}=== // SAVE_ZMOD_DATA CLEAR={zclear}"
    SAVE_VARIABLE VARIABLE=zclear VALUE='"{zclear|string}"'

    RESPOND PREFIX="info" MSG="===Parameters used at print end and cancellation [END_PRINT]==="

    {% set zmidi_end = printer.save_variables.variables.midi_end|default("") | string %}
    RESPOND PREFIX="//" MSG="===Play MIDI at print end: {zmidi_end}=== // SAVE_ZMOD_DATA MIDI_END={zmidi_end}"
    SAVE_VARIABLE VARIABLE=midi_end VALUE='"{zmidi_end|string}"'

    {% set zclose_dialogs = printer.save_variables.variables.close_dialogs|default(0) | int %}
    SAVE_VARIABLE VARIABLE=close_dialogs VALUE={zclose_dialogs|int}
    {% if zclose_dialogs == 0 %}
        RESPOND PREFIX="//" MSG="===Don't close dialogs on native screen=== // SAVE_ZMOD_DATA CLOSE_DIALOGS={zclose_dialogs}"
    {% else %}
        {% if client.ff5x %}
            SAVE_VARIABLE VARIABLE=close_dialogs VALUE=2
        {% endif %}
    {% endif %}
    {% if zclose_dialogs == 1 %}
        RESPOND PREFIX="//" MSG="===Auto close dialogs on native screen after 20 sec (slow)=== // SAVE_ZMOD_DATA CLOSE_DIALOGS={zclose_dialogs}"
    {% endif %}
    {% if zclose_dialogs == 2 %}
        RESPOND PREFIX="//" MSG="===Auto close dialogs on native screen after 20 sec (fast)=== // SAVE_ZMOD_DATA CLOSE_DIALOGS={zclose_dialogs}"
    {% endif %}

    {% set zstop_motor = printer.save_variables.variables.stop_motor|default(1) | int %}
    {% if zstop_motor == 1 %}
        RESPOND PREFIX="//" MSG="===Auto disable motors after print/cancel in 25 sec=== // SAVE_ZMOD_DATA STOP_MOTOR={zstop_motor}"
    {% else %}
        RESPOND PREFIX="//" MSG="===Don't disable motors automatically after print/cancel=== // SAVE_ZMOD_DATA STOP_MOTOR={zstop_motor}"
    {% endif %}
    SAVE_VARIABLE VARIABLE=stop_motor VALUE={zstop_motor|int}

    {% set zauto_reboot = printer.save_variables.variables.auto_reboot|default(0) | int %}
    {% if zauto_reboot == 0 %}
        RESPOND PREFIX="//" MSG="===Don't reboot printer automatically=== // SAVE_ZMOD_DATA AUTO_REBOOT={zauto_reboot}"
    {% endif %}
    {% if zauto_reboot == 1 %}
        RESPOND PREFIX="//" MSG="===Auto reboot printer after 1.5 minutes=== //SAVE_ZMOD_DATA AUTO_REBOOT={zauto_reboot}"
    {% endif %}
    {% if zauto_reboot == 2 %}
        {% if screen == True %}
            RESPOND PREFIX="//" MSG="===Auto reboot printer after 1.5 minutes=== //SAVE_ZMOD_DATA AUTO_REBOOT={zauto_reboot}"
        {% else %}
            RESPOND PREFIX="//" MSG="===Auto restart firmware after 1.5 minutes=== //SAVE_ZMOD_DATA AUTO_REBOOT={zauto_reboot}"
        {% endif %}
    {% endif %}
    SAVE_VARIABLE VARIABLE=auto_reboot VALUE={zauto_reboot|int}

    {% if not client.ff5x %}
        {% set pro_poweroff_timeout = printer.save_variables.variables.pro_poweroff_timeout|default(0) | int %}
        RESPOND PREFIX="//" MSG="===Power off FF5M Pro after (min): {timeout}=== // SAVE_ZMOD_DATA PRO_POWEROFF_TIMEOUT={pro_poweroff_timeout}"
        SAVE_VARIABLE VARIABLE=pro_poweroff_timeout VALUE={pro_poweroff_timeout|int}
    {% endif %}

    RESPOND PREFIX="info" MSG="===System-wide parameters==="

    {% set save_restore = printer.save_variables.variables.save_restore|default(1) | int %}
    {% if save_restore == 1 %}
        {% if screen == True %}
            RESPOND PREFIX="//" MSG="===Saving controlled by native screen=== // SAVE_ZMOD_DATA SAVE_RESTORE={save_restore}"
        {% else %}
            RESPOND PREFIX="//" MSG="===Save data for print recovery=== // SAVE_ZMOD_DATA SAVE_RESTORE={save_restore}"
        {% endif %}
    {% else %}
        {% if screen == True %}
            RESPOND PREFIX="//" MSG="===Saving controlled by native screen=== // SAVE_ZMOD_DATA SAVE_RESTORE={save_restore}"
        {% else %}
            RESPOND PREFIX="//" MSG="===Don't save data for print recovery=== // SAVE_ZMOD_DATA SAVE_RESTORE={save_restore}"
        {% endif %}
    {% endif %}
    SAVE_VARIABLE VARIABLE=save_restore VALUE={save_restore|int}

    {% if not client.ff5x %}
        {% set motion_sensor = printer.save_variables.variables.motion_sensor|default(0) | int %}
        {% if motion_sensor == 1 %}
            RESPOND PREFIX="//" MSG="===Using filament motion sensor=== // SAVE_ZMOD_DATA MOTION_SENSOR={motion_sensor}"
            {% if screen == True %}
                RESPOND PREFIX="//" MSG="===Disable filament sensor on native screen==="
            {% endif %}
        {% else %}
            RESPOND PREFIX="//" MSG="===Using filament presence sensor=== // SAVE_ZMOD_DATA MOTION_SENSOR={motion_sensor}"
        {% endif %}
        SAVE_VARIABLE VARIABLE=motion_sensor VALUE={motion_sensor|int}
    {% endif %}

    {% set fix_scv = printer.save_variables.variables.fix_scv|default(1) | int %}
    {% if fix_scv == 1 %}
        RESPOND PREFIX="//" MSG="===Use SCV from config for shaper graphs=== // SAVE_ZMOD_DATA FIX_SCV={fix_scv}"
    {% else %}
        RESPOND PREFIX="//" MSG="===Use SCV = 5 for shaper graphs=== // SAVE_ZMOD_DATA FIX_SCV={fix_scv}"
    {% endif %}
    SAVE_VARIABLE VARIABLE=fix_scv VALUE={fix_scv|int}

    {% set fix_e0011 = printer.save_variables.variables.fix_e0011|default(0) | int %}
    {% if fix_e0011 == 1 %}
        RESPOND PREFIX="//" MSG="===Fix E0011 error=== // SAVE_ZMOD_DATA FIX_E0011={fix_e0011}"
    {% else %}
        RESPOND PREFIX="//" MSG="===Don't fix E0011 error=== // SAVE_ZMOD_DATA FIX_E0011={fix_e0011}"
    {% endif %}
    SAVE_VARIABLE VARIABLE=fix_e0011 VALUE={fix_e0011|int}
    RUN_SHELL_COMMAND CMD=zfix_e0011 PARAMS="{fix_e0011}"

    {% set fix_e0017 = printer.save_variables.variables.fix_e0017|default(1) | int %}
    {% if fix_e0017 == 1 %}
        RESPOND PREFIX="//" MSG="===Fix E0017 error=== // SAVE_ZMOD_DATA FIX_E0017={fix_e0017}"
    {% else %}
        RESPOND PREFIX="//" MSG="===Don't fix E0017 error=== // SAVE_ZMOD_DATA FIX_E0017={fix_e0017}"
    {% endif %}
    SAVE_VARIABLE VARIABLE=fix_e0017 VALUE={fix_e0017|int}
    RUN_SHELL_COMMAND CMD=zfix_e0017 PARAMS="{fix_e0017}"

    {% set zled = printer.save_variables.variables.led|default(50) | int %}
    RESPOND PREFIX="//" MSG="===LED brightness at power on: {zled}=== // SAVE_ZMOD_DATA LED={zled}"
    SAVE_VARIABLE VARIABLE=led VALUE={zled|int}

    {% set zmidi_on = printer.save_variables.variables.midi_on|default("") | string %}
    RESPOND PREFIX="//" MSG="===Play MIDI at power on: {zmidi_on}=== // SAVE_ZMOD_DATA MIDI_ON={zmidi_on}"
    SAVE_VARIABLE VARIABLE=midi_on VALUE='"{zmidi_on|string}"'

    {% if not client.ff5x %}
        {% set znew_save_config = printer.save_variables.variables.new_save_config|default(0) | int %}
        {% if znew_save_config == 1 %}
            RESPOND PREFIX="//" MSG="===Use alternative NEW_SAVE_CONFIG=== // SAVE_ZMOD_DATA NEW_SAVE_CONFIG={znew_save_config}"
        {% else %}
            RESPOND PREFIX="//" MSG="===Use standard SAVE_CONFIG=== // SAVE_ZMOD_DATA NEW_SAVE_CONFIG={znew_save_config}"
        {% endif %}
        SAVE_VARIABLE VARIABLE=new_save_config VALUE={znew_save_config|int}
    {% else %}
        SAVE_VARIABLE VARIABLE=new_save_config VALUE=0
    {% endif %}

    {% if not client.ff5x %}
        {% set zuse_swap = printer.save_variables.variables.use_swap|default(1) | int %}
        {% if zuse_swap == 0 %}
            RESPOND PREFIX="//" MSG="===SWAP not used=== // SAVE_ZMOD_DATA USE_SWAP={zuse_swap}"
        {% endif %}
        {% if zuse_swap == 1 %}
            RESPOND PREFIX="//" MSG="===SWAP used on EMMC=== // SAVE_ZMOD_DATA USE_SWAP={zuse_swap}"
        {% endif %}
        {% if zuse_swap == 2 %}
            RESPOND PREFIX="//" MSG="===SWAP used on USB FLASH=== // SAVE_ZMOD_DATA USE_SWAP={zuse_swap}"
        {% endif %}
        SAVE_VARIABLE VARIABLE=use_swap VALUE={zuse_swap|int}
    {% endif %}

    {% set zchina_cloud = printer.save_variables.variables.china_cloud|default(0) | int %}
    {% if zchina_cloud == 1 %}
        RESPOND PREFIX="//" MSG="===Allow Chinese clouds=== // SAVE_ZMOD_DATA CHINA_CLOUD={zchina_cloud}"
    {% else %}
        RESPOND PREFIX="//" MSG="===Block Chinese clouds=== // SAVE_ZMOD_DATA CHINA_CLOUD={zchina_cloud}"
    {% endif %}
    SAVE_VARIABLE VARIABLE=china_cloud VALUE={zchina_cloud|int}

    {% set save_moonraker = printer.save_variables.variables.save_moonraker|default(0) | int %}
    {% if save_moonraker == 1 %}
        RESPOND PREFIX="//" MSG="===Save Fluidd/Mainsail button changes=== // SAVE_ZMOD_DATA SAVE_MOONRAKER={save_moonraker}"
    {% else %}
        RESPOND PREFIX="//" MSG="===Use Fluidd/Mainsail button settings from ZMOD=== // SAVE_ZMOD_DATA SAVE_MOONRAKER={save_moonraker}"
    {% endif %}
    SAVE_VARIABLE VARIABLE=save_moonraker VALUE={save_moonraker|int}

    {% set display_off_timeout = printer.save_variables.variables.display_off_timeout|default(180) | int %}
    {% if screen == False %}
        RESPOND PREFIX="//" MSG="===Turn off native screen after (sec): {display_off_timeout}=== // SAVE_ZMOD_DATA DISPLAY_OFF_TIMEOUT={display_off_timeout}"
    {% endif %}
    {% if display_off_timeout < 10 %}
        SAVE_VARIABLE VARIABLE=display_off_timeout VALUE=10
    {% else %}
        SAVE_VARIABLE VARIABLE=display_off_timeout VALUE={display_off_timeout|int}
    {% endif %}

    {% set zklipper12 = printer.save_variables.variables.klipper12|default(0) | int %}
    {% if zklipper12 == 1 %}
        RESPOND PREFIX="//" MSG="===Using Klipper 12==="
    {% else %}
        RESPOND PREFIX="//" MSG="===Using native Klipper==="
    {% endif %}
    SAVE_VARIABLE VARIABLE=klipper12 VALUE=0

    {% if screen == True %}
        SAVE_VARIABLE VARIABLE=display_off VALUE=0
    {% else %}
        SAVE_VARIABLE VARIABLE=display_off VALUE=1
    {% endif %}

    {% set znice = printer.save_variables.variables.nice|default(20) | int %}
    RESPOND PREFIX="//" MSG="===Klipper process priority (1-min, 40-max): {znice}==="
    SAVE_VARIABLE VARIABLE=nice VALUE={znice|int}
    RUN_SHELL_COMMAND CMD=znice

    ZCONTROL_STATUS
    {% set lang = printer.configfile.config.zmod.language|default("en") | string %}
    RESPOND PREFIX="//" MSG="===Available languages===: en, ru, de, fr, it, es, ja, ko, zh // LANG LANG={lang}"
    RUN_SHELL_COMMAND CMD=zversion

[gcode_macro SET_LED]
description: ===Save Z-Offset===
rename_existing: _SET_LED
variable_allowed: False
gcode:
    {% if allowed %}
        _SET_LED {% for p in params %}{'%s=%s '% (p, params[p])}{% endfor %}
    {% endif %}

[gcode_macro SET_GCODE_OFFSET]
description: ===Save Z-Offset===
rename_existing: _SET_GCODE_OFFSET
gcode:
    {% if printer.save_variables.variables.gcode_offsets %}
        {% set offsets = printer.save_variables.variables.gcode_offsets %}
    {% else %}
        {% set offsets = {'z': None} %}
    {% endif %}

    {% set ns = namespace(offsets={'z': offsets.z}) %}

    _SET_GCODE_OFFSET {% for p in params %}{'%s=%s '% (p, params[p])}{% endfor %}

    {% if 'Z' in params %}
        {% set null = ns.offsets.update({'z': params.Z}) %}
    {% endif %}

    {% if 'Z_ADJUST' in params %}
        {% if ns.offsets.z == None %}
            {% set null = ns.offsets.update({'z': 0}) %}
        {% endif %}
        {% set null = ns.offsets.update({'z': (ns.offsets.z | float) + (params.Z_ADJUST | float)}) %}
    {% endif %}

    {% set screen = printer["gcode_macro START_PRINT"].screen %}
    {% if screen == False %}
        SAVE_VARIABLE VARIABLE=gcode_offsets VALUE="{ns.offsets}"
    {% endif %}

[gcode_macro LOAD_GCODE_OFFSET]
description: ===Restore Z-Offset===
gcode:
    {% if printer.save_variables.variables.gcode_offsets %}
        {% set offsets = printer.save_variables.variables.gcode_offsets %}
        _SET_GCODE_OFFSET {% for axis, offset in offsets.items() if offsets[axis] %}{ "%s=%s " % (axis, offset) }{% endfor %}
        {% for axis, offset in offsets.items() if offsets[axis] %}
            { action_respond_info("===Loaded offset from global settings %s=%.4f=== " % (axis|upper, offset|float)) }
        {% endfor %}
    {% endif %}

[gcode_macro SET_FAN_SPEED]
description: ===Fans control===
rename_existing: _SET_FAN_SPEED
gcode:
    {% set fan = params.FAN|string %}
    {% if fan != 'pcb_fan' %}
        _SET_FAN_SPEED {% for p in params %}{'%s=%s '% (p, params[p])}{% endfor %}
    {% endif %}

[gcode_macro _SVG28]
gcode:
    SET_GCODE_VARIABLE MACRO=G28 VARIABLE=z VALUE={printer.toolhead.position.z}

[gcode_macro G28]
rename_existing: G28.1
variable_z: 220
gcode:
    {% if 'Z' in params or not('X' in params or 'Y' in params or 'Z' in params) %}
        G28.1 Z
        M400
        _SVG28
    {% endif %}
    {% if 'X' in params or not('X' in params or 'Y' in params or 'Z' in params) or ('Y' in params and ("x" not in printer.toolhead.homed_axes)) %}
        G28.1 X
        M400
    {% endif %}
    {% if 'Y' in params or not('X' in params or 'Y' in params or 'Z' in params) %}
        G28.1 Y
        M400
    {% endif %}

[gcode_macro _CANCEL_PRINT]
variable_cancel_send: 0
gcode:

[gcode_macro _CLIENT_LINEAR_MOVE]
description: ===Linear move with gcode state save/restore===
gcode:
    {% set client = printer['gcode_macro _CLIENT_VARIABLE'] | default({}) %}
    {% set e_move = "E" ~ params.E if params.E is defined else "" %}
    {% set rate = "F" ~ params.F if params.F is defined else "" %}
    {% set ABSOLUTE = params.ABSOLUTE | default(0) | int != 0 %}
    {% set z_max = [ printer['gcode_macro G28'].z | default(220), 220 ] | min %}
    {% if ABSOLUTE %}
        {% set x_move = "X" ~ ([ [params.X|float, client.max_x]  |min, client.min_x]| max) if params.X is defined else "" %}
        {% set y_move = "Y" ~ ([ [params.Y|float, client.max_y]  |min, client.min_y]| max) if params.Y is defined else "" %}
        {% set z_move = "Z" ~ ([ [params.Z|float, z_max]|min, 0   ]| max) if params.Z is defined else "" %}
    {% else %}
        {% set pos = printer.toolhead.position %}
        {% if params.X is defined %}
            {% set x_move = "X" ~ ([client.min_x - pos.x, [client.max_x - pos.x, params.X|float]| min]| max) %}
        {% else %}
            {% set x_move = "" %}
        {% endif %}
        {% if params.Y is defined %}
            {% set y_move = "Y" ~ ([client.min_y - pos.y, [client.max_y - pos.y, params.Y|float]| min]| max) %}
        {% else %}
            {% set y_move = "" %}
        {% endif %}
        {% if params.Z is defined %}
            {% set z_move = "Z" ~ ([- pos.z, [z_max - pos.z, params.Z|float]| min]| max) %}
        {% else %}
            {% set z_move = "" %}
        {% endif %}
    {% endif %}

    SAVE_GCODE_STATE NAME=_client_movement

    # Не двигаем головой во время печати
    {% if state != 'printing' %}
        {% set ABSOLUTE_E = params.ABSOLUTE_E | default(0) | int != 0 %}


        {% if x_move or y_move or z_move %}
            G9{ 0 if ABSOLUTE else 1 }
        {% endif %}
        {% if e_move %}
            M8{ 2 if ABSOLUTE_E else 3 }
        {% endif %}

        RESPOND PREFIX="//" MSG="G1 { x_move } { y_move } { z_move } { e_move } { rate }"
        G1 { x_move } { y_move } { z_move } { e_move } { rate }
    {% else %}
        RESPOND PREFIX="info" MSG="===Printing in progress. Movement is disabled.==="
    {% endif %}

    RESTORE_GCODE_STATE NAME=_client_movement

[gcode_macro SDCARD_PRINT_FILE]
rename_existing: BASE_SDCARD_PRINT_FILE
gcode:
    ZCONTROL_ABORT
    ZCONTROL_ON
    _G28
    G1 Z50 F3000
    BASE_SDCARD_PRINT_FILE {rawparams}

[gcode_macro SDCARD_RESET_FILE]
rename_existing: BASE_SDCARD_RESET_FILE
gcode:
    ZCONTROL_OFF
    BASE_SDCARD_RESET_FILE

[gcode_macro BELTS_SHAPER_CALIBRATION]
description: ===CoreXY half-axis test for belt frequency analysis===
gcode:
    {% set spectrogram = params.SPECTROGRAM|default(0)|int %}
    {% set client = printer['gcode_macro _CLIENT_VARIABLE'] | default({}) %}

    {% if not client.ff5x %}
        RESPOND PREFIX="!!" MSG="===Requires 256MB RAM + enabled SWAP. !!==="
        _GUPPY_BELTS_SHAPER_CALIBRATION SPECTROGRAM={spectrogram} PNG_WIDTH=10 PNG_HEIGHT=10 PNG_OUT_PATH="/opt/config/mod_data/belts_calibration_full.png"
    {% else %}
        _GUPPY_BELTS_SHAPER_CALIBRATION SPECTROGRAM=0 PNG_WIDTH=10 PNG_HEIGHT=10 PNG_OUT_PATH="/opt/config/mod_data/belts_calibration_full.png"
    {% endif %}

[gcode_macro _GUPPY_BELTS_SHAPER_CALIBRATION]
description: ===CoreXY half-axis test for belt frequency analysis===
gcode:
    {% set lang = printer.configfile.config.zmod.language|default("en") | string %}

    {% set min_freq = params.FREQ_START|default(5)|float %}
    {% set max_freq = params.FREQ_END|default(100)|float %}
    {% set hz_per_sec = params.HZ_PER_SEC|default(1)|float %}
    {% set png_out_path = params.PNG_OUT_PATH|default("/opt/config/mod_data/belts_calibration.png") %}
    {% set png_width = params.PNG_WIDTH|default(8)|float %}
    {% set png_height = params.PNG_HEIGHT|default(4.8)|float %}
    {% set spectrogram = params.SPECTROGRAM|default(0)|int %}

    TEST_RESONANCES AXIS=1,1 OUTPUT=raw_data NAME=b FREQ_START={min_freq} FREQ_END={max_freq} HZ_PER_SEC={hz_per_sec}
    M400

    TEST_RESONANCES AXIS=1,-1 OUTPUT=raw_data NAME=a FREQ_START={min_freq} FREQ_END={max_freq} HZ_PER_SEC={hz_per_sec}
    M400

    RESPOND MSG="===Generating belts frequency profile...==="
    RESPOND MSG="===This will take some time (3-5 minutes)==="

    {% if spectrogram == 1 %}
        RUN_SHELL_COMMAND CMD=guppy_belts_calibration PARAMS="-w {png_width} -l {png_height} -o {png_out_path} -k /usr/share/klipper /tmp/raw_data_axis=1.000,-1.000_a.csv /tmp/raw_data_axis=1.000,1.000_b.csv --{lang}"
    {% else %}
        RUN_SHELL_COMMAND CMD=guppy_belts_calibration PARAMS="-w {png_width} -l {png_height} -n -o {png_out_path} -k /usr/share/klipper /tmp/raw_data_axis=1.000,-1.000_a.csv /tmp/raw_data_axis=1.000,1.000_b.csv --{lang}"
    {% endif %}

    RESPOND PREFIX="info" MSG="===Image saved: {png_out_path}. Configuration -> mod_data==="
    RESPOND PREFIX="//" MSG="Command {guppy_belts_calibration} finished"

[gcode_macro _GUPPY_EXCITATE_AXIS_AT_FREQ]
description: ===Maintain frequency for vibration diagnostics===
gcode:
    {% set frequency = params.FREQUENCY|default(25)|int %}
    {% set time = params.TIME|default(10)|int %}
    {% set axis = params.AXIS|default("x")|string|lower %}

    {% if axis not in ["x", "y", "a", "b"] %}
      { action_raise_error("AXIS selection invalid. Should be either x, y, a or b!") }
    {% endif %}

    {% if axis == "a" %}
        {% set axis = "1,-1" %}
    {% elif axis == "b" %}
        {% set axis = "1,1" %}
    {% endif %}

    TEST_RESONANCES OUTPUT=raw_data AXIS={axis} FREQ_START={frequency-1} FREQ_END={frequency+1} HZ_PER_SEC={1/(time/3)}
    M400

[gcode_macro _GUPPY_MACRO]
description: ===Custom Guppy button===
gcode:
    PLAY_MIDI
    RESPOND TYPE=command MSG="===action:prompt_begin This is a test macro==="
    RESPOND TYPE=command MSG="===action:prompt_text Add _GUPPY_MACRO to mod_data/user.cfg==="
    RESPOND TYPE=command MSG="===action:prompt_text Example of _GUPPY_MACRO is in mod/base.cfg==="

    RESPOND TYPE=command MSG="action:prompt_footer_button Ok|RESPOND TYPE=command MSG=action:prompt_end|info"
    RESPOND TYPE=command MSG="action:prompt_show"

[gcode_macro ZSHAPER]
description: ===Input shaper calibration===
gcode:
    _G28
    RESPOND PREFIX="info" MSG="===Collecting X axis data==="
    TEST_RESONANCES AXIS=X NAME=x
    M400
    RESPOND PREFIX="info" MSG="===Collecting Y axis data==="
    TEST_RESONANCES AXIS=Y NAME=y
    M400
    RUN_SHELL_COMMAND CMD=zshaper_new

[gcode_macro _SPEED_SET]
description: ===Set 1/4->1/2->1 speed for 60s on print resume===
variable_speed1: 100
variable_speed2: 100
gcode:
    {% set zspeed = params.SPEED|default(100)|int %}

    SET_GCODE_VARIABLE MACRO=_SPEED_SET VARIABLE=speed1 VALUE={zspeed/2}
    SET_GCODE_VARIABLE MACRO=_SPEED_SET VARIABLE=speed2 VALUE={zspeed}
    M220 S{zspeed/4}
    UPDATE_DELAYED_GCODE ID=_SET_SPEED1 DURATION=60
    UPDATE_DELAYED_GCODE ID=_SET_SPEED2 DURATION=120

[delayed_gcode _SET_SPEED1]
initial_duration: 0
gcode:
    {% set speed = printer["gcode_macro _SPEED_SET"].speed1 %}
    M220 S{speed}

[delayed_gcode _SET_SPEED2]
initial_duration: 0
gcode:
    {% set speed = printer["gcode_macro _SPEED_SET"].speed2 %}
    M220 S{speed}

[gcode_macro ZRESTORE]
description: ===Resume interrupted print===
gcode:
    {% set test = params.TEST|default(0)|int %}

    {% set state = printer.print_stats.state %}
    {% set filename = printer.print_stats.filename %}
    {% set progress = printer.display_status.progress * 100 %}

    {% if test == 2 %}
        RESPOND PREFIX="info" MSG="===Saved data deleted==="
        RUN_SHELL_COMMAND CMD=rm PARAMS="/opt/config/mod_data/klipper_data.json"
    {% else %}
        {% if test == 1 and state != 'printing' and state != 'paused' %}
            RUN_SHELL_COMMAND CMD=zrestore PARAMS="test"
        {% else %}
            {% if state == 'printing' %}
                RESPOND PREFIX="info" MSG="===Currently printing: {filename} ({progress | round(1)}%), print recovery impossible==="
            {% elif state == 'paused' %}
                RESPOND PREFIX="info" MSG="===Paused: {filename}, print recovery impossible==="
            {% elif state == 'complete' %}
                RESPOND PREFIX="info" MSG="===Print completed==="
                RUN_SHELL_COMMAND CMD=zrestore
            {% elif state == 'error' %}
                RESPOND PREFIX="info" MSG="===Error: {printer.print_stats.message}==="
                RUN_SHELL_COMMAND CMD=zrestore
            {% else %}
                RESPOND PREFIX="info" MSG="===Status: {state}==="
                RUN_SHELL_COMMAND CMD=zrestore
            {% endif %}
        {% endif %}
    {% endif %}

[delayed_gcode _TEST_RESTORE]
initial_duration: 0
gcode:
    ZRESTORE TEST=1

[gcode_macro _ZRESTORE]
gcode:
    RESPOND TYPE=command MSG="action:prompt_begin ===Interrupted print detected==="
    RESPOND TYPE=command MSG="action:prompt_text ===Switch to console to view recovery stages==="
    RESPOND TYPE=command MSG="action:prompt_button_group_start"
    RESPOND TYPE=command MSG="action:prompt_button ===Restore===|_ZRESTORE_OK|primary"
    RESPOND TYPE=command MSG="action:prompt_button ===Delete data===|_ZRESTORE_DEL|primary"
    RESPOND TYPE=command MSG="action:prompt_button_group_end"
    RESPOND TYPE=command MSG="action:prompt_footer_button ===Cancel===|_ZRESTORE_CANCEL"
    RESPOND TYPE=command MSG="action:prompt_show"

[gcode_macro _ZRESTORE_OK]
gcode:
    RESPOND TYPE=command MSG="action:prompt_end"
    ZRESTORE

[gcode_macro _ZRESTORE_DEL]
gcode:
    RESPOND TYPE=command MSG="action:prompt_end"
    ZRESTORE TEST=2

[gcode_macro _ZRESTORE_CANCEL]
gcode:
    RESPOND TYPE=command MSG="action:prompt_end"

[gcode_macro _ZRESTORE_MESH_TEST]
gcode:
    {% set cur_mesh = printer['bed_mesh'].profile_name %}
    {% set mesh = params.MESH|default("auto") %}
    {% set screen = printer["gcode_macro START_PRINT"].screen %}

    {% if cur_mesh != mesh %}
        {% if screen == True %}
            RESPOND PREFIX="info" MSG="===Bed mesh {mesh} not found. Loaded MESH_DATA profile==="
            BED_MESH_PROFILE LOAD=MESH_DATA
        {% else %}
            RESPOND PREFIX="info" MSG="===Bed mesh {mesh} not found. Loaded auto profile==="
            BED_MESH_PROFILE LOAD=auto
        {% endif %}
    {% endif %}

[gcode_macro _ZRESTORE_MESH_LOAD]
gcode:
    {% set mesh = params.MESH|default("auto") %}

    BED_MESH_CLEAR
    M400
    {% for mesh_dt in printer['bed_mesh'].profiles %}
        {% if mesh == mesh_dt %}
            BED_MESH_PROFILE LOAD={mesh}
            RESPOND PREFIX="info" MSG="===Bed mesh {mesh} loaded==="
        {% endif %}
    {% endfor %}
    _ZRESTORE_MESH_TEST MESH={mesh}

# Использование: SET_PAUSE_NEXT_LAYER [ENABLE=[0 | 1]] [MACRO=<name>]
[gcode_macro SET_PAUSE_NEXT_LAYER]
description: ===Enable pause at next layer===
gcode:
    {% set pause_next_layer = printer['gcode_macro SET_PRINT_STATS_INFO'].pause_next_layer %}
    {% set ENABLE = params.ENABLE | default(1)|int != 0 %}
    {% set MACRO = params.MACRO | default(pause_next_layer.call, True) %}
    SET_GCODE_VARIABLE MACRO=SET_PRINT_STATS_INFO VARIABLE=pause_next_layer VALUE="{{ 'enable': ENABLE, 'call': MACRO }}"

# Usage: SET_PAUSE_AT_LAYER [ENABLE=[0 | 1]] [LAYER=<number>] [MACRO=<name>]
[gcode_macro SET_PAUSE_AT_LAYER]
description: ===Enable/disable pause at specific layer===
gcode:
    {% set pause_at_layer = printer['gcode_macro SET_PRINT_STATS_INFO'].pause_at_layer %}
    {% set ENABLE = params.ENABLE | int != 0 if params.ENABLE is defined
             else params.LAYER is defined %}
    {% set LAYER = params.LAYER | default(pause_at_layer.layer) | int %}
    {% set MACRO = params.MACRO | default(pause_at_layer.call, True) %}
    SET_GCODE_VARIABLE MACRO=SET_PRINT_STATS_INFO VARIABLE=pause_at_layer VALUE="{{ 'enable': ENABLE, 'layer': LAYER, 'call': MACRO }}"

# Использование: SET_PRINT_STATS_INFO [TOTAL_LAYER=<total_layer_count>] [CURRENT_LAYER= <current_layer>]
[gcode_macro SET_PRINT_STATS_INFO]
rename_existing: SET_PRINT_STATS_INFO_BASE
description: ===Override to get pause_next_layer and pause_at_layer functions===
variable_pause_next_layer: { 'enable': False, 'call': "PAUSE" }
variable_pause_at_layer  : { 'enable': False, 'layer': 0, 'call': "PAUSE" }
gcode:
    {% if pause_next_layer.enable %}
        RESPOND TYPE=echo MSG='{"%s, SET_PAUSE_AT_LAYER " % pause_next_layer.call}'
        {pause_next_layer.call} ; execute the given gcode to pause, should be either M600 or PAUSE
        SET_PAUSE_NEXT_LAYER ENABLE=0
    {% elif pause_at_layer.enable and params.CURRENT_LAYER is defined and params.CURRENT_LAYER | int == pause_at_layer.layer %}
        RESPOND TYPE=echo MSG='{"%s, pause_at_layer [%d]" % (pause_at_layer.call, pause_at_layer.layer)}'
        {pause_at_layer.call} ; execute the given gcode to pause, should be either M600 or PAUSE
        SET_PAUSE_AT_LAYER ENABLE=0
    {% endif %}
    SET_PRINT_STATS_INFO_BASE {rawparams}

[gcode_macro ZFLASH]
description: ===Update printer via USB===
gcode:
    RUN_SHELL_COMMAND CMD=zflash

[gcode_macro _DISABLE_SENSOR]
gcode:
    {% set client = printer['gcode_macro _CLIENT_VARIABLE'] | default({}) %}

    {% if client.runout_sensor | default("") != "" %}
        {% if printer[client.runout_sensor].enabled %}
            SET_GCODE_VARIABLE MACRO=_ENABLE_SENSOR VARIABLE=allowed VALUE=True
            SET_FILAMENT_SENSOR SENSOR=e0_sensor ENABLE=0
        {% else %}
            SET_GCODE_VARIABLE MACRO=_ENABLE_SENSOR VARIABLE=allowed VALUE=False
        {% endif %}
    {% endif %}

[gcode_macro _ENABLE_SENSOR]
variable_allowed: False
gcode:
    {% if allowed %}
        SET_FILAMENT_SENSOR SENSOR=e0_sensor ENABLE=1
    {% endif %}

[gcode_macro LANG]
gcode:
    {% set lang = params.LANG|default("en") %}

    RUN_SHELL_COMMAND CMD=zlang PARAMS="{lang}"
