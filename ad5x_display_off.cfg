# (C) 2024-2026 ghzserg https://zmod.link/

[include base_display_off.cfg]
[include ad5x_config_off.cfg]

[zmod_color]
display: False

[zmod_ifs]
debug: False

[gcode_macro _PRINT_IFS_MOTION]
gcode:
    {% set zpause  = params.PAUSE| default(1) | int %}

    {% if zpause == 1 %}
        RESPOND TYPE=error MSG="===Filament jam detected=== (IFS)."
        RESPOND PREFIX=tgalarm_photo MSG="===Filament jam detected=== (IFS)."
        _NOTIFY MSG="===Filament jam detected=== (IFS)." TYPE=filament

        PAUSE
    {% else %}
        RESPOND PREFIX=info MSG="===Filament runout detected=== (IFS)."
        RESPOND PREFIX=tgalarm_photo MSG="===Filament runout detected=== (IFS)."
        _NOTIFY MSG="===Filament runout detected=== (IFS)." TYPE=filament

        RESPOND PREFIX=info MSG="Auto run _RESUME_MOTION_SENSOR"
        RESPOND PREFIX=tgalarm MSG="Auto run _RESUME_MOTION_SENSOR"
        _NOTIFY MSG="===Auto run _RESUME_MOTION_SENSOR===" TYPE=filament PHOTO=0

        _RESUME_MOTION_SENSOR
    {% endif %}

[zmod_ifs_motion_sensor ifs_motion_sensor]
pause_on_runout: False
runout_gcode:
    IFS_MOTION

[zmod_ifs_switch_sensor head_switch_sensor]
pause_on_runout: True
runout_gcode:
    SET_GCODE_VARIABLE MACRO=_A_CHANGE_FILAMENT VARIABLE=purge VALUE=0
    _ENABLE_SENSOR
    ANALOG_PRUTOK

[gcode_macro _PRINT_HEAD]
gcode:
    {% set info = params.INFO| default(1) | int %}
    {% set channel = params.CHANNEL| default(0) | int %}

    {% if info == 1 %}
        RESPOND PREFIX=info MSG="===Filament runout detected=== (Head) ===Loading a similar rod for the tool=== T{channel}"
        RESPOND PREFIX=tgalarm_photo MSG="===Filament runout detected=== (Head) ===Loading a similar rod for the tool=== T{channel}"
        _NOTIFY MSG="===Filament runout detected=== (Head) ===Loading a similar rod for the tool=== T{channel}" TYPE=filament
    {% else %}
        RESPOND TYPE=error MSG="===Filament runout detected=== (Head)"
        RESPOND PREFIX=tgalarm_photo MSG="===Filament runout detected=== (Head)"
        _NOTIFY MSG="===Filament runout detected=== (Head)" TYPE=filament
    {% endif %}
    
[gcode_macro _COLOR_CHANGE_PARAMS]
# Call without params to clear
variable_nopoop_enabled: 0
variable_new_material_temperature: 0
gcode:
    SET_GCODE_VARIABLE MACRO=_COLOR_CHANGE_PARAMS VARIABLE=nopoop_enabled VALUE={params.NOPOOP_MODE|default(0)|int}
    SET_GCODE_VARIABLE MACRO=_COLOR_CHANGE_PARAMS VARIABLE=new_material_temperature VALUE={params.NEW_MATERIAL_TEMPERATURE|default(0)|int}

[gcode_macro _A_CHANGE_FILAMENT]
variable_purge: 0
gcode:
    {% set channel          = params.CHANNEL| int %}
    {% set restore_temp     = params.RESTORE_TEMP| default(1)| int %}
    {% set restore_position = params.RESTORE_POSITION| default(1)| int %}
    {% set use_trash_on_print = printer.save_variables.variables.use_trash_on_print|default(1) | int %}

    {% set temp = printer[printer.toolhead.extruder].target if printer.toolhead.extruder != '' else 0 %}
    {% set fan_speed = printer["fan_generic fanM106"].speed %}

    {% if restore_position == 1 %}
        SET_GCODE_VARIABLE MACRO=_RESTORE_POSITION_AFTER_FILAMENT_CHANGE VARIABLE=restore_x VALUE={printer.gcode_move.gcode_position.x}
        SET_GCODE_VARIABLE MACRO=_RESTORE_POSITION_AFTER_FILAMENT_CHANGE VARIABLE=restore_y VALUE={printer.gcode_move.gcode_position.y}
        SET_GCODE_VARIABLE MACRO=_RESTORE_POSITION_AFTER_FILAMENT_CHANGE VARIABLE=restore_z VALUE={printer.gcode_move.gcode_position.z}

        M400
        SAVE_GCODE_STATE NAME=change_filament
        {% if use_trash_on_print != 2 %}
          SET_VELOCITY_LIMIT ACCEL=10000
        {% endif %}
        {% if "z" in printer.toolhead.homed_axes and printer.toolhead.position.z + 5 <= 220 %}
            G91
            G1 Z5
            M400
            RESPOND PREFIX="//" MSG="===Moving the bed down 5 mm==="
        {% endif %}
        RESTORE_GCODE_STATE MOVE=0 NAME=change_filament

        M400
        SAVE_GCODE_STATE NAME=change_filament_after_z_move
    {% endif %}

    SET_GCODE_VARIABLE MACRO=END_CHANGE_FILAMENT VARIABLE=last_data VALUE="{{'restore_position': restore_position, 'restore_temp': restore_temp, 'temp': temp, 'fan_speed': fan_speed, 'channel': channel}}"

    RESPOND PREFIX="info" MSG="T{channel}"
    {% if purge == 1 %}
        PURGE_PRUTOK_IFS
    {% endif %}
    SET_GCODE_VARIABLE MACRO=_A_CHANGE_FILAMENT VARIABLE=purge VALUE=0
    _CHANGE_FILAMENT CHANNEL={channel} RESTORE={restore_temp}

[gcode_macro END_CHANGE_FILAMENT]
variable_last_data: {'restore_position': 0, 'restore_temp': 0, 'temp': 0, 'fan_speed': 0, 'channel': 99}
gcode:
    {% set resume  = params.RESUME| default(0)| int %}
    {% set use_trash_on_print = printer.save_variables.variables.use_trash_on_print|default(1) | int %}
    {% if printer["gcode_macro _COLOR_CHANGE_PARAMS"].nopoop_enabled == 1 %}
      {% set use_trash_on_print = 0 %}
    {% endif %}

    {% if last_data.restore_temp == 1 %}
        {% if last_data.temp | int != 0 and use_trash_on_print < 2 %}
            RESPOND PREFIX="info" MSG="Temp: T{last_data.temp}"
            _WAIT_TEMP EXTRUDER_TEMP={last_data.temp} BED_TEMP=0 NAME=END_CHANGE_FILAMENT
#            M109 S{last_data.temp}
        {% endif %}
        RESPOND PREFIX="info" MSG="Fan: {last_data.fan_speed*100}"
        SET_FAN_SPEED FAN=fanM106 SPEED={last_data.fan_speed}
    {% endif %}

    {% if resume == 0 %}
        SDCARD_SET_CHANNEL CHANNEL={last_data.channel}
        SDCARD_CLEAR_REFUELLING
    {% endif %}

    {% if last_data.restore_position == 1 %}
        {% if use_trash_on_print == 0 %}
            M400
            G92 E0
        {% elif use_trash_on_print == 1 %}
            RESPOND PREFIX="info" MSG="Restore position change_filament"
            RESTORE_GCODE_STATE MOVE=1 MOVE_SPEED=500 NAME=change_filament_after_z_move
            RESTORE_GCODE_STATE MOVE=1 NAME=change_filament
        {% endif %}
    {% endif %}
    SET_GCODE_VARIABLE MACRO=END_CHANGE_FILAMENT VARIABLE=last_data VALUE="{{'restore_position': 0, 'restore_temp': 0, 'temp': 0, 'fan_speed': 0, 'channel': 99}}"

    IFS_MOTION_ON
    IFS_SWITCH_ON
    _COLOR_CHANGE_PARAMS
    
[gcode_macro _RESTORE_POSITION_AFTER_FILAMENT_CHANGE]
variable_restore_x: -100
variable_restore_y: -100
variable_restore_z: -100
gcode:
    {% set client = printer['gcode_macro _CLIENT_VARIABLE'] | default({}) %}
    {% set restore_x = printer["gcode_macro _RESTORE_POSITION_AFTER_FILAMENT_CHANGE"].restore_x %}
    {% set restore_y = printer["gcode_macro _RESTORE_POSITION_AFTER_FILAMENT_CHANGE"].restore_y %}
    {% set restore_z = printer["gcode_macro _RESTORE_POSITION_AFTER_FILAMENT_CHANGE"].restore_z %}

    {% if restore_x < client.min_x or restore_y < client.min_y %}
        G1 Y0 F18000
        RESTORE_GCODE_STATE MOVE=1 MOVE_SPEED=500 NAME=change_filament_after_z_move
        RESTORE_GCODE_STATE MOVE=1 NAME=change_filament
        G90
    {% else %}
        {% set midpoint_x = client.max_x / 2 %}
        {% set midpoint_y = client.max_y / 2 %}

        {% set magnitude_x = (midpoint_x - restore_x)|abs %}
        {% set magnitude_y = (midpoint_y - restore_y)|abs %}

        G90
        G1 Y0 F18000

        {% if restore_y > midpoint_y or magnitude_y < magnitude_x %}
            {% if restore_x < midpoint_x %}
              G1 X{client.min_x}
            {% else %}
              G1 X{client.max_x}
            {% endif %}

            {% if magnitude_y < magnitude_x %}
              G1 Y{restore_y}
            {% else %}
              G1 Y{client.max_y}
              G1 X{restore_x}
            {% endif %}
        {% else %}
            G1 X{restore_x}
        {% endif %}

        G1 X{restore_x} Y{restore_y}
        G1 Z{restore_z}

        RESTORE_GCODE_STATE MOVE=0 NAME=change_filament
    {% endif %}

    M400
    SET_GCODE_VARIABLE MACRO=_RESTORE_POSITION_AFTER_FILAMENT_CHANGE VARIABLE=restore_x VALUE=-100
    SET_GCODE_VARIABLE MACRO=_RESTORE_POSITION_AFTER_FILAMENT_CHANGE VARIABLE=restore_y VALUE=-100
    SET_GCODE_VARIABLE MACRO=_RESTORE_POSITION_AFTER_FILAMENT_CHANGE VARIABLE=restore_z VALUE=-100

[gcode_macro _IFS_OFF]
gcode:
    RESPOND PREFIX="info" MSG="IFS Off"
    SDCARD_ENABLE_FFM ENABLE=0
    _SET_FILAMENT_SENSOR SENSOR=ifs_motion_sensor ENABLE=0

[gcode_macro _IFS_ON]
gcode:
    RESPOND PREFIX="info" MSG="IFS On"
    SDCARD_ENABLE_FFM ENABLE=1
    _SET_FILAMENT_SENSOR SENSOR=ifs_motion_sensor ENABLE=1

[gcode_macro _RESUME_MOTION_SENSOR]
gcode:
    {% set client = printer['gcode_macro _CLIENT_VARIABLE'] | default({}) %}

    {% if client.runout_sensor2 | default("") != "" %}
        {% if printer[client.runout_sensor2].enabled %}
            SET_GCODE_VARIABLE MACRO=_ENABLE_SENSOR VARIABLE=allowed2 VALUE=True
            _SET_FILAMENT_SENSOR SENSOR=ifs_motion_sensor ENABLE=0
        {% else %}
            SET_GCODE_VARIABLE MACRO=_ENABLE_SENSOR VARIABLE=allowed2 VALUE=False
        {% endif %}
    {% endif %}
    SET_GCODE_VARIABLE MACRO=_A_CHANGE_FILAMENT VARIABLE=purge VALUE=1
#    SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=idle_state VALUE=True
    M400
#    RESUME

[gcode_macro _RESUME_MACRO]
gcode:
    {% set client = printer['gcode_macro _CLIENT_VARIABLE'] | default({}) %}

    RESPOND PREFIX="info" MSG="_RESUME_MACRO"
    _GOTO_TRASH
    # M106 S51

    # G92 E0
    # G1 E90 F300
    # M400

    #M106 S102

    G92 E0
    G1 E-3 F300
    M400
    G92 E0

    G1 Y{client.max_y} F12000
    G1 Y{client.custom_park_y} F3000
    G1 Y{client.max_y} F12000
    G1 Y{client.custom_park_y} F3000
    G1 Y{client.max_y} F12000
    M400
    #SET_FAN_SPEED FAN=fanM106 SPEED=0
    G90
    G1 Y{client.max_y} F3000
    G1 X78 F12000
    G1 Y{client.custom_park_y} F3000
    G1 X65 F12000
    G1 X73
    G1 X65
    G1 X73
    G1 X65
    G1 X78
    G1 Y{client.max_y}
    M400
    END_CHANGE_FILAMENT RESUME=1

[gcode_macro _IFS_AUTOINSERT]
gcode:
    {% set autoinsert = printer.save_variables.variables.autoinsert|default(1) | int %}
    {% set prutok = params.PRUTOK|default(1)|int %}

    {% if autoinsert == 1 %}
        IFS_AUTOINSERT PRUTOK={prutok}
    {% endif %}

[gcode_macro _SBROS_TRASH]
description: Сброс через какашник без выдавливания
gcode:
    {% set client = printer['gcode_macro _CLIENT_VARIABLE'] | default({}) %}

    G1 Y{client.max_y} F30000      ; Выход из какашника
    G1 Y{client.custom_park_y} F3000    ; Вход в какашник
    G1 Y{client.max_y} F30000      ; Выход из какашника
    M400

[gcode_macro _SBROS_TRASH_DAVIM]
description: Сброс через какашник c выдавливанием
gcode:
    {% set prutok                          = params.PRUTOK|default(0)|int %}
    {% set filament_fan_speed              = params.FILAMENT_FAN_SPEED|default(102)|int %}
    {% set filament_load_speed             = params.FILAMENT_LOAD_SPEED|default(300)|int %}
    {% set filament_drop_length            = params.FILAMENT_DROP_LENGTH|default(90)|int %}
    {% set filament_drop_length_add        = params.FILAMENT_DROP_LENGTH_ADD|default(0)|int %}
    {% set filament_unload_after_drop      = params.FILAMENT_UNLOAD_AFTER_DROP|default(3)|float %}

    {% set skip_trash_move                 = params.SKIP_TRASH_MOVE|default(0)|int %}

    {% set use_trash_on_print = printer.save_variables.variables.use_trash_on_print|default(1) | int %}

    {% if printer.print_stats.state != 'printing' or use_trash_on_print == 1 or skip_trash_move == 0 %}
        _GOTO_TRASH
    {% endif %}

    M106 S{filament_fan_speed|float/2|int} ; M106 S51

    G92 E0
    RESPOND PREFIX="info" MSG="===Drop filament {filament_drop_length} + {filament_drop_length_add}. Speed {filament_load_speed}==="

    _DISABLE_SENSOR
        G1 E{filament_drop_length+filament_drop_length_add} F{filament_load_speed}   ; G1 E90 F300

        {% if prutok != 0 %}
            IFS_F10 PRUTOK={prutok} LEN={filament_drop_length+filament_drop_length_add} SPEED={filament_load_speed} SLEEP=1
            IFS_F39 PRUTOK={prutok}
            IFS_F112
            IFS_F39 PRUTOK={prutok}
        {% endif %}
        M400
    _ENABLE_SENSOR

    {% if printer.print_stats.state != 'printing' or use_trash_on_print == 1 %}
        M106 S{filament_fan_speed}      ; M106 S102
        G4 P4000
    {% endif %}

    {% if filament_unload_after_drop != 0 %}
        ; Ретракт
        G92 E0

        _DISABLE_SENSOR
            G1 E-{filament_unload_after_drop} F{filament_load_speed}
            M400
        _ENABLE_SENSOR
    {% endif %}

    G92 E0

[gcode_macro _INSERT_PRUTOK_IFS]
description: ===Loading filament=== IFS + Extruder
variable_last_filament_unload_before_cutting: -1
gcode:
    {% set temp = printer[printer.toolhead.extruder].target if printer.toolhead.extruder != '' else 0 %}

    {% set prutok                          = params.PRUTOK|default(1)|int %}
    {% set extruder_temp                   = params.TEMP|default(220)|int %}
    {% set need_stop                       = params.NEED_STOP|default(1)|int %}
    {% set trash                           = params.TRASH|default(0)|int %}

    {% set filament_type                   = params.FILAMENT_TYPE|default("PLA")|string %}
    {% set filament_unload_before_cutting  = params.FILAMENT_UNLOAD_BEFORE_CUTTING|default(0)|float %}
    {% set filament_unload_after_cutting   = params.FILAMENT_UNLOAD_AFTER_CUTTING|default(5)|float %}
    {% set filament_unload_after_drop      = params.FILAMENT_UNLOAD_AFTER_DROP|default(3)|float %}
    {% set filament_unload_speed           = params.FILAMENT_UNLOAD_SPEED|default(600)|int %}
    {% set filament_load_speed             = params.FILAMENT_LOAD_SPEED|default(300)|int %}
    {% set filament_tube_length            = params.FILAMENT_TUBE_LENGTH|default(1000)|int %}
    {% set filament_drop_length            = params.FILAMENT_DROP_LENGTH|default(90)|int %}
    {% set filament_drop_length_add        = params.FILAMENT_DROP_LENGTH_ADD|default(0)|int %}
    {% set filament_fan_speed              = params.FILAMENT_FAN_SPEED|default(102)|int %}

    {% set use_trash_on_print = printer.save_variables.variables.use_trash_on_print|default(1) | int %}
    {% if printer["gcode_macro _COLOR_CHANGE_PARAMS"].nopoop_enabled == 1 %}
      {% set use_trash_on_print = 0 %}
    {% endif %}
    
    {% if printer["gcode_macro _COLOR_CHANGE_PARAMS"].new_material_temperature > 0 and printer.print_stats.state == 'printing' %}
        {% set extruder_temp = printer["gcode_macro _COLOR_CHANGE_PARAMS"].new_material_temperature %}
        {% set bypass_remove_temperature = 1 %}
    {% else %}
        {% set bypass_remove_temperature = 0 %}
    {% endif %}

    RESPOND PREFIX="info" MSG="===Loading filament=== {prutok} {filament_type}"
    _G28
    {% if trash == 1 %}
        _GOTO_TRASH
    {% endif %}

    IFS_REMOVE_CURRENT_PRUTOK TEMP={temp} BYPASS_TEMPERATURE_CHECK={bypass_remove_temperature}
    
    {% if printer.print_stats.state != 'printing' or use_trash_on_print == 1 %}
        _GOTO_TRASH
    {% endif %}

    RESPOND PREFIX="info" MSG="===Heating the nozzle to {extruder_temp} degrees==="
    M104 S{extruder_temp}

    IFS_F24 PRUTOK={prutok}
    IFS_F10 PRUTOK={prutok} LEN={filament_tube_length} SPEED={filament_unload_speed} CHECK=1  # Not a mistake. Unload speed is used until it's actually loading into the extruder.

    {% if printer.print_stats.state != 'printing' or use_trash_on_print == 1 %}
        TEMPERATURE_WAIT SENSOR=extruder MINIMUM={extruder_temp-2} MAXIMUM={extruder_temp+4}
        _SBROS_TRASH_DAVIM PRUTOK={prutok} FILAMENT_FAN_SPEED={filament_fan_speed} FILAMENT_DROP_LENGTH={filament_drop_length} FILAMENT_DROP_LENGTH_ADD={filament_drop_length_add} FILAMENT_LOAD_SPEED={filament_load_speed} FILAMENT_UNLOAD_AFTER_DROP=0
        _SBROS_TRASH
        _CLEAR_REZINA

        _SBROS_TRASH_DAVIM PRUTOK=0        FILAMENT_FAN_SPEED={filament_fan_speed} FILAMENT_DROP_LENGTH={filament_drop_length} FILAMENT_DROP_LENGTH_ADD={filament_drop_length_add} FILAMENT_LOAD_SPEED={filament_load_speed} FILAMENT_UNLOAD_AFTER_DROP={filament_unload_after_drop}
        _SBROS_TRASH
        _CLEAR_REZINA
    {% else %}
        {% set last_filament_unload_before_cutting = printer["gcode_macro _INSERT_PRUTOK_IFS"].last_filament_unload_before_cutting %}
        {% if last_filament_unload_before_cutting < 0 %}
          {% set last_filament_unload_before_cutting = filament_unload_before_cutting %}
        {% endif %}
        _SBROS_TRASH_DAVIM PRUTOK={prutok} FILAMENT_FAN_SPEED={filament_fan_speed} FILAMENT_DROP_LENGTH={(12 + last_filament_unload_before_cutting)|float} FILAMENT_DROP_LENGTH_ADD=0 FILAMENT_LOAD_SPEED={filament_load_speed} FILAMENT_UNLOAD_AFTER_DROP=0 SKIP_TRASH_MOVE=1
        SET_GCODE_VARIABLE MACRO=_INSERT_PRUTOK_IFS VARIABLE=last_filament_unload_before_cutting VALUE=-1
        {% if use_trash_on_print == 0 %}
            TEMPERATURE_WAIT SENSOR=extruder MINIMUM={extruder_temp-2} MAXIMUM={extruder_temp+4}
            # If in poop mode, we let the slicer determine when to wait for temperature. We don't get here in the first place in USE_TRASH_ON_PRINT=1.
        {% endif %}
    {% endif %}

    IFS_F23 PRUTOK={prutok}
    M106 S0

    {% if need_stop == 1 %}
        M104 S0 T0
    {% endif %}
    IFS_EXTRUDER_SENSOR
    {% if prutok != 0 %}
        _SET_EXTRUDER_SLOT SLOT={prutok}
        SET_CURRENT_PRUTOK
    {% endif %}
    
    {% if printer.print_stats.state == 'printing' and use_trash_on_print == 0 %}
        {% if printer["gcode_macro _RESTORE_POSITION_AFTER_FILAMENT_CHANGE"].restore_z >= printer.save_variables.variables['nopoop_trash_skip_height']|default(0)|float %}
            G91
            G1 X0.75 Y0.75 F1200
            G1 X-0.75 Y0.75
            G1 X-1.5 Y-1.5
            G1 X1.5 Y-1.5
            G1 X1.5 Y1.5
            G1 X-1.5 Y1.5
            G1 X-1.5 Y-1.5
            G1 X0.75 Y-0.75
            G1 X0.75 Y0.75
            G90
        {% else %}
            {% set old_fan_speed = printer["fan_generic fanM106"].speed|float %}
            SET_FAN_SPEED FAN=fanM106 SPEED=1            
            G4 P4000
            M400
            SET_FAN_SPEED FAN=fanM106 SPEED={old_fan_speed}
            _SBROS_TRASH
            RESTORE_GCODE_STATE MOVE=1 MOVE_SPEED=500 NAME=change_filament_after_z_move
            RESTORE_GCODE_STATE MOVE=1 NAME=change_filament
        {% endif %}
    {% endif %}

[gcode_macro _PURGE_PRUTOK_IFS]
description: ===Purge filament=== IFS
gcode:
    {% set prutok                          = params.PRUTOK|default(1)|int %}

    {% set filament_type                   = params.FILAMENT_TYPE|default("PLA")|string %}
    {% set filament_unload_before_cutting  = params.FILAMENT_UNLOAD_BEFORE_CUTTING|default(0)|float %}
    {% set filament_unload_after_cutting   = params.FILAMENT_UNLOAD_AFTER_CUTTING|default(5)|float %}
    {% set filament_unload_after_drop      = params.FILAMENT_UNLOAD_AFTER_DROP|default(3)|float %}
    {% set filament_unload_speed           = params.FILAMENT_UNLOAD_SPEED|default(600)|int %}
    {% set filament_load_speed             = params.FILAMENT_LOAD_SPEED|default(300)|int %}
    {% set filament_tube_length            = params.FILAMENT_TUBE_LENGTH|default(1000)|int %}
    {% set filament_drop_length            = params.FILAMENT_DROP_LENGTH|default(90)|int %}
    {% set filament_drop_length_add        = params.FILAMENT_DROP_LENGTH_ADD|default(0)|int %}
    {% set filament_fan_speed              = params.FILAMENT_FAN_SPEED|default(102)|int %}

    RESPOND PREFIX="info" MSG="===Purge filament=== {prutok} {filament_type}"
    _G28

    _SBROS_TRASH_DAVIM PRUTOK=0        FILAMENT_FAN_SPEED={filament_fan_speed} FILAMENT_DROP_LENGTH={filament_drop_length} FILAMENT_DROP_LENGTH_ADD={filament_drop_length_add} FILAMENT_LOAD_SPEED={filament_load_speed} FILAMENT_UNLOAD_AFTER_DROP={filament_unload_after_drop}
    _SBROS_TRASH
    _CLEAR_REZINA

[gcode_macro _REMOVE_PRUTOK_IFS]
description: ===Unloading filament=== Extruder + IFS
gcode:
    {% set temp = printer[printer.toolhead.extruder].target if printer.toolhead.extruder != '' else 0 %}

    {% set prutok                          = params.PRUTOK|default(1)|int %}
    {% set extruder_temp                   = params.TEMP|default(220)|int %}
    {% set need_stop                       = params.NEED_STOP|default(1)|int %}

    {% set filament_type                   = params.FILAMENT_TYPE|default("PLA")|string %}
    {% set filament_unload_before_cutting  = params.FILAMENT_UNLOAD_BEFORE_CUTTING|default(0)|float %}
    {% set filament_unload_after_cutting   = params.FILAMENT_UNLOAD_AFTER_CUTTING|default(5)|float %}
    {% set filament_load_speed             = params.FILAMENT_LOAD_SPEED|default(300)|int %}
    {% set filament_unload_speed           = params.FILAMENT_UNLOAD_SPEED|default(600)|int %}
    {% set filament_tube_length            = params.FILAMENT_TUBE_LENGTH|default(1000)|int %}
    {% set nozzle_cleaning_length          = params.NOZZLE_CLEANING_LENGTH|default(60)|int %}

    RESPOND PREFIX="info" MSG="===Unloading filament=== {prutok} {filament_type}"
    _G28
    _GOTO_TRASH

    {% if prutok == 0 %}
        RESPOND PREFIX="info" MSG="===Heating the nozzle to {extruder_temp} degrees==="
        M104 S{extruder_temp}
        TEMPERATURE_WAIT SENSOR=extruder MINIMUM={extruder_temp-2} MAXIMUM={extruder_temp+4}

        _CUT_PRUTOK FILAMENT_UNLOAD_BEFORE_CUTTING={filament_unload_before_cutting} FILAMENT_UNLOAD_AFTER_CUTTING={filament_unload_after_cutting} FILAMENT_UNLOAD_SPEED={filament_unload_speed}
        
        G92 E0
        
        _DISABLE_SENSOR
        {% set retract_without_ifs_distance = 15 - filament_unload_after_cutting %}
        {% set retract_with_both_distance = 20 - retract_without_ifs_distance - filament_unload_after_cutting %}
        G1 E-{retract_without_ifs_distance} F{filament_unload_speed / 2}
        M400
        IFS_F24 PRUTOK={prutok}
        G1 E-{retract_with_both_distance} F{filament_unload_speed}
        IFS_F11 PRUTOK={prutok} LEN={retract_with_both_distance} SPEED={filament_unload_speed}
        M400
        IFS_F11 PRUTOK={prutok} LEN={filament_tube_length} SPEED={filament_unload_speed}
        IFS_F112
        _ENABLE_SENSOR        

        G92 E0
    {% else %}
        IFS_REMOVE_CURRENT_PRUTOK TEMP={temp}

        IFS_F24 PRUTOK={prutok}
        IFS_F11 PRUTOK={prutok} LEN={filament_tube_length} SPEED={filament_unload_speed}

        IFS_F39 PRUTOK={prutok}
        IFS_F112

        IFS_EXTRUDER_SENSOR INFO=1
        _SET_EXTRUDER_SLOT SLOT={prutok}
        SET_CURRENT_PRUTOK
    {% endif %}

    M106 S0

    {% if need_stop == 1 %}
        M104 S0 T0
    {% endif %}


[gcode_macro _IFS_REMOVE_PRUTOK]
gcode:
    {% set temp = printer[printer.toolhead.extruder].target if printer.toolhead.extruder != '' else 0 %}
    {% set use_trash_on_print = printer.save_variables.variables.use_trash_on_print|default(1) | int %}
    {% if printer["gcode_macro _COLOR_CHANGE_PARAMS"].nopoop_enabled == 1 %}
      {% set use_trash_on_print = 0 %}
    {% endif %}

    {% set prutok                          = params.PRUTOK|default(1)|int %}
    {% set extruder_temp                   = params.TEMP|default(220)|int %}

    {% set filament_type                   = params.FILAMENT_TYPE|default("PLA")|string %}
    {% set filament_unload_before_cutting  = params.FILAMENT_UNLOAD_BEFORE_CUTTING|default(0)|float %}
    {% set filament_unload_after_cutting   = params.FILAMENT_UNLOAD_AFTER_CUTTING|default(5)|float %}
    {% set filament_load_speed             = params.FILAMENT_LOAD_SPEED|default(300)|int %}
    {% set filament_unload_speed           = params.FILAMENT_UNLOAD_SPEED|default(600)|int %}
    {% set filament_tube_length            = params.FILAMENT_TUBE_LENGTH|default(1000)|int %}
    {% set nozzle_cleaning_length          = params.NOZZLE_CLEANING_LENGTH|default(60)|int %}

    {% set need_trash                      = params.NEED_TRASH|default(0)|int %}
    
    {% set above_trash_skip_height = printer["gcode_macro _RESTORE_POSITION_AFTER_FILAMENT_CHANGE"].restore_z >= printer.save_variables.variables['nopoop_trash_skip_height']|default(0)|float %}

    RESPOND PREFIX="info" MSG="Extracting filament from the extruder {prutok} {filament_type}"
    _CUT_PRUTOK FILAMENT_UNLOAD_SPEED={filament_unload_speed} FILAMENT_UNLOAD_BEFORE_CUTTING={filament_unload_before_cutting} FILAMENT_UNLOAD_AFTER_CUTTING={filament_unload_after_cutting}
    {% if printer.print_stats.state == 'printing' and use_trash_on_print == 0 and need_trash == 0 and above_trash_skip_height == 1 %}
        _RESTORE_POSITION_AFTER_FILAMENT_CHANGE
        M400
    {% else %}
        _GOTO_TRASH SPEED=18000
    {% endif %}
    G92 E0

    _DISABLE_SENSOR
        {% set retract_without_ifs_distance = 15 - filament_unload_after_cutting %}
        {% set retract_with_both_distance = 20 - retract_without_ifs_distance - filament_unload_after_cutting %}
        G1 E-{retract_without_ifs_distance} F{filament_unload_speed / 2}
        M400
        IFS_F24 PRUTOK={prutok}
        G1 E-{retract_with_both_distance} F{filament_unload_speed}
        IFS_F11 PRUTOK={prutok} LEN={nozzle_cleaning_length} SPEED={filament_unload_speed}
        M400
    _ENABLE_SENSOR

[gcode_macro IFS_UNLOCK]
gcode:
    IFS_F18

[gcode_macro _IFS_REMOVE_CURRENT_PRUTOK]
gcode:
    RESPOND TYPE=command MSG=action:prompt_end
    _G28
    IFS_REMOVE_CURRENT_PRUTOK NEED_TRASH=1 BYPASS_TEMPERATURE_CHECK=1
    SET_HEATER_TEMPERATURE HEATER=extruder TARGET=0
    COLOR
