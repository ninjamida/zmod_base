[include base_display_off.cfg]

[zmod_color]
display: False

[zmod_ifs]
debug: False

[zmod_ifs_motion_sensor ifs_motion_sensor]
pause_on_runout: True
runout_gcode:
    RESPOND TYPE=error MSG="===Filament runout or jam detected=== (IFS)"

[zmod_ifs_switch_sensor head_switch_sensor]
pause_on_runout: True
runout_gcode:
        RESPOND TYPE=error MSG="===Filament runout detected=== (Head)"

[gcode_macro CHANGE_FILAMENT]
gcode:
    {% set channel  = params.CHANNEL| int %}

    {% set temp = printer[printer.toolhead.extruder].target if printer.toolhead.extruder != '' else 0 %}
    {% set fan_speed = printer["fan_generic fanM106"].speed %}

    SET_GCODE_VARIABLE MACRO=END_CHANGE_FILAMENT VARIABLE=last_data VALUE="{{'temp': temp, 'fan_speed': fan_speed, 'channel': channel}}"

    _DISABLE_SENSOR
    RESPOND PREFIX="info" MSG="T{channel}"
    _CHANGE_FILAMENT CHANNEL={channel}
    END_CHANGE_FILAMENT

[gcode_macro END_CHANGE_FILAMENT]
variable_last_data: {'temp': 0, 'fan_speed': 0, 'channel': 99}
gcode:
    M109 S{last_data.temp}
    SET_FAN_SPEED FAN=fanM106 SPEED={last_data.fan_speed}

    SDCARD_SET_CHANNEL CHANNEL={last_data.channel}
    SDCARD_CLEAR_REFUELLING

    _ENABLE_SENSOR
